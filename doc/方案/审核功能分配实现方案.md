# 审核功能分配实现方案

## 一、需求分析

### 1.1 当前审核机制

**现状**：
- ✅ 已有 `expert` 角色，可以审核填报记录
- ✅ 审核功能在专家工作台和项目配置页面中实现
- ✅ 支持单个审核和批量审核
- ❌ **缺少审核任务分配机制**：所有专家可以看到所有待审核记录
- ❌ **缺少审核范围控制**：无法指定专家审核特定学校/区县/工具

### 1.2 业务需求

1. **审核人员管理**
   - 项目级别：为项目配置审核专家
   - 支持多个专家审核同一项目

2. **审核任务分配**
   - 自动分配：根据规则自动分配给专家
   - 手动分配：项目管理员手动分配审核任务
   - 按范围分配：按学校/区县/工具分配

3. **审核权限控制**
   - 专家只能看到分配给自己的审核任务
   - 支持审核范围限制（如：某专家只审核某区县的填报）

4. **审核流程**
   - 单级审核：一个专家审核即可
   - 多级审核（可选）：初审、复审、终审

---

## 二、设计方案

### 2.1 方案A：审核任务分配表（推荐）

创建审核任务表，明确分配审核任务给专家。

#### 2.1.1 数据模型

```sql
-- 审核任务分配表
CREATE TABLE IF NOT EXISTS review_assignments (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,              -- 关联 projects.id
  submission_id TEXT NOT NULL,           -- 关联 submissions.id
  reviewer_id TEXT NOT NULL,             -- 关联 project_personnel.id（专家）
  review_level INTEGER DEFAULT 1,        -- 审核级别：1=初审，2=复审，3=终审
  status TEXT DEFAULT 'pending',         -- 状态：pending | in_progress | completed | skipped
  assigned_at TEXT,                      -- 分配时间
  reviewed_at TEXT,                      -- 审核时间
  review_result TEXT,                    -- 审核结果：approved | rejected
  review_comment TEXT,                   -- 审核意见
  created_at TEXT,
  updated_at TEXT,
  UNIQUE(submission_id, reviewer_id, review_level)  -- 同一填报记录同一级别只能分配给一个专家
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_review_assignments_project 
  ON review_assignments(project_id);
CREATE INDEX IF NOT EXISTS idx_review_assignments_submission 
  ON review_assignments(submission_id);
CREATE INDEX IF NOT EXISTS idx_review_assignments_reviewer 
  ON review_assignments(reviewer_id);
CREATE INDEX IF NOT EXISTS idx_review_assignments_status 
  ON review_assignments(status);
```

#### 2.1.2 审核范围配置表（可选）

用于配置专家的审核范围：

```sql
-- 专家审核范围配置表
CREATE TABLE IF NOT EXISTS reviewer_scopes (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,              -- 关联 projects.id
  reviewer_id TEXT NOT NULL,             -- 关联 project_personnel.id（专家）
  scope_type TEXT,                       -- 范围类型：district | school | tool | all
  scope_id TEXT,                         -- 范围ID（区县ID或学校ID或工具ID）
  created_at TEXT,
  UNIQUE(project_id, reviewer_id, scope_type, scope_id)
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_reviewer_scopes_project 
  ON reviewer_scopes(project_id);
CREATE INDEX IF NOT EXISTS idx_reviewer_scopes_reviewer 
  ON reviewer_scopes(reviewer_id);
```

### 2.2 方案B：简化方案（基于现有设计）

不创建新表，通过 `submissions.reviewed_by` 字段和专家角色控制。

**优点**：实现简单，无需新增表
**缺点**：无法支持审核任务分配和范围控制

---

## 三、推荐方案：方案A（审核任务分配表）

### 3.1 核心设计

#### 3.1.1 审核流程

```
填报提交 (submitted)
    ↓
创建审核任务 (review_assignments)
    ↓
分配给专家
    ↓
专家审核
    ├─→ 通过 (approved) → 同步指标数据
    └─→ 驳回 (rejected) → 退回修改
```

#### 3.1.2 分配策略

**策略1：自动分配（按范围）**
- 根据 `reviewer_scopes` 配置，自动分配给对应范围的专家
- 如果多个专家匹配，随机分配或按负载均衡分配

**策略2：手动分配**
- 项目管理员手动选择专家分配审核任务

**策略3：轮询分配**
- 按专家负载轮询分配，确保工作量均衡

### 3.2 数据关系图

```
项目 (projects)
  ├── 项目人员 (project_personnel)
  │     └── 专家 (expert)
  │
  ├── 填报记录 (submissions)
  │     └── status: submitted
  │
  ├── 审核任务 (review_assignments)  ← 新增
  │     ├── submission_id → submissions.id
  │     ├── reviewer_id → project_personnel.id
  │     └── status: pending | in_progress | completed
  │
  └── 审核范围配置 (reviewer_scopes)  ← 新增（可选）
        ├── reviewer_id → project_personnel.id
        └── scope_type + scope_id
```

---

## 四、后端API设计

### 4.1 审核任务分配API

#### 4.1.1 获取待分配的审核任务

```javascript
GET /api/projects/:projectId/review-assignments/pending
```

**查询参数**：
- `toolId` (可选)：筛选特定工具
- `schoolId` (可选)：筛选特定学校
- `districtId` (可选)：筛选特定区县

**响应示例**：
```json
{
  "code": 200,
  "data": [
    {
      "submissionId": "sub-001",
      "submissionInfo": {
        "submitterName": "张三",
        "submitterOrg": "XX小学",
        "toolName": "学校基础数据采集表"
      },
      "status": "unassigned"  // unassigned | assigned
    }
  ]
}
```

#### 4.1.2 自动分配审核任务

```javascript
POST /api/projects/:projectId/review-assignments/auto-assign
```

**请求体**：
```json
{
  "submissionIds": ["sub-001", "sub-002"],  // 可选：指定填报记录，不指定则分配所有待审核的
  "strategy": "scope",                      // 分配策略：scope | round_robin | manual
  "reviewLevel": 1                          // 审核级别：1=初审
}
```

**分配逻辑**：
1. 查询所有待审核的填报记录
2. 根据 `reviewer_scopes` 配置匹配专家
3. 创建 `review_assignments` 记录
4. 返回分配结果

#### 4.1.3 手动分配审核任务

```javascript
POST /api/projects/:projectId/review-assignments/manual-assign
```

**请求体**：
```json
{
  "submissionIds": ["sub-001", "sub-002"],
  "reviewerId": "expert-001",
  "reviewLevel": 1
}
```

#### 4.1.4 获取专家的审核任务列表

```javascript
GET /api/my/review-assignments
```

**查询参数**：
- `projectId` (可选)
- `status` (可选)：pending | in_progress | completed

**响应示例**：
```json
{
  "code": 200,
  "data": [
    {
      "id": "ra-001",
      "projectId": "proj-001",
      "projectName": "2024年优质均衡评估",
      "submissionId": "sub-001",
      "submissionInfo": {
        "submitterName": "张三",
        "submitterOrg": "XX小学",
        "toolName": "学校基础数据采集表",
        "submittedAt": "2024-01-01T10:00:00Z"
      },
      "reviewLevel": 1,
      "status": "pending",
      "assignedAt": "2024-01-01T09:00:00Z"
    }
  ]
}
```

#### 4.1.5 专家审核（通过/驳回）

```javascript
POST /api/review-assignments/:id/review
```

**请求体**：
```json
{
  "result": "approved",        // approved | rejected
  "comment": "审核通过，数据准确"
}
```

**处理逻辑**：
1. 更新 `review_assignments` 状态为 `completed`
2. 如果 `result = approved`：
   - 更新 `submissions` 状态为 `approved`
   - 同步指标数据
3. 如果 `result = rejected`：
   - 更新 `submissions` 状态为 `rejected`
   - 更新关联任务状态

### 4.2 审核范围配置API

#### 4.2.1 获取专家的审核范围

```javascript
GET /api/projects/:projectId/reviewers/:reviewerId/scopes
```

#### 4.2.2 设置专家的审核范围

```javascript
POST /api/projects/:projectId/reviewers/:reviewerId/scopes
```

**请求体**：
```json
{
  "scopes": [
    {
      "scopeType": "district",
      "scopeId": "district-001"
    },
    {
      "scopeType": "school",
      "scopeId": "school-001"
    }
  ]
}
```

### 4.3 审核统计API

#### 4.3.1 获取审核统计

```javascript
GET /api/projects/:projectId/review-assignments/stats
```

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "total": 100,              // 总审核任务数
    "pending": 20,             // 待审核
    "inProgress": 10,          // 审核中
    "completed": 70,           // 已完成
    "approved": 65,            // 已通过
    "rejected": 5,             // 已驳回
    "byReviewer": [            // 按专家统计
      {
        "reviewerId": "expert-001",
        "reviewerName": "李专家",
        "total": 30,
        "completed": 25,
        "pending": 5
      }
    ]
  }
}
```

---

## 五、前端界面设计

### 5.1 审核任务分配界面（项目配置页面）

在项目配置页面新增"审核分配"Tab：

```
┌─────────────────────────────────────────┐
│  审核分配                                │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │ 审核专家配置                       │ │
│  │                                     │ │
│  │  专家列表：                         │ │
│  │  ┌─────────────────────────────┐   │ │
│  │  │ ☑ 李专家 (审核范围：全部)    │   │ │
│  │  │ ☑ 王专家 (审核范围：铁西区)  │   │ │
│  │  │ ☐ 张专家                      │   │ │
│  │  └─────────────────────────────┘   │ │
│  │                                     │ │
│  │  [添加专家] [配置范围]              │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │ 审核任务分配                       │ │
│  │                                     │ │
│  │  待分配任务：20 条                  │ │
│  │  已分配任务：80 条                  │ │
│  │                                     │ │
│  │  [自动分配] [手动分配] [查看统计]   │ │
│  │                                     │ │
│  │  ┌─────────────────────────────┐   │ │
│  │  │ 待分配列表                   │   │ │
│  │  │ ┌─────────────────────────┐ │   │ │
│  │  │ │ ☑ XX小学 - 基础数据表   │ │   │ │
│  │  │ │ ☑ YY小学 - 基础数据表   │ │   │ │
│  │  │ └─────────────────────────┘ │   │ │
│  │  │ [批量分配]                  │   │ │
│  │  └─────────────────────────────┘   │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 5.2 专家工作台（扩展现有界面）

在 `ExpertDashboard` 中扩展：

```
┌─────────────────────────────────────────┐
│  我的审核任务                            │
├─────────────────────────────────────────┤
│  筛选：[全部项目] [待审核] [已审核]      │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │ 待审核任务 (5)                    │ │
│  │ ┌─────────────────────────────┐ │ │
│  │ │ XX小学 - 基础数据表          │ │ │
│  │ │ 提交人：张三 | 提交时间：...  │ │ │
│  │ │ [查看详情] [通过] [驳回]     │ │ │
│  │ └─────────────────────────────┘ │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │ 审核统计                          │ │
│  │  总任务：50 | 已完成：45 | 待审核：5│ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 5.3 手动分配弹窗

```
┌─────────────────────────────────────────┐
│  手动分配审核任务                        │
├─────────────────────────────────────────┤
│  已选择：2 条填报记录                    │
│                                         │
│  选择专家：                              │
│  [下拉选择专家]                          │
│                                         │
│  审核级别：                              │
│  ○ 初审                                  │
│  ○ 复审                                  │
│                                         │
│  [取消] [确认分配]                       │
└─────────────────────────────────────────┘
```

---

## 六、业务逻辑设计

### 6.1 自动分配逻辑

#### 6.1.1 按范围分配

```javascript
// 伪代码
function autoAssignByScope(submissions, reviewers) {
  for (const submission of submissions) {
    // 查询填报记录的学校/区县
    const school = getSchool(submission.schoolId);
    const district = getDistrict(school.districtId);
    
    // 匹配审核范围
    const matchedReviewers = reviewers.filter(r => {
      const scopes = getReviewerScopes(r.id);
      return scopes.some(scope => {
        if (scope.scopeType === 'all') return true;
        if (scope.scopeType === 'district' && scope.scopeId === district.id) return true;
        if (scope.scopeType === 'school' && scope.scopeId === school.id) return true;
        return false;
      });
    });
    
    // 选择专家（负载均衡）
    const reviewer = selectReviewerByLoad(matchedReviewers);
    
    // 创建审核任务
    createReviewAssignment(submission.id, reviewer.id);
  }
}
```

#### 6.1.2 轮询分配

```javascript
// 伪代码
function autoAssignRoundRobin(submissions, reviewers) {
  let reviewerIndex = 0;
  
  for (const submission of submissions) {
    const reviewer = reviewers[reviewerIndex % reviewers.length];
    createReviewAssignment(submission.id, reviewer.id);
    reviewerIndex++;
  }
}
```

### 6.2 审核流程逻辑

#### 6.2.1 提交时自动创建审核任务

```javascript
// 在提交填报时
async function submitSubmission(submissionId) {
  // 1. 更新填报状态为 submitted
  await updateSubmissionStatus(submissionId, 'submitted');
  
  // 2. 检查审核配置
  const reviewConfig = await getReviewConfig(submission.projectId, submission.toolId);
  
  if (reviewConfig.requiresReview && !reviewConfig.autoApprove) {
    // 3. 自动创建审核任务
    await autoAssignReviewTask(submissionId);
  } else {
    // 4. 自动通过
    await autoApproveSubmission(submissionId);
  }
}
```

#### 6.2.2 专家审核

```javascript
async function reviewSubmission(assignmentId, result, comment) {
  // 1. 更新审核任务状态
  await updateReviewAssignment(assignmentId, {
    status: 'completed',
    reviewResult: result,
    reviewComment: comment,
    reviewedAt: now()
  });
  
  // 2. 更新填报状态
  await updateSubmissionStatus(assignment.submissionId, result);
  
  // 3. 如果通过，同步指标数据
  if (result === 'approved') {
    await syncSubmissionIndicators(assignment.submissionId);
  }
}
```

---

## 七、实施步骤

### 7.1 数据库层

1. **创建审核任务表**
   - 创建 `review_assignments` 表
   - 创建 `reviewer_scopes` 表（可选）
   - 创建索引

2. **扩展填报记录表**
   - 确保 `reviewed_by` 字段存在
   - 确保 `review_comment` 字段存在

### 7.2 后端层

1. **创建审核任务分配API**
   - 实现自动分配逻辑
   - 实现手动分配逻辑
   - 实现专家审核接口

2. **修改填报提交API**
   - 提交时自动创建审核任务
   - 根据审核配置决定是否自动通过

3. **创建审核范围配置API**
   - 配置专家的审核范围
   - 查询专家的审核范围

### 7.3 前端层

1. **扩展项目配置页面**
   - 新增"审核分配"Tab
   - 实现审核任务分配界面
   - 实现审核范围配置界面

2. **扩展专家工作台**
   - 显示分配给专家的审核任务
   - 实现审核操作界面

---

## 八、分配策略建议

### 8.1 推荐策略

**策略1：按范围自动分配（推荐）**
- 适合：专家有明确的审核范围（如：某区县、某学校）
- 优点：审核范围清晰，专家熟悉业务
- 实现：通过 `reviewer_scopes` 配置

**策略2：轮询分配**
- 适合：专家审核范围相同，需要负载均衡
- 优点：工作量均衡
- 实现：按专家负载轮询分配

**策略3：手动分配**
- 适合：需要灵活控制的场景
- 优点：完全可控
- 实现：项目管理员手动选择

### 8.2 混合策略

可以组合使用：
1. **默认**：按范围自动分配
2. **特殊场景**：手动分配
3. **负载均衡**：同一范围内轮询分配

---

## 九、注意事项

### 9.1 权限控制

- **审核任务分配**：只有项目管理员可以分配
- **审核操作**：只有被分配的专家可以审核
- **查看权限**：专家只能看到分配给自己的任务

### 9.2 数据一致性

- **删除专家时**：需要重新分配其未完成的审核任务
- **删除填报记录时**：需要删除关联的审核任务
- **审核配置变更时**：只影响新提交的填报

### 9.3 性能优化

- **批量分配**：使用事务确保数据一致性
- **查询优化**：使用索引加速查询
- **负载均衡**：考虑专家当前工作量

---

## 十、总结

### 10.1 核心功能

1. ✅ **审核任务分配表**：明确分配审核任务给专家
2. ✅ **审核范围配置**：支持按学校/区县/工具配置审核范围
3. ✅ **自动分配机制**：支持按范围、轮询等策略自动分配
4. ✅ **手动分配机制**：支持项目管理员手动分配
5. ✅ **专家工作台**：专家查看和处理分配给自己的审核任务

### 10.2 实施优先级

1. **高优先级**：创建审核任务分配表，实现基本分配功能
2. **中优先级**：实现自动分配逻辑，支持按范围分配
3. **中优先级**：实现审核范围配置功能
4. **低优先级**：实现负载均衡、多级审核等高级功能

该方案提供了完整的审核功能分配机制，可以灵活支持各种审核场景。

