# 填报账号设计变更分析

## 一、现有设计分析

### 1.1 当前 `project_personnel` 表结构

```sql
CREATE TABLE IF NOT EXISTS project_personnel (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  name TEXT NOT NULL,
  organization TEXT,              -- ⚠️ 问题：文本字段，只存储组织名称
  phone TEXT,
  id_card TEXT,
  role TEXT NOT NULL,            -- system_admin | city_admin | district_admin | district_reporter | school_reporter
  status TEXT DEFAULT 'active',
  created_at TEXT,
  updated_at TEXT
);
```

### 1.2 现有设计的问题

#### 问题1：缺少明确的关联关系

**现状**：
- `organization` 字段是文本字段，只存储组织名称（如"XX小学"、"铁西区"）
- 没有外键关联到 `schools` 或 `districts` 表
- 无法精确匹配和验证权限

**影响**：
- ❌ 无法精确判断填报账号属于哪个学校或区县
- ❌ 权限验证只能通过文本匹配，容易出错
- ❌ 区县管理员无法明确关联到 `district_id`
- ❌ 学校填报员无法明确关联到 `school_id`

#### 问题2：区县管理员权限实现困难

**需求**：区县管理员可以填报辖区内全部学校

**现状问题**：
- 无法通过 `organization` 文本字段精确查询区县下的所有学校
- 需要额外的逻辑来匹配 `organization` 和 `districts.name`
- 如果区县名称变更，会导致关联失效

#### 问题3：任务分配时关联不明确

**需求**：任务分配需要明确指定目标学校或区县

**现状问题**：
- `tasks` 表的 `target_id` 可以存储学校ID或区县ID
- 但 `project_personnel` 无法明确知道该人员属于哪个学校/区县
- 分配任务时需要通过 `organization` 文本匹配，不够精确

---

## 二、设计变更方案

### 2.1 方案A：添加关联字段（推荐）

在现有表基础上，添加明确的关联字段，保留 `organization` 字段用于显示。

#### 2.1.1 表结构变更

```sql
-- 扩展 project_personnel 表
ALTER TABLE project_personnel 
  ADD COLUMN IF NOT EXISTS district_id TEXT,    -- 关联 districts.id（区县管理员/区县填报员）
  ADD COLUMN IF NOT EXISTS school_id TEXT;       -- 关联 schools.id（学校填报员）

-- 添加索引
CREATE INDEX IF NOT EXISTS idx_project_personnel_district 
  ON project_personnel(district_id);
CREATE INDEX IF NOT EXISTS idx_project_personnel_school 
  ON project_personnel(school_id);
```

#### 2.1.2 字段使用规则

| 角色 | district_id | school_id | organization | 说明 |
|------|-------------|-----------|--------------|------|
| `system_admin` | NULL | NULL | "系统" | 系统管理员 |
| `city_admin` | NULL | NULL | "XX市" | 市级管理员 |
| `district_admin` | ✅ 必填 | NULL | "XX区" | 区县管理员，关联区县 |
| `district_reporter` | ✅ 必填 | NULL | "XX区" | 区县填报员，关联区县 |
| `school_reporter` | NULL | ✅ 必填 | "XX小学" | 学校填报员，关联学校 |

#### 2.1.3 数据迁移

```sql
-- 数据迁移脚本：根据 organization 文本匹配，填充 district_id 或 school_id
-- 注意：需要手动执行，确保数据准确性

-- 1. 为区县管理员和区县填报员填充 district_id
UPDATE project_personnel pp
SET district_id = (
  SELECT d.id 
  FROM districts d 
  WHERE d.name = pp.organization 
  LIMIT 1
)
WHERE pp.role IN ('district_admin', 'district_reporter')
  AND pp.district_id IS NULL
  AND pp.organization IS NOT NULL;

-- 2. 为学校填报员填充 school_id
UPDATE project_personnel pp
SET school_id = (
  SELECT s.id 
  FROM schools s 
  WHERE s.name = pp.organization 
  LIMIT 1
)
WHERE pp.role = 'school_reporter'
  AND pp.school_id IS NULL
  AND pp.organization IS NOT NULL;
```

#### 2.1.4 优点

✅ **向后兼容**：保留 `organization` 字段，不影响现有代码
✅ **精确关联**：通过外键关联，数据准确可靠
✅ **查询高效**：可以使用索引快速查询
✅ **权限验证简单**：直接通过 `district_id` 或 `school_id` 验证权限
✅ **支持区县管理员**：可以精确查询区县下所有学校

#### 2.1.5 缺点

⚠️ **需要数据迁移**：现有数据需要填充关联字段
⚠️ **需要验证逻辑**：添加/更新时需要验证关联关系

### 2.2 方案B：创建关联表（更灵活，但更复杂）

创建独立的关联表，支持一个人员关联多个学校/区县。

#### 2.2.1 表结构

```sql
-- 人员-区县关联表
CREATE TABLE IF NOT EXISTS personnel_districts (
  id TEXT PRIMARY KEY,
  personnel_id TEXT NOT NULL,
  district_id TEXT NOT NULL,
  created_at TEXT,
  UNIQUE(personnel_id, district_id)
);

-- 人员-学校关联表
CREATE TABLE IF NOT EXISTS personnel_schools (
  id TEXT PRIMARY KEY,
  personnel_id TEXT NOT NULL,
  school_id TEXT NOT NULL,
  created_at TEXT,
  UNIQUE(personnel_id, school_id)
);
```

#### 2.2.2 优点

✅ **支持多关联**：一个人员可以关联多个学校/区县
✅ **更灵活**：适合复杂的权限场景

#### 2.2.3 缺点

❌ **复杂度高**：需要额外的关联表
❌ **查询复杂**：需要 JOIN 查询
❌ **当前需求不需要**：当前需求不需要多关联

### 2.3 方案C：保持现状，通过 organization 匹配（不推荐）

保持现有设计，通过 `organization` 文本字段匹配。

#### 2.3.1 实现方式

```javascript
// 查询区县管理员可填报的学校
const districtName = personnel.organization; // "铁西区"
const district = await db.query(
  'SELECT id FROM districts WHERE name = $1', 
  [districtName]
);
const schools = await db.query(
  'SELECT * FROM schools WHERE district_id = $1',
  [district.id]
);
```

#### 2.3.2 缺点

❌ **文本匹配不可靠**：名称可能不一致、有空格、有别名
❌ **性能差**：需要多次查询和文本匹配
❌ **维护困难**：名称变更会导致关联失效
❌ **数据不一致风险**：无法保证数据完整性

---

## 三、推荐方案：方案A（添加关联字段）

### 3.1 变更内容

1. **数据库变更**：
   - 添加 `district_id` 字段（区县管理员/区县填报员）
   - 添加 `school_id` 字段（学校填报员）
   - 添加索引

2. **后端API变更**：
   - 添加/更新人员时，验证并设置 `district_id` 或 `school_id`
   - 查询时自动填充关联信息

3. **前端界面变更**：
   - 添加人员时，根据角色选择区县或学校
   - 显示时同时显示名称和关联信息

### 3.2 实现步骤

#### 步骤1：数据库迁移

```sql
-- 1. 添加字段
ALTER TABLE project_personnel 
  ADD COLUMN IF NOT EXISTS district_id TEXT,
  ADD COLUMN IF NOT EXISTS school_id TEXT;

-- 2. 添加索引
CREATE INDEX IF NOT EXISTS idx_project_personnel_district 
  ON project_personnel(district_id);
CREATE INDEX IF NOT EXISTS idx_project_personnel_school 
  ON project_personnel(school_id);

-- 3. 数据迁移（需要手动执行，确保准确性）
-- 见上面的数据迁移脚本
```

#### 步骤2：后端API修改

```javascript
// 添加人员时，根据角色设置关联字段
router.post('/projects/:projectId/personnel', async (req, res) => {
  const { name, organization, phone, idCard, role, districtId, schoolId } = req.body;
  
  // 根据角色验证关联字段
  if (role === 'district_admin' || role === 'district_reporter') {
    if (!districtId) {
      return res.status(400).json({ 
        code: 400, 
        message: '区县管理员/区县填报员必须关联区县' 
      });
    }
  }
  
  if (role === 'school_reporter') {
    if (!schoolId) {
      return res.status(400).json({ 
        code: 400, 
        message: '学校填报员必须关联学校' 
      });
    }
  }
  
  // 插入数据时包含关联字段
  const { data, error } = await db
    .from('project_personnel')
    .insert({
      id,
      project_id: projectId,
      name,
      organization: organization || '',
      phone: phone || '',
      id_card: idCard || '',
      role,
      district_id: districtId || null,
      school_id: schoolId || null,
      status: 'active',
      created_at: timestamp,
      updated_at: timestamp,
    });
});
```

#### 步骤3：查询时关联信息

```javascript
// 获取人员列表时，关联区县/学校信息
router.get('/projects/:projectId/personnel', async (req, res) => {
  const sql = `
    SELECT 
      pp.id,
      pp.project_id as "projectId",
      pp.name,
      pp.organization,
      pp.phone,
      pp.id_card as "idCard",
      pp.role,
      pp.status,
      pp.district_id as "districtId",
      pp.school_id as "schoolId",
      d.name as "districtName",
      s.name as "schoolName",
      pp.created_at as "createdAt",
      pp.updated_at as "updatedAt"
    FROM project_personnel pp
    LEFT JOIN districts d ON pp.district_id = d.id
    LEFT JOIN schools s ON pp.school_id = s.id
    WHERE pp.project_id = $1
    ORDER BY pp.role, pp.created_at DESC
  `;
  // ...
});
```

#### 步骤4：区县管理员权限查询

```javascript
// 获取区县管理员可填报的学校
router.get('/projects/:projectId/district-admin/schools', async (req, res) => {
  const { districtId } = req.query;
  
  // 直接通过 district_id 查询
  const schools = await db.query(`
    SELECT 
      s.id,
      s.name,
      s.code,
      s.school_type as "schoolType"
    FROM schools s
    WHERE s.district_id = $1
    ORDER BY s.name
  `, [districtId]);
  
  res.json({ code: 200, data: schools.rows });
});
```

---

## 四、变更影响分析

### 4.1 对现有功能的影响

#### 影响1：添加人员功能

**变更前**：
- 只需要填写 `organization` 文本字段

**变更后**：
- 需要根据角色选择区县或学校
- 自动填充 `organization` 字段（从区县/学校名称获取）

**影响程度**：🟡 中等
- 需要修改前端界面
- 需要修改后端验证逻辑

#### 影响2：查询人员功能

**变更前**：
- 只返回 `organization` 文本

**变更后**：
- 返回 `districtId`、`schoolId` 和关联的名称
- 可以精确查询

**影响程度**：🟢 低
- 向后兼容，可以同时返回 `organization`
- 现有代码可以继续使用 `organization`

#### 影响3：权限验证

**变更前**：
- 通过 `organization` 文本匹配

**变更后**：
- 通过 `district_id` 或 `school_id` 精确匹配

**影响程度**：🟢 低
- 权限验证更准确
- 需要修改验证逻辑

### 4.2 数据迁移风险

⚠️ **风险1：现有数据可能无法匹配**
- 如果 `organization` 名称与 `districts`/`schools` 表不一致，无法自动填充
- **解决方案**：提供数据迁移工具，手动匹配

⚠️ **风险2：数据不一致**
- 迁移后可能出现 `organization` 与关联字段不一致
- **解决方案**：添加验证逻辑，确保一致性

---

## 五、实施建议

### 5.1 推荐实施

✅ **强烈推荐采用方案A（添加关联字段）**

**理由**：
1. 满足新需求：支持区县管理员填报辖区内所有学校
2. 向后兼容：保留 `organization` 字段
3. 数据精确：通过外键关联，数据可靠
4. 实现简单：只需添加字段和索引
5. 性能优化：可以使用索引快速查询

### 5.2 实施优先级

1. **高优先级**：添加 `district_id` 和 `school_id` 字段
2. **中优先级**：修改添加/更新人员API，验证关联字段
3. **中优先级**：数据迁移脚本，填充现有数据
4. **低优先级**：前端界面优化，支持选择区县/学校

### 5.3 兼容性策略

1. **保留 `organization` 字段**：用于显示和向后兼容
2. **自动填充 `organization`**：从关联的区县/学校名称自动填充
3. **查询时同时返回**：返回 `organization` 和关联字段，确保兼容

---

## 六、总结

### 6.1 是否需要变更？

**答案：✅ 需要变更**

**原因**：
1. 现有设计无法精确支持区县管理员填报辖区内所有学校的需求
2. 文本匹配方式不可靠，容易出错
3. 缺少明确的关联关系，权限验证困难

### 6.2 推荐变更方案

**方案A：添加关联字段**
- 添加 `district_id` 和 `school_id` 字段
- 保留 `organization` 字段用于显示
- 向后兼容，实现简单

### 6.3 变更影响

- **影响程度**：中等
- **风险**：低（向后兼容）
- **收益**：高（精确关联、支持新需求）

---

## 七、后续优化建议

### 7.1 数据一致性

添加触发器或应用层验证，确保 `organization` 与关联字段一致：

```sql
-- 示例：更新时自动同步 organization
CREATE OR REPLACE FUNCTION sync_personnel_organization()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.district_id IS NOT NULL THEN
    SELECT name INTO NEW.organization FROM districts WHERE id = NEW.district_id;
  ELSIF NEW.school_id IS NOT NULL THEN
    SELECT name INTO NEW.organization FROM schools WHERE id = NEW.school_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_sync_personnel_organization
BEFORE INSERT OR UPDATE ON project_personnel
FOR EACH ROW
EXECUTE FUNCTION sync_personnel_organization();
```

### 7.2 查询优化

为常用查询添加复合索引：

```sql
CREATE INDEX IF NOT EXISTS idx_personnel_role_district 
  ON project_personnel(role, district_id) 
  WHERE district_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_personnel_role_school 
  ON project_personnel(role, school_id) 
  WHERE school_id IS NOT NULL;
```

