# 第三方问卷系统集成实现方案

## 一、需求概述

### 1.1 核心需求

1. **问卷工具跳转**：在本系统创建问卷类型的采集工具后，可以跳转到第三方问卷系统（https://survey-test.f123.pub/）进行问卷的创建、编辑、发布等操作
2. **问卷数据统计**：从第三方系统收集到的问卷数据

### 1.2 业务场景

**架构模式**：一份问卷 + 多项目复用 + 多校填报

#### 阶段一：工具创建（管理员，无项目关联）

1. 管理员在工具库中创建"问卷"类型的采集工具
2. 管理员点击"跳转到问卷系统"按钮，在新窗口打开第三方问卷系统
3. 管理员在第三方系统中完成问卷的创建、编辑、发布（**创建1份全局问卷模板**）
4. **第三方系统通过回调接口返回问卷ID（externalSurveyId）和问卷入口地址（externalSurveyUrl）**
5. 本系统保存问卷ID和入口地址到工具信息（data_tools表）

#### 阶段二：项目中使用工具（管理员选择工具）

6. 管理员在某个项目中选择使用该问卷工具
7. 此时工具与项目建立关联关系

#### 阶段三：问卷分发（管理员，有项目关联）

8. 管理员在项目中为每个学校批量生成带项目和学校标识的访问链接
9. 系统基于第三方返回的问卷入口地址，生成包含项目和学校信息的URL：`{externalSurveyUrl}?projectId=xxx&schoolId=xxx&...&token=JWT_TOKEN`
10. 管理员将链接分发给各学校（支持直接URL、二维码、短链等方式）

#### 阶段四：问卷填报（学校用户）

11. 学校用户（家长/教师/学生）通过专属链接访问问卷
12. 第三方系统识别URL中的项目和学校信息，并在问卷中预填充
13. 用户填写问卷并提交

#### 阶段五：数据同步（自动）

14. 第三方系统通过回调接口将问卷数据推送到本系统
15. 本系统根据 `projectId` 和 `schoolId` 将数据归属到对应项目的对应学校
16. 本系统按项目和学校汇总统计数据，并同步到指标系统

**核心特点**：

- 工具创建时无需指定项目（一个工具可被多个项目复用）
- 项目使用工具时建立关联关系
- 为学校生成链接时必须包含项目信息（projectId）

## 二、数据库设计

### 2.1 扩展 data_tools 表

在 `data_tools` 表中添加第三方问卷系统相关字段：

```sql
ALTER TABLE data_tools
ADD COLUMN IF NOT EXISTS external_survey_id TEXT,           -- 第三方问卷系统的问卷ID
ADD COLUMN IF NOT EXISTS external_survey_url TEXT,          -- 第三方问卷系统的问卷链接
ADD COLUMN IF NOT EXISTS satisfaction_config JSONB;         -- 满意度判定配置
```

**字段说明**：

- `external_survey_id`: 第三方系统返回的问卷ID，用于后续编辑、查看等操作
- `external_survey_url`: 第三方系统的问卷完整URL，用于直接访问
- `satisfaction_config`: 满意度判定配置（JSON格式）

**satisfaction_config 配置示例**：

```json
{
  "scale": 5,                    // 评分量表：5分制/10分制
  "minScore": 4.0,              // 满意的最低分数
  "calculationMethod": "average" // 计算方法：average（平均分）/threshold（阈值）
}
```

**默认配置**：

- 如果未配置，默认使用 `{ "scale": 5, "minScore": 4.0, "calculationMethod": "threshold" }`
- 即：5分制中，≥4.0分视为满意

### 2.2 创建问卷响应详细记录表（核心表）

```sql
-- 问卷响应详细记录表：存储每份问卷的详细数据
CREATE TABLE IF NOT EXISTS survey_responses (
  id TEXT PRIMARY KEY,
  tool_id TEXT NOT NULL,                    -- 关联 data_tools.id
  project_id TEXT NOT NULL,                 -- 关联 projects.id
  school_id TEXT NOT NULL,                  -- 关联 schools.id
  district_id TEXT,                         -- 关联 districts.id（冗余，便于查询）

  external_response_id TEXT,                -- 第三方系统的响应ID
  external_survey_id TEXT,                  -- 第三方问卷实例ID
  respondent_type TEXT,                     -- 填报人身份：parent/teacher/student/principal/other
  total_score REAL,                         -- 总分数（如4.5、3.8等）
  is_valid BOOLEAN DEFAULT true,            -- 是否有效问卷

  submitted_at TEXT,                        -- 问卷提交时间
  created_at TEXT,
  updated_at TEXT,

  -- 可选：存储完整的问卷数据（JSON）
  raw_data JSONB
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_survey_responses_tool ON survey_responses(tool_id);
CREATE INDEX IF NOT EXISTS idx_survey_responses_project_school ON survey_responses(project_id, school_id);
CREATE INDEX IF NOT EXISTS idx_survey_responses_type ON survey_responses(respondent_type);
CREATE INDEX IF NOT EXISTS idx_survey_responses_external_survey ON survey_responses(external_survey_id);
CREATE INDEX IF NOT EXISTS idx_survey_responses_score ON survey_responses(total_score);

-- 唯一约束：防止重复导入同一份问卷
CREATE UNIQUE INDEX IF NOT EXISTS idx_survey_responses_external_unique
ON survey_responses(external_response_id)
WHERE external_response_id IS NOT NULL;
```

**表设计说明**：

- **核心数据表**：存储每份问卷的详细信息，包括满意度分数
- **满意度判定**：由本系统根据工具配置的阈值动态计算
- **可追溯性**：保留每份问卷的原始数据，支持审计和复核
- **灵活性**：支持不同项目设置不同的满意度标准

### 2.3 创建问卷统计汇总表（视图/缓存表）

```sql
-- 问卷统计汇总表：基于 survey_responses 计算的统计数据
CREATE TABLE IF NOT EXISTS survey_statistics (
  id TEXT PRIMARY KEY,
  tool_id TEXT NOT NULL,                    -- 关联 data_tools.id
  project_id TEXT,                           -- 关联 projects.id
  school_id TEXT,                            -- 关联 schools.id
  district_id TEXT,                          -- 关联 districts.id

  -- 问卷统计数据（由本系统计算）
  total_sent INTEGER DEFAULT 0,             -- 问卷总数/发放总数
  total_sent_to_parents INTEGER DEFAULT 0, -- 发给家长的数量
  total_valid INTEGER DEFAULT 0,             -- 回收有效问卷数
  total_valid_from_parents INTEGER DEFAULT 0, -- 家长有效问卷数
  total_satisfied INTEGER DEFAULT 0,         -- 满意问卷数（根据阈值计算）
  total_satisfied_from_parents INTEGER DEFAULT 0, -- 家长满意问卷数

  -- 元数据
  source TEXT DEFAULT 'external',           -- 数据来源：external（第三方系统）| manual（手动录入）
  external_survey_id TEXT,                  -- 第三方问卷系统的问卷ID
  collected_at TEXT,                        -- 数据采集时间
  created_at TEXT,
  updated_at TEXT
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_survey_statistics_tool_id ON survey_statistics(tool_id);
CREATE INDEX IF NOT EXISTS idx_survey_statistics_project_id ON survey_statistics(project_id);
CREATE INDEX IF NOT EXISTS idx_survey_statistics_school_id ON survey_statistics(school_id);
CREATE INDEX IF NOT EXISTS idx_survey_statistics_external_survey_id ON survey_statistics(external_survey_id);

-- 创建唯一约束（确保一个项目+学校+工具只有一条统计记录）
CREATE UNIQUE INDEX IF NOT EXISTS idx_survey_statistics_unique
ON survey_statistics(tool_id, project_id, school_id)
WHERE project_id IS NOT NULL AND school_id IS NOT NULL;
```

**表设计说明**：

- **汇总数据表**：用于快速查询统计数据，避免每次都聚合计算
- **由本系统计算**：满意问卷数由本系统根据 `survey_responses` 和工具配置的阈值计算
- **性能优化**：作为缓存层，提高查询效率

### 2.4 创建问卷访问链接记录表

用于记录为每个学校生成的问卷访问链接（一份问卷，多校填报）：

```sql
CREATE TABLE IF NOT EXISTS survey_access_links (
  id TEXT PRIMARY KEY,
  tool_id TEXT NOT NULL,              -- 关联 data_tools.id
  project_id TEXT NOT NULL,           -- 关联 projects.id
  school_id TEXT NOT NULL,            -- 关联 schools.id
  district_id TEXT,                   -- 关联 districts.id（冗余，便于查询）

  access_url TEXT,                    -- 生成的带学校标识的访问链接
  access_token TEXT,                  -- 访问令牌（JWT）
  qr_code_url TEXT,                   -- 二维码URL（可选）

  target_audience TEXT,               -- 目标受众：parent/teacher/student/principal
  link_type TEXT DEFAULT 'url',       -- 链接类型：url/qrcode/shortlink

  is_active BOOLEAN DEFAULT true,     -- 链接是否有效
  expires_at TEXT,                    -- 链接过期时间（可选）

  created_at TEXT,
  updated_at TEXT,
  accessed_count INTEGER DEFAULT 0    -- 访问次数统计
);

CREATE INDEX IF NOT EXISTS idx_survey_access_links_tool ON survey_access_links(tool_id);
CREATE INDEX IF NOT EXISTS idx_survey_access_links_project ON survey_access_links(project_id);
CREATE INDEX IF NOT EXISTS idx_survey_access_links_school ON survey_access_links(school_id);
CREATE INDEX IF NOT EXISTS idx_survey_access_links_token ON survey_access_links(access_token);

-- 唯一约束：同一工具、同一项目、同一学校、同一受众只有一条访问链接记录
CREATE UNIQUE INDEX IF NOT EXISTS idx_survey_access_links_unique
ON survey_access_links(tool_id, project_id, school_id, target_audience);
```

**表设计说明**：

- **架构模式**：一份问卷 + 多校填报（管理员创建1份问卷，所有学校填写同一份问卷）
- **核心功能**：记录为每个学校生成的带学校标识的访问链接
- **学校识别**：通过URL参数（schoolId）区分问卷回答来自哪个学校
- **链接管理**：支持链接过期、失效、访问统计等功能
- **多种分发方式**：支持直接URL、二维码、短链等多种分发方式

## 三、问卷工具的标准Schema（核心设计）

### 3.1 问题：问卷如何与要素系统集成？

由于问卷的具体内容在第三方系统中创建，本系统无法获取问卷的详细字段结构。但为了让问卷统计数据能够与要素系统对接（通过 `field_mappings` 表），我们需要为问卷类型的工具定义**标准虚拟Schema**。

### 3.2 解决方案：自动生成标准Schema

当创建类型为"问卷"的工具时，系统自动为其生成包含以下**6个标准统计字段**的schema：

```json
{
  "fields": [
    {
      "id": "respondent_type",
      "label": "填报人身份",
      "type": "radio",
      "required": true,
      "readonly": false,
      "options": [
        { "value": "parent", "label": "家长" },
        { "value": "teacher", "label": "教师" },
        { "value": "student", "label": "学生" },
        { "value": "principal", "label": "校长" },
        { "value": "other", "label": "其他" }
      ],
      "description": "用于识别填报人身份，由第三方问卷系统在问卷中设置"
    },
    {
      "id": "school_id",
      "label": "学校ID",
      "type": "hidden",
      "readonly": true,
      "description": "从URL参数自动获取，用于识别问卷所属学校"
    },
    {
      "id": "school_name",
      "label": "所属学校",
      "type": "text",
      "readonly": true,
      "description": "学校名称，在问卷中只读显示"
    },
    {
      "id": "total_sent",
      "label": "问卷总数/发放总数",
      "type": "number",
      "readonly": true,
      "category": "statistics",
      "description": "问卷发放的总数量（由第三方系统统计后回调填充）"
    },
    {
      "id": "total_sent_to_parents",
      "label": "发给家长的数量",
      "type": "number",
      "readonly": true,
      "category": "statistics",
      "description": "专门发给家长的问卷数量"
    },
    {
      "id": "total_valid",
      "label": "回收有效问卷数",
      "type": "number",
      "readonly": true,
      "category": "statistics",
      "description": "回收的有效问卷总数"
    },
    {
      "id": "total_valid_from_parents",
      "label": "家长有效问卷数",
      "type": "number",
      "readonly": true,
      "category": "statistics",
      "description": "来自家长的有效问卷数量"
    },
    {
      "id": "total_satisfied",
      "label": "满意问卷数",
      "type": "number",
      "readonly": true,
      "category": "statistics",
      "description": "满意度达标的问卷数量"
    },
    {
      "id": "total_satisfied_from_parents",
      "label": "家长满意问卷数",
      "type": "number",
      "readonly": true,
      "category": "statistics",
      "description": "来自家长的满意问卷数量"
    }
  ]
}
```

### 3.3 Schema字段分类

| 字段类别             | 字段ID                           | 用途       | 数据来源                   |
| -------------------- | -------------------------------- | ---------- | -------------------------- |
| **元数据字段** | `respondent_type`              | 身份识别   | 第三方问卷系统（问卷题目） |
|                      | `school_id`                    | 学校识别   | URL参数（隐藏字段）        |
|                      | `school_name`                  | 学校名称   | URL参数（只读显示）        |
| **统计字段**   | `total_sent`                   | 发放总数   | 回调接口                   |
|                      | `total_sent_to_parents`        | 家长发放数 | 回调接口                   |
|                      | `total_valid`                  | 有效回收数 | 回调接口                   |
|                      | `total_valid_from_parents`     | 家长有效数 | 回调接口                   |
|                      | `total_satisfied`              | 满意数     | 计算                       |
|                      | `total_satisfied_from_parents` | 家长满意数 | 计算                       |

### 3.4 与要素系统的集成

有了标准Schema后，就可以通过 `field_mappings` 表建立字段映射：

```sql
-- 示例：将问卷统计字段映射到要素
INSERT INTO field_mappings (tool_id, field_id, mapping_type, target_id) VALUES
  ('survey-tool-001', 'total_sent', 'element', 'S6_01'),           -- 问卷总数
  ('survey-tool-001', 'total_valid', 'element', 'S6_02'),          -- 回收有效问卷数
  ('survey-tool-001', 'total_satisfied', 'element', 'S6_03');      -- 满意问卷数

-- 创建派生要素（公式计算）
INSERT INTO elements (id, library_id, code, name, element_type, formula) VALUES
  ('S6_D01', 'lib-001', 'S6_D01', '问卷调查综合满意度', '派生要素', 'S6_03 / S6_02 * 100');
```

### 3.5 数据流转链路

```
第三方问卷系统回调
  ↓ (推送统计数据)
survey_statistics 表
  ↓ (构建虚拟submission data)
{
  total_sent: 1000,
  total_valid: 850,
  total_satisfied: 800
}
  ↓ (读取field_mappings)
提取基础要素值
  S6_01 = 1000
  S6_02 = 850
  S6_03 = 800
  ↓ (执行公式计算)
计算派生要素
  S6_D01 = 800 / 850 * 100 = 94.12
  ↓ (写入)
school_indicator_data 表
  (project_id, school_id, data_indicator_id, value)
```

## 四、身份与学校识别方案

### 4.1 家长身份识别

#### 4.1.1 URL携带受众标识

为不同受众生成不同的问卷链接：

```
家长问卷链接：
https://survey-test.f123.pub/?targetAudience=parent&schoolId=school-001&token=xxx

教师问卷链接：
https://survey-test.f123.pub/?targetAudience=teacher&schoolId=school-001&token=xxx
```

#### 4.1.2 数据返回方式

**第三方系统职责**：

- ✅ 收集问卷响应数据
- ✅ 为每份问卷计算总分数（`totalScore`）
- ✅ 判定问卷有效性（`isValid`）
- ✅ 记录填报人身份（`respondentType`）
- ✅ 通过回调接口返回详细的问卷数据数组

**数据返回示例**：

```javascript
// 第三方系统回调数据格式
{
  "toolId": "survey-001",
  "projectId": "proj-001",
  "schoolId": "school-001",
  "externalSurveyId": "survey-global-001",

  // 详细问卷数据数组（核心）
  "responses": [
    {
      "responseId": "resp-001",
      "respondentType": "parent",      // 第三方记录身份
      "totalScore": 4.5,               // 第三方计算总分
      "isValid": true,                 // 第三方判定有效性
      "submittedAt": "2025-01-15T10:00:00Z"
    },
    {
      "responseId": "resp-002",
      "respondentType": "teacher",
      "totalScore": 3.8,
      "isValid": true,
      "submittedAt": "2025-01-15T10:05:00Z"
    },
    // ... 更多问卷数据
  ],

  // 可选：简单的计数统计（仅供参考，本系统会重新计算）
  "summary": {
    "totalResponses": 850
  }
}
```

**本系统计算逻辑**：

```javascript
// 本系统接收到数据后的处理
const statistics = {
  // 基于 responses 数组计算
  total_valid: responses.filter(r => r.isValid).length,  // 850

  // 按身份分类统计（本系统负责）
  total_valid_from_parents: responses.filter(r =>
    r.isValid && r.respondentType === 'parent'
  ).length,  // 420

  // 根据配置的阈值判定满意度（本系统负责）
  total_satisfied: responses.filter(r =>
    r.isValid && r.totalScore >= satisfactionConfig.minScore
  ).length,  // 680（阈值4.0）

  // 家长满意问卷数（本系统负责）
  total_satisfied_from_parents: responses.filter(r =>
    r.isValid && r.totalScore >= satisfactionConfig.minScore && r.respondentType === 'parent'
  ).length  // 320
};
```

### 4.2 学校/区县识别（一份问卷 + URL参数识别）

**方案**：通过URL参数携带学校标识，所有学校填写同一份问卷

#### 4.2.1 架构结构

**阶段一：工具创建（无项目关联）**

```
工具库
└─ 工具: 家长满意度调查问卷 (管理员创建1份采集工具)
   └─ 第三方问卷ID: survey-global-001 (全局问卷模板)
```

**阶段二：项目中使用（有项目关联）**

```
项目: 2025年义务教育优质均衡评估 (proj-001)
└─ 使用工具: 家长满意度调查问卷 (survey-001)
   │
   ├─ 学校A的访问链接
   │  ├─ 家长链接: ?projectId=proj-001&schoolId=school-001&targetAudience=parent&token=xxx
   │  ├─ 教师链接: ?projectId=proj-001&schoolId=school-001&targetAudience=teacher&token=yyy
   │  └─ 学生链接: ?projectId=proj-001&schoolId=school-001&targetAudience=student&token=zzz
   │
   └─ 学校B的访问链接
      ├─ 家长链接: ?projectId=proj-001&schoolId=school-002&targetAudience=parent&token=aaa
      └─ 教师链接: ?projectId=proj-001&schoolId=school-002&targetAudience=teacher&token=bbb
```

**核心要点**：

- **工具与项目分离**：管理员先创建工具（无projectId），后在项目中使用工具（有projectId）
- **一份问卷多项目复用**：同一个工具（问卷）可以在多个项目中使用
- **全局唯一问卷**：管理员在第三方系统创建1份问卷模板（survey-global-001）
- **学校识别**：通过URL参数中的 `projectId` + `schoolId` 识别数据归属
- **数据归属**：回调时根据 `projectId` 和 `schoolId` 将问卷数据归属到对应项目的对应学校
- **链接管理**：本系统为每个项目的每个学校生成专属访问链接，记录在 `survey_access_links` 表

#### 4.2.2 管理员创建问卷时的URL

管理员创建采集工具后访问第三方系统创建问卷内容：

```
https://survey-test.f123.pub/
  ?action=create
  &toolId=survey-001
  &toolName=家长满意度调查
  &callback=https://yourdomain.com/api/survey/callback
  &token=ADMIN_JWT_TOKEN
```

#### 4.2.3 为学校生成访问链接时的URL

当工具在项目中使用时，为每个学校生成专属访问链接：

```
https://survey-test.f123.pub/survey/survey-global-001
  ?projectId=proj-001
  &schoolId=school-001
  &schoolName=XX小学
  &districtId=district-001
  &districtName=XX区
  &targetAudience=parent
  &token=SCHOOL_JWT_TOKEN
```

**说明**：

- 访问时使用已创建的问卷ID（survey-global-001）
- **包含 `projectId`**：此时工具已在项目中使用，需要标识项目
- URL参数包含学校信息，用于预填充和数据归属
- 每个学校有独立的JWT token，用于回调验证

#### 4.2.4 学校访问链接的JWT Token

学校访问链接的JWT Token包含完整的项目和学校上下文：

```json
{
  "toolId": "survey-001",
  "externalSurveyId": "survey-global-001",  // 全局问卷ID
  "projectId": "proj-001",                  // 工具在此项目中使用
  "schoolId": "school-001",                 // 学校标识
  "districtId": "district-001",
  "targetAudience": "parent",
  "linkId": "link-abc123",                  // survey_access_links.id
  "timestamp": 1234567890,
  "exp": 1234999999
}
```

## 五、API 接口设计

### 5.1 工具相关接口扩展

#### 5.1.1 获取工具列表（已扩展）

```http
GET /api/tools
```

返回字段中增加：

- `externalSurveyId`: 第三方问卷ID
- `externalSurveyUrl`: 第三方问卷链接

#### 5.1.2 管理员创建问卷跳转链接

管理员创建采集工具后，跳转到第三方系统创建问卷内容（此时尚未关联具体项目）：

```http
POST /api/tools/:id/create-survey
Content-Type: application/json

{
  "action": "create" | "edit" | "view"  // 操作类型
}
```

**请求说明**：

- `action`: 操作类型（create: 创建新问卷 / edit: 编辑已有问卷 / view: 查看问卷）

**响应示例**：

```json
{
  "code": 200,
  "data": {
    "url": "https://survey-test.f123.pub/?action=create&toolId=survey-001&toolName=家长满意度调查&callback=xxx&token=ADMIN_JWT_TOKEN",
    "externalSurveyId": "survey-global-001",  // 第三方系统的全局问卷ID
    "externalSurveyUrl": "https://survey-test.f123.pub/survey/survey-global-001"
  }
}
```

**管理员JWT Token payload**（用于创建问卷）：

```json
{
  "toolId": "survey-001",
  "action": "create",
  "timestamp": 1234567890,
  "exp": 1234999999
}
```

#### 5.1.3 批量生成学校访问链接（核心接口）

为项目中的所有学校或指定学校批量生成访问链接：

```http
POST /api/tools/:id/generate-access-links
Content-Type: application/json

{
  "projectId": "proj-001",                // 必填：项目ID
  "schoolIds": ["school-001", "school-002"], // 可选：学校ID列表（不提供则为项目所有学校生成）
  "targetAudience": "parent",             // 必填：目标受众
  "linkType": "url",                      // 可选：链接类型（url/qrcode/shortlink），默认url
  "expiresIn": 7776000                    // 可选：链接有效期（秒），默认90天
}
```

**请求说明**：

- `projectId`: 项目ID
- `schoolIds`: 学校ID列表，如不提供则为项目下所有学校生成链接
- `targetAudience`: 目标受众类型
- `linkType`: 链接类型
- `expiresIn`: 链接有效期（秒）

**响应示例**：

```json
{
  "code": 200,
  "data": {
    "total": 2,
    "generated": 2,
    "links": [
      {
        "schoolId": "school-001",
        "schoolName": "XX小学",
        "districtId": "district-001",
        "districtName": "XX区",
        "accessUrl": "https://survey-test.f123.pub/survey/survey-global-001?projectId=proj-001&schoolId=school-001&schoolName=XX小学&districtId=district-001&districtName=XX区&targetAudience=parent&token=SCHOOL_JWT_TOKEN_001",
        "qrCodeUrl": "https://yourdomain.com/qr/abc123.png",  // 如果 linkType=qrcode
        "expiresAt": "2025-04-15T10:00:00Z"
      },
      {
        "schoolId": "school-002",
        "schoolName": "YY中学",
        "districtId": "district-001",
        "districtName": "XX区",
        "accessUrl": "https://survey-test.f123.pub/survey/survey-global-001?projectId=proj-001&schoolId=school-002&...",
        "expiresAt": "2025-04-15T10:00:00Z"
      }
    ]
  }
}
```

**学校访问链接URL参数说明**：

- `projectId`: 项目ID（**核心参数**，用于识别数据归属的项目）
- `schoolId`: 学校ID（**核心参数**，用于识别填报学校）
- `schoolName`: 学校名称（URL编码，用于问卷中预填充显示）
- `districtId`: 区县ID
- `districtName`: 区县名称（URL编码）
- `targetAudience`: 目标受众（parent/teacher/student/principal）
- `token`: JWT签名token（包含项目和学校上下文，用于回调验证）

**学校JWT Token payload**：

```json
{
  "toolId": "survey-001",
  "externalSurveyId": "survey-global-001",  // 全局问卷ID
  "projectId": "proj-001",                  // 项目标识（核心）
  "schoolId": "school-001",                 // 学校标识（核心）
  "districtId": "district-001",
  "targetAudience": "parent",
  "linkId": "link-abc123",                  // survey_access_links.id
  "timestamp": 1234567890,
  "exp": 1234999999
}
```

#### 5.1.4 更新工具的第三方问卷信息

```http
PUT /api/tools/:id/survey-info
Content-Type: application/json

{
  "externalSurveyId": "xxx",
  "externalSurveyUrl": "https://survey-test.f123.pub/survey/xxx"
}
```

### 5.2 问卷统计接口

#### 5.2.1 接收第三方（推送详细问卷数据，核心接口）

```http
POST /
Content-Type: application/json
Authorization: Bearer JWT_TOKEN

{
  "toolId": "survey-001",                   // 本系统的工具ID
  "projectId": "proj-001",                  // 必填：项目ID
  "schoolId": "school-001",                 // 必填：学校ID
  "districtId": "district-001",             // 必填：区县ID
  "externalSurveyId": "ext-survey-123",     // 第三方系统的问卷ID
  "externalSurveyUrl": "https://...",       // 第三方系统的问卷URL
  "targetAudience": "parent",               // 目标受众

  // 核心数据：详细的问卷响应数据
  "responses": [
    {
      // 上下文标识字段（必填）
      "projectId": "proj-001",              // 项目ID（必填）
      "schoolId": "school-001",             // 学校ID（必填）
      "externalSurveyId": "ext-survey-123", // 问卷ID（必填）

      // 响应标识
      "responseId": "resp-001",             // 第三方系统的响应ID（必填，用于去重）

      // 问卷内容
      "respondentType": "parent",           // 填报人身份（必填）
      "totalScore": 4.5,                    // 总分数（必填，由第三方系统计算）
      "isValid": true,                      // 是否有效问卷（必填）
      "submittedAt": "2025-01-15T10:00:00Z",// 提交时间

      // 原始数据（可选）
      "rawData": {
        "q1": "非常满意",
        "q2": 5
      }
    },
    {
      // 上下文标识字段（必填）
      "projectId": "proj-001",
      "schoolId": "school-001",
      "externalSurveyId": "ext-survey-123",

      // 响应标识
      "responseId": "resp-002",

      // 问卷内容
      "respondentType": "teacher",
      "totalScore": 3.8,
      "isValid": true,
      "submittedAt": "2025-01-15T10:05:00Z"
    }
    // ... 更多问卷记录
  ],

  // 可选：基础统计汇总（仅供参考，本系统会重新计算）
  "summary": {
    "totalSent": 1000,
    "totalResponses": 850
  },

  "collectedAt": "2025-01-15T10:00:00Z"     // 数据采集时间
}
```

**请求说明**：

- 必须在 `Authorization` 头中携带JWT token（由生成链接时返回）
- 外层的 `projectId`, `schoolId`, `districtId` 为必填项，用于关联统计数据
- **核心变化**：`responses` 数组包含每份问卷的详细数据，而不是汇总统计
- **重要**：每个response对象内部也必须包含 `projectId`、`schoolId`、`externalSurveyId` 字段，确保数据的自包含性和可追溯性
- `totalScore`: 总分数由第三方系统计算（如问卷平均分、加权分等）
- `isValid`: 问卷有效性由第三方系统判定（如答题完整性、逻辑一致性等）
- **满意度判定**：本系统根据工具配置的阈值（`satisfaction_config.minScore`）判定是否满意

**安全验证流程**：

1. 验证JWT token的有效性和签名
2. 验证token中的 `toolId`, `projectId`, `schoolId` 与请求body一致
3. 验证学校存在性，并确认区县ID与学校所属区县匹配
4. 验证问卷响应数据的合法性（数值验证规则见下文）

**数据验证规则**：

```javascript
// 响应数据验证
responses.forEach(response => {
  // 上下文标识字段必填
  assert(response.projectId !== null && response.projectId !== undefined);
  assert(response.schoolId !== null && response.schoolId !== undefined);
  assert(response.externalSurveyId !== null && response.externalSurveyId !== undefined);

  // responseId 必填且唯一
  assert(response.responseId !== null && response.responseId !== undefined);

  // respondentType 必填且在允许范围内
  assert(['parent', 'teacher', 'student', 'principal', 'other'].includes(response.respondentType));

  // totalScore 必填且在合理范围内
  assert(response.totalScore !== null);
  assert(response.totalScore >= 0);

  // isValid 必填
  assert(typeof response.isValid === 'boolean');
});
```

**响应示例**：

```json
{
  "code": 200,
  "message": "问卷数据已接收并处理",
  "data": {
    "schoolId": "school-001",
    "schoolName": "XX小学",
    "districtId": "district-001",
    "responsesProcessed": 850,        // 处理的问卷响应数
    "responsesInserted": 120,         // 新增的问卷数
    "responsesUpdated": 730,          // 更新的问卷数
    "statisticsCalculated": {         // 本系统计算的统计数据
      "totalValid": 850,
      "totalSatisfied": 680,          // 根据配置阈值计算
      "satisfactionRate": 80.0
    },
    "synced": true,
    "indicatorsUpdated": 3            // 同步更新的指标数量
  }
}
```

**错误响应**：

```json
{
  "code": 400,
  "message": "问卷数据验证失败",
  "errors": [
    "响应ID resp-001 缺失",
    "响应ID resp-005 的满意度分数无效",
    "respondentType 必须是 parent/teacher/student/principal/other 之一"
  ]
}
```

#### 5.2.2 手动录入问卷统计数据

```http
POST /api/survey/statistics
Content-Type: application/json

{
  "toolId": "survey-001",
  "projectId": "proj-001",                  // 必填
  "schoolId": "school-001",                 // 必填
  "districtId": "district-001",             // 可选
  "totalSent": 1000,
  "totalSentToParents": 500,
  "totalValid": 850,
  "totalValidFromParents": 420,
  "totalSatisfied": 800,
  "totalSatisfiedFromParents": 400,
  "collectedAt": "2025-01-15T10:00:00Z"
}
```

#### 5.2.3 查询问卷统计数据

```http
GET /api/survey/statistics
Query Parameters:
  - toolId: 工具ID（必填）
  - projectId: 项目ID（可选）
  - schoolId: 学校ID（可选）
  - districtId: 区县ID（可选）
```

**响应示例**：

```json
{
  "code": 200,
  "data": {
    "toolId": "xxx",
    "toolName": "满意度调查问卷",
    "externalSurveyId": "xxx",
    "externalSurveyUrl": "https://...",
    "statistics": {
      "totalSent": 1000,
      "totalSentToParents": 500,
      "totalValid": 850,
      "totalValidFromParents": 420,
      "totalSatisfied": 800,
      "totalSatisfiedFromParents": 400
    },
    "source": "external",
    "collectedAt": "2025-01-15T10:00:00Z",
    "updatedAt": "2025-01-15T10:00:00Z"
  }
}
```

#### 5.2.4 更新问卷统计数据

```http
PUT /api/survey/statistics/:id
Content-Type: application/json

{
  "totalSent": 1200,
  "totalSentToParents": 600,
  // ... 其他统计字段
}
```

#### 5.2.5 批量查询（按项目/学校/区县）

```http
GET /api/survey/statistics/batch
Query Parameters:
  - projectId: 项目ID
  - schoolId: 学校ID
  - districtId: 区县ID
  - toolIds: 工具ID列表（逗号分隔）
```

## 六、问卷指标同步逻辑（核心技术实现）

### 6.1 同步触发时机

问卷统计数据到指标采集值的同步在以下时机自动触发：

1. **回调接口接收到统计数据时**（主要方式）

   - 第三方系统调用 `POST /api/survey/callback`
   - 数据验证通过后，自动触发 `syncSurveyIndicators(projectId, schoolId, toolId)`
2. **手动触发同步**（补充方式）

   - 提供手动同步按钮
   - 用于处理回调失败或数据修正场景

### 6.2 同步流程

```
┌─────────────────────────────────────────────────┐
│ 1. 接收详细问卷响应数据（回调接口）            │
│    responses = [                                │
│      { responseId, respondentType, score, ... },│
│      { ... },                                   │
│    ]                                            │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 2. 存储到 survey_responses 表                   │
│    UPSERT 每条问卷响应记录                      │
│    - external_response_id                      │
│    - respondent_type                           │
│    - total_score                               │
│    - is_valid                                  │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 3. 获取工具的满意度配置                         │
│    satisfaction_config = {                      │
│      scale: 5,                                 │
│      minScore: 4.0,                            │
│      calculationMethod: "threshold"            │
│    }                                            │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 4. 基于 survey_responses 计算统计汇总           │
│    SELECT COUNT(*) WHERE is_valid = true       │
│      → total_valid = 850                       │
│    SELECT COUNT(*) WHERE is_valid = true       │
│      AND total_score >= 4.0                    │
│      → total_satisfied = 680                   │
│    SELECT COUNT(*) WHERE respondent_type='parent'│
│      AND total_score >= 4.0                    │
│      → total_satisfied_from_parents = 320      │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 5. 更新 survey_statistics 表（汇总缓存）        │
│    UPSERT (tool_id, project_id, school_id)     │
│    - total_valid: 850                          │
│    - total_satisfied: 680                      │
│    - total_satisfied_from_parents: 320         │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 6. 构建虚拟 submission data                     │
│    (与表单类型工具的 submissions.data 格式一致)  │
│    {                                            │
│      total_sent: 1000,                         │
│      total_valid: 850,                         │
│      total_satisfied: 680,                     │
│      total_sent_to_parents: 500,               │
│      ...                                       │
│    }                                            │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 7. 读取字段映射 (field_mappings)                │
│    WHERE tool_id = 'survey-001'                │
│    - field_id='total_sent' → element S6_01     │
│    - field_id='total_valid' → element S6_02    │
│    - field_id='total_satisfied' → element S6_03│
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 8. 提取基础要素值                               │
│    element_values = {                          │
│      S6_01: 1000,                              │
│      S6_02: 850,                               │
│      S6_03: 680                                │
│    }                                            │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 9. 计算派生要素（如果有公式）                   │
│    查询关联的派生要素：                          │
│    SELECT * FROM elements                      │
│    WHERE element_type = '派生要素'              │
│      AND formula IS NOT NULL                   │
│                                                 │
│    执行公式计算：                                │
│    S6_D01 (满意度) = S6_03 / S6_02 * 100       │
│                    = 680 / 850 * 100            │
│                    = 80.0                       │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 10. 查找要素关联的数据指标                      │
│    通过 data_indicator_elements 表               │
│    找到需要更新的 data_indicators               │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 11. 写入/更新 school_indicator_data 表          │
│    UPSERT (project_id, school_id, indicator_id) │
│    VALUES:                                      │
│    - value: 80.0                               │
│    - text_value: "80.0%"                       │
│    - is_compliant: 1 (根据threshold判定)        │
│    - submission_id: NULL (问卷无submission)     │
│    - collected_at: "2025-01-15T10:00:00Z"      │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ 12. 返回同步结果                                │
│    {                                            │
│      responsesProcessed: 850,                  │
│      indicatorsUpdated: 3,                     │
│      synced: true                              │
│    }                                            │
└─────────────────────────────────────────────────┘
```

### 6.3 核心代码实现（伪代码）

```javascript
// backend/services/surveySync.js

/**
 * 处理第三方问卷系统回调数据
 */
async function processSurveyCallback(callbackData) {
  const { toolId, projectId, schoolId, responses, collectedAt } = callbackData;

  // 开启数据库事务
  const client = await db.getClient();
  try {
    await client.query('BEGIN');

    // 1. 获取工具信息和满意度配置
    const tool = await client.query(
      'SELECT * FROM data_tools WHERE id = $1',
      [toolId]
    );

    if (tool.rows[0].type !== '问卷') {
      throw new Error('工具类型不是问卷');
    }

    const satisfactionConfig = tool.rows[0].satisfaction_config || {
      scale: 5,
      minScore: 4.0,
      calculationMethod: 'threshold'
    };

    // 2. 存储每份问卷的详细数据到 survey_responses 表
    let responsesInserted = 0;
    let responsesUpdated = 0;

    for (const response of responses) {
      const result = await client.query(`
        INSERT INTO survey_responses (
          id, tool_id, project_id, school_id, district_id,
          external_response_id, external_survey_id, respondent_type,
          total_score, is_valid, submitted_at, raw_data,
          created_at, updated_at
        ) VALUES (
          $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
        )
        ON CONFLICT (external_response_id)
        DO UPDATE SET
          total_score = EXCLUDED.total_score,
          is_valid = EXCLUDED.is_valid,
          updated_at = CURRENT_TIMESTAMP
        RETURNING (xmax = 0) AS inserted
      `, [
        generateId(),
        toolId,
        projectId,
        schoolId,
        callbackData.districtId,
        response.responseId,
        callbackData.externalSurveyId,
        response.respondentType,
        response.totalScore,
        response.isValid,
        response.submittedAt,
        JSON.stringify(response.rawData || {})
      ]);

      if (result.rows[0].inserted) {
        responsesInserted++;
      } else {
        responsesUpdated++;
      }
    }

    // 3. 基于 survey_responses 计算统计汇总
    const statistics = await calculateSurveyStatistics(
      client,
      toolId,
      projectId,
      schoolId,
      satisfactionConfig
    );

    // 4. 更新 survey_statistics 表（汇总缓存）
    await client.query(`
      INSERT INTO survey_statistics (
        id, tool_id, project_id, school_id, district_id,
        total_sent, total_sent_to_parents,
        total_valid, total_valid_from_parents,
        total_satisfied, total_satisfied_from_parents,
        source, external_survey_id, collected_at,
        created_at, updated_at
      ) VALUES (
        $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14,
        CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
      )
      ON CONFLICT (tool_id, project_id, school_id)
      DO UPDATE SET
        total_sent = EXCLUDED.total_sent,
        total_sent_to_parents = EXCLUDED.total_sent_to_parents,
        total_valid = EXCLUDED.total_valid,
        total_valid_from_parents = EXCLUDED.total_valid_from_parents,
        total_satisfied = EXCLUDED.total_satisfied,
        total_satisfied_from_parents = EXCLUDED.total_satisfied_from_parents,
        collected_at = EXCLUDED.collected_at,
        updated_at = CURRENT_TIMESTAMP
    `, [
      generateId(),
      toolId,
      projectId,
      schoolId,
      callbackData.districtId,
      callbackData.summary?.totalSent || statistics.total_valid,
      statistics.total_sent_to_parents,
      statistics.total_valid,
      statistics.total_valid_from_parents,
      statistics.total_satisfied,
      statistics.total_satisfied_from_parents,
      'external',
      callbackData.externalSurveyId,
      collectedAt
    ]);

    // 5. 同步到指标系统
    const indicatorResult = await syncSurveyIndicators(
      client,
      projectId,
      schoolId,
      toolId,
      statistics,
      collectedAt
    );

    await client.query('COMMIT');

    return {
      responsesProcessed: responses.length,
      responsesInserted,
      responsesUpdated,
      statisticsCalculated: statistics,
      indicatorsUpdated: indicatorResult.indicatorsUpdated,
      synced: true
    };

  } catch (error) {
    await client.query('ROLLBACK');
    throw error;
  } finally {
    client.release();
  }
}

/**
 * 基于 survey_responses 表计算统计汇总
 */
async function calculateSurveyStatistics(
  client, toolId, projectId, schoolId, satisfactionConfig
) {
  const minScore = satisfactionConfig.minScore || 4.0;

  const result = await client.query(`
    SELECT
      COUNT(*) FILTER (WHERE is_valid = true) as total_valid,
      COUNT(*) FILTER (WHERE is_valid = true AND respondent_type = 'parent') as total_valid_from_parents,
      COUNT(*) FILTER (WHERE is_valid = true AND total_score >= $1) as total_satisfied,
      COUNT(*) FILTER (WHERE is_valid = true AND total_score >= $1 AND respondent_type = 'parent') as total_satisfied_from_parents,
      COUNT(*) FILTER (WHERE respondent_type = 'parent') as total_sent_to_parents
    FROM survey_responses
    WHERE tool_id = $2 AND project_id = $3 AND school_id = $4
  `, [minScore, toolId, projectId, schoolId]);

  return result.rows[0];
}

/**
 * 同步问卷统计数据到指标系统
 */
async function syncSurveyIndicators(
  client, projectId, schoolId, toolId, statistics, collectedAt
) {
  // 构建虚拟的 submission data（与表单数据格式一致）
  const virtualSubmissionData = {
    total_sent: statistics.total_sent || statistics.total_valid,
    total_sent_to_parents: statistics.total_sent_to_parents,
    total_valid: statistics.total_valid,
    total_valid_from_parents: statistics.total_valid_from_parents,
    total_satisfied: statistics.total_satisfied,
    total_satisfied_from_parents: statistics.total_satisfied_from_parents
  };

  // 复用现有的要素提取和指标计算逻辑
  const result = await processElementsAndIndicators(
    client,
    projectId,
    schoolId,
    toolId,
    virtualSubmissionData,
    collectedAt
  );

  return result;
}

// 复用现有的要素处理逻辑（与 submissions.js 中的逻辑相同）
async function processElementsAndIndicators(
  projectId, schoolId, toolId, data, collectedAt
) {
  // 读取字段映射
  const mappings = await getFieldMappings(toolId);

  // 提取基础要素值
  const elementValues = {};
  for (const mapping of mappings) {
    if (mapping.mapping_type === 'element') {
      const value = getValueByPath(data, mapping.field_id);
      elementValues[mapping.target_id] = value;
    }
  }

  // 计算派生要素
  const derivedElements = await getDerivedElements(projectId);
  for (const element of derivedElements) {
    if (element.formula) {
      elementValues[element.id] = evaluateFormula(element.formula, elementValues);
    }
  }

  // 查找关联的数据指标并写入
  let indicatorsUpdated = 0;
  for (const [elementId, value] of Object.entries(elementValues)) {
    const indicators = await getIndicatorsByElement(elementId, projectId);

    for (const indicator of indicators) {
      await upsertSchoolIndicatorData({
        projectId,
        schoolId,
        dataIndicatorId: indicator.id,
        value,
        isCompliant: checkCompliance(value, indicator.threshold),
        collectedAt
      });
      indicatorsUpdated++;
    }
  }

  return { indicatorsUpdated, synced: true };
}
```

### 6.4 与表单类型工具的对比

| 项目                     | 表单类型工具                   | 问卷类型工具                              |
| ------------------------ | ------------------------------ | ----------------------------------------- |
| **数据来源**       | `submissions.data`           | `survey_statistics` 表                  |
| **触发方式**       | 用户提交表单                   | 第三方系统回调                            |
| **schema定义**     | 用户自定义                     | 自动生成标准schema                        |
| **字段映射**       | 映射到自定义字段ID             | 映射到标准统计字段ID                      |
| **同步逻辑**       | `syncSubmissionIndicators()` | `syncSurveyIndicators()`                |
| **submission记录** | 有                             | 无（直接统计数据）                        |
| **核心差异**       | 读取 `submissions.data`      | 读取 `survey_statistics` 并构建虚拟data |

### 6.5 数据一致性保证

1. **事务处理**

   - 使用数据库事务确保数据一致性
   - 回调接口中更新 `survey_instances` + `survey_statistics` + `school_indicator_data` 在同一事务中
2. **幂等性**

   - 回调接口支持重复调用（使用UPSERT）
   - 相同的问卷ID多次回调只更新最新数据
3. **错误处理**

   - 同步失败时记录错误日志
   - 提供手动重新同步功能
   - 在前端显示同步状态（成功/失败/待同步）

## 七、前端功能设计

### 7.1 工具库页面增强

#### 7.1.1 工具列表展示

在工具卡片中，对于"问卷"类型的工具：

- 显示"跳转到问卷系统"按钮
- 如果已关联第三方问卷（有 `externalSurveyId`），显示"编辑问卷"和"查看问卷"按钮
- 显示问卷统计数据的快速预览（发放数、回收率、满意度）

#### 7.1.2 批量生成问卷链接功能

提供批量为所有学校生成问卷链接的功能：

```tsx
// 功能描述
- 选择项目和问卷工具
- 选择目标受众（家长/教师/学生）
- 点击"为所有学校生成链接"
- 系统为每个学校生成独立的问卷链接
- 显示链接列表，支持复制、生成二维码、批量导出
```

#### 7.1.3 跳转流程

1. 用户选择项目和学校
2. 用户点击"跳转到问卷系统"按钮
3. 前端调用 `POST /api/tools/:id/generate-survey-link` 获取跳转URL
4. 在新窗口打开第三方问卷系统（URL携带学校、受众信息）
5. 用户在第三方系统中完成问卷创建/编辑
6. 第三方系统通过回调接口将问卷ID和统计数据推送到本系统
7. 本系统自动同步到 `school_indicator_data` 表
8. 前端通过轮询或WebSocket显示同步状态

### 7.2 问卷统计页面

#### 7.2.1 统计概览

- 显示问卷总数、有效问卷数、满意问卷数
- 区分总体数据和家长数据
- 支持按项目、学校、区县筛选
- 显示同步状态（已同步/待同步/同步失败）
- 提供手动同步按钮

#### 7.2.2 数据录入

- 支持手动录入问卷统计数据
- 支持批量导入（Excel/CSV）
- 显示数据来源（第三方系统/手动录入）
- 数据录入后自动触发指标同步

#### 7.2.3 按身份类型细分展示

- 表格展示各身份类型的统计数据（家长、教师、学生等）
- 每行显示：身份类型、发放数、有效回收数、满意数、满意度
- 支持导出为Excel/PDF

### 7.3 工具编辑页面

在工具编辑页面中：

- 显示第三方问卷系统的关联状态
- 提供"跳转到问卷系统"按钮
- 显示问卷统计数据（如果有）
- 显示标准Schema的字段（只读，不可编辑）
- 提供字段映射配置界面（映射到要素）

## 八、数据流程

### 8.1 问卷创建流程（一校一问卷）

```
1. 用户在本系统创建"问卷"类型工具
   ↓ (系统自动生成标准schema)
2. 用户选择项目和学校，点击"生成问卷链接"
   ↓
3. 前端调用 generate-survey-link 接口
   请求参数：{ projectId, schoolId, targetAudience: 'parent' }
   ↓
4. 后端生成跳转URL（包含学校、区县、受众、JWT token等参数）
   ↓
5. 前端在新窗口打开第三方问卷系统
   ↓
6. 第三方系统接收URL参数，创建问卷实例
   - 存储学校ID、区县ID、受众类型
   - 在问卷中预填充"所属学校"、"您的身份"等字段
   ↓
7. 用户在第三方系统中配置具体问卷题目并发布
   ↓
8. 第三方系统调用本系统的回调接口
   POST /api/survey/callback
   Authorization: Bearer JWT_TOKEN
   {
     toolId: "xxx",
     projectId: "proj-001",
     schoolId: "school-001",        // 必填
     districtId: "district-001",    // 必填
     externalSurveyId: "ext-survey-123",
     externalSurveyUrl: "https://...",
     targetAudience: "parent",
     statistics: { ... }
   }
   ↓
9. 本系统验证token并更新数据（事务）：
   - 更新 survey_instances 表（问卷实例状态）
   - 更新 survey_statistics 表（统计数据）
   - 触发 syncSurveyIndicators() 同步到 school_indicator_data
   ↓
10. 返回同步结果
    { schoolId: "school-001", synced: true, indicatorsUpdated: 3 }
```

### 8.2 问卷数据更新流程

```
1. 家长/教师在第三方系统填写问卷
   - 系统根据"您的身份"字段识别身份
   ↓
2. 第三方系统实时统计（或定时统计）
   - 按身份类型分类统计
   - 计算满意度等指标
   ↓
3. 第三方系统调用本系统回调接口（推送更新后的统计数据）
   POST /api/survey/callback
   {
     toolId: "xxx",
     projectId: "proj-001",
     schoolId: "school-001",
     externalSurveyId: "ext-survey-123",
     statistics: {
       totalSent: 1000,
       totalValid: 850,        // 更新后的数据
       totalSatisfied: 800,
       totalSentToParents: 500,
       totalValidFromParents: 420,
       totalSatisfiedFromParents: 400
     }
   }
   ↓
4. 本系统更新 survey_statistics 表（UPSERT）
   ↓
5. 自动触发 syncSurveyIndicators() 重新计算指标
   ↓
6. 更新 school_indicator_data 表（UPSERT）
   ↓
7. 前端通过轮询或WebSocket实时显示最新数据
```

### 8.3 数据统计使用流程（与要素系统集成）

```
1. 问卷统计数据存储在 survey_statistics 表
   - total_sent: 1000
   - total_valid: 850
   - total_satisfied: 800
   ↓
2. 构建虚拟 submission data
   { total_sent: 1000, total_valid: 850, total_satisfied: 800 }
   ↓
3. 通过字段映射（field_mappings）关联到要素（elements）
   - field_id='total_sent' → element S6_01 (问卷总数)
   - field_id='total_valid' → element S6_02 (回收有效问卷数)
   - field_id='total_satisfied' → element S6_03 (满意问卷数)
   ↓
4. 提取基础要素值
   element_values = { S6_01: 1000, S6_02: 850, S6_03: 800 }
   ↓
5. 计算派生要素（如果有公式）
   S6_D01 (满意度) = S6_03 / S6_02 * 100 = 94.12
   ↓
6. 查找要素关联的数据指标（data_indicator_elements 表）
   ↓
7. 写入 school_indicator_data 表
   (project_id, school_id, data_indicator_id, value, is_compliant)
   ↓
8. 用于指标达标判定和统计分析
   - 达标率统计
   - 区县对比
   - 项目总体分析
```

## 九、第三方问卷系统对接要求

本系统与第三方问卷系统（https://survey-test.f123.pub/）的对接需要第三方系统实现以下功能：

### 9.1 接收本系统的跳转请求

第三方系统需要能够接收并解析本系统生成的URL参数：

**URL格式示例**：

```
https://survey-test.f123.pub/
  ?action=create
  &toolId=survey-001
  &toolName=家长满意度调查
  &callback=https://yourdomain.com/api/survey/callback
  &token=JWT_TOKEN
```

**必须处理的参数**：

- `action`: 操作类型（create/edit/view）
- `toolId`: 本系统的工具ID（用于回调时标识）
- `toolName`: 问卷名称（建议使用）
- `callback`: 回调URL（统计数据更新时调用）
- `token`: JWT认证token（回调时必须携带）

### 9.2 问卷创建/发布后返回问卷入口地址（核心要求）

**重要**：当管理员在第三方系统完成问卷的创建和发布后，第三方系统**必须通过回调接口**向本系统返回以下信息：

#### 9.2.1 首次回调时机

在以下时机进行首次回调：

1. **问卷创建完成时**（推荐）：管理员在第三方系统点击"保存"或"创建"按钮后立即回调
2. **问卷发布时**：管理员在第三方系统点击"发布"按钮后回调
3. **窗口关闭前**：管理员关闭第三方问卷系统窗口前回调

#### 9.2.2 必须返回的信息

通过回调接口（`POST {callback}`）返回：

```http
POST https://yourdomain.com/api/survey/callback
Content-Type: application/json
Authorization: Bearer {token}

{
  "toolId": "{从URL获取的toolId}",
  "externalSurveyId": "survey-global-001",  // 第三方系统生成的问卷ID（必填）
  "externalSurveyUrl": "https://survey-test.f123.pub/survey/survey-global-001",  // 问卷入口地址（必填）
  "action": "created",  // 操作类型：created/published
  "responses": []  // 首次回调时为空数组
}
```

**关键字段说明**：

- **`externalSurveyId`**（必填）：第三方系统为该问卷生成的唯一ID

  - 用途：后续编辑、查看问卷时的标识
  - 要求：全局唯一，不可变
- **`externalSurveyUrl`**（必填，核心）：问卷的访问入口地址

  - 用途：本系统将基于此地址生成学校访问链接
  - 格式：完整的URL（含协议和域名）
  - 示例：`https://survey-test.f123.pub/survey/survey-global-001`
  - **重要**：此地址应支持URL参数追加（如 `?projectId=xxx&schoolId=xxx`）

#### 9.2.3 本系统的处理

本系统接收到首次回调后：

1. 验证JWT token
2. 保存问卷ID和入口地址到 `data_tools` 表：
   ```sql
   UPDATE data_tools
   SET external_survey_id = 'survey-global-001',
       external_survey_url = 'https://survey-test.f123.pub/survey/survey-global-001'
   WHERE id = {toolId};
   ```
3. 返回成功响应：
   ```json
   {
     "code": 200,
     "message": "问卷信息已保存"
   }
   ```

#### 9.2.4 后续使用

保存后，本系统在为学校生成访问链接时，会基于 `externalSurveyUrl` 生成完整URL：

```
{externalSurveyUrl}?projectId=proj-001&schoolId=school-001&targetAudience=parent&token=...
```

例如：

```
https://survey-test.f123.pub/survey/survey-global-001?projectId=proj-001&schoolId=school-001&schoolName=XX小学&targetAudience=parent&token=JWT_TOKEN
```

### 9.3 问卷响应数据处理（核心要求）

**第三方系统需要为每份问卷提供以下数据**：

#### 9.3.1 上下文标识字段（必填，用于数据归属）

1. **项目ID**（必填）

   - 字段：`projectId`
   - 用途：标识该问卷响应所属的项目
   - 来源：从学校访问链接的URL参数或token中获取
   - 说明：确保数据能正确归属到对应项目
   - **重要**：每个response对象必须包含此字段，确保数据的自包含性
2. **学校ID**（必填）

   - 字段：`schoolId`
   - 用途：标识该问卷响应来自哪个学校
   - 来源：从学校访问链接的URL参数或token中获取
   - 说明：这是区分不同学校填报数据的核心字段
3. **问卷ID**（必填）

   - 字段：`externalSurveyId`
   - 用途：标识该响应所属的问卷（第三方系统的问卷ID）
   - 说明：支持一个工具关联多个问卷的场景

#### 9.3.2 响应标识字段

4. **响应ID**（必填）

   - 字段：`responseId`
   - 用途：唯一标识每份问卷，用于去重和更新
   - 要求：确保全局唯一（建议格式：`{externalSurveyId}-{序号}` 或使用UUID）

#### 9.3.3 问卷内容字段

5. **填报人身份**（必填）

   - 字段：`respondentType`
   - 取值：`parent`、`teacher`、`student`、`principal`、`other`
   - 来源：从问卷中的身份选择题获取
   - 说明：可以从 `targetAudience` 参数预填充，但允许用户修改
6. **总分数**（必填，核心字段）

   - 字段：`totalScore`
   - 类型：浮点数（如 4.5、3.8）
   - 计算方式：由第三方系统根据问卷回答计算
   - 示例计算方法：
     - 单题平均分：取所有满意度相关题目的平均分
     - 加权平均：根据题目权重计算加权平均分
     - 综合评分：基于多个维度的综合评分算法
   - 说明：**满意度判定由本系统负责**，根据配置的阈值（如 ≥4.0）判定是否满意
7. **有效性标识**（必填）

   - 字段：`isValid`
   - 类型：布尔值
   - 判定规则（由第三方系统定义）：
     - 答题完整性：必填题是否都已填写
     - 逻辑一致性：问卷内部逻辑是否矛盾
     - 答题时长：是否在合理范围内
     - 重复提交检测：同一人是否重复提交
8. **提交时间**（必填）

   - 字段：`submittedAt`
   - 格式：ISO 8601 日期时间字符串
   - 示例：`2025-01-15T10:00:00Z`
9. **原始数据**（可选，推荐）

   - 字段：`rawData`
   - 类型：JSON对象
   - 用途：保留完整的问卷回答，用于审计和复核
   - 示例：
     ```json
     {
       "q1_school_satisfaction": 5,
       "q2_teacher_quality": 4,
       "q3_facilities": 4,
       "q4_comment": "整体满意"
     }
     ```

#### 9.3.4 完整的响应对象示例

```json
{
  // 上下文标识字段（必填）
  "projectId": "proj-001",
  "schoolId": "school-001",
  "externalSurveyId": "survey-global-001",

  // 响应标识
  "responseId": "resp-001",

  // 问卷内容
  "respondentType": "parent",
  "totalScore": 4.5,
  "isValid": true,
  "submittedAt": "2025-01-15T10:00:00Z",

  // 原始数据（可选）
  "rawData": {
    "q1_school_satisfaction": 5,
    "q2_teacher_quality": 4,
    "q3_facilities": 4,
    "q4_comment": "整体满意"
  }
}
```

#### 9.3.5 数据冗余说明

虽然在回调数据的外层也包含 `projectId`、`schoolId`、`externalSurveyId`，但**每个response对象内部也必须包含这些字段**，原因：

1. **数据完整性**：每个response对象都是自包含的，不依赖外层上下文
2. **灵活性**：支持第三方系统在一次回调中推送多个学校/项目的数据（批量推送）
3. **容错性**：即使外层信息丢失或不一致，response对象仍能正确归属
4. **可追溯性**：每个response记录完整的上下文信息，便于审计和问题排查

**验证规则**：

- 如果外层和response内部的字段都存在，本系统会验证它们的一致性
- 如果不一致，以response内部的字段为准，并记录警告日志

#### 9.3.6 第三方系统无需计算的数据（由本系统负责）

- ❌ `totalSatisfied`（满意问卷数）→ 本系统根据阈值计算
- ❌ `totalSatisfiedFromParents`（家长满意数）→ 本系统根据阈值计算
- ❌ `satisfactionRate`（满意度百分比）→ 本系统计算派生指标

### 9.4 回调本系统接口

第三方系统需要在不同场景下调用本系统的回调接口：

**接口地址**：从跳转URL的 `callback` 参数获取

#### 9.4.1 场景一：问卷创建/发布回调（首次回调）

当管理员在第三方系统完成问卷创建/发布后，**立即**回调通知本系统。

**回调数据格式**：

```http
POST {callback}
Content-Type: application/json
Authorization: Bearer {token}  ← 必须携带从URL获取的JWT token

{
  "toolId": "{从URL获取的toolId}",
  "externalSurveyId": "survey-global-001",  // 第三方系统生成的问卷ID（必填）
  "externalSurveyUrl": "https://survey-test.f123.pub/survey/survey-global-001",  // 问卷入口地址（必填）
  "action": "created",  // 或 "published"
  "responses": []  // 首次回调时为空数组（尚无填报数据）
}
```

**说明**：

- 此时**无需**提供 `projectId`、`schoolId`、`districtId`（管理员创建问卷时未关联项目）
- 重点是返回 `externalSurveyId` 和 `externalSurveyUrl`
- `responses` 字段为空数组

#### 9.4.2 场景二：问卷数据同步回调（数据更新时）

当学校用户填写问卷后，第三方系统定期或实时推送问卷数据到本系统。

**回调数据格式**：

```http
POST {callback}
Content-Type: application/json
Authorization: Bearer {token}  ← 必须携带从学校访问链接中的JWT token

{
  "toolId": "{从token中获取的toolId}",
  "projectId": "{从token中获取的projectId}",  // 必填（学校访问时才有）
  "schoolId": "{从token中获取的schoolId}",    // 必填（学校访问时才有）
  "districtId": "{从token中获取的districtId}",
  "externalSurveyId": "survey-global-001",
  "externalSurveyUrl": "https://survey-test.f123.pub/survey/survey-global-001",
  "targetAudience": "{从token中获取的targetAudience}",

  // 核心：详细的问卷响应数据
  "responses": [
    {
      // 上下文标识字段（必填）
      "projectId": "proj-001",
      "schoolId": "school-001",
      "externalSurveyId": "survey-global-001",

      // 响应标识
      "responseId": "resp-001",

      // 问卷内容
      "respondentType": "parent",
      "totalScore": 4.5,               // 第三方系统计算的总分数
      "isValid": true,                 // 第三方系统判定的有效性
      "submittedAt": "2025-01-15T10:00:00Z",

      // 原始数据（可选）
      "rawData": {
        "q1": 5,
        "q2": 4
      }
    },
    {
      // 上下文标识字段（必填）
      "projectId": "proj-001",
      "schoolId": "school-001",
      "externalSurveyId": "survey-global-001",

      // 响应标识
      "responseId": "resp-002",

      // 问卷内容
      "respondentType": "teacher",
      "totalScore": 3.8,
      "isValid": true,
      "submittedAt": "2025-01-15T10:05:00Z"
    }
    // ... 更多问卷记录
  ],

  // 可选：基础统计汇总（仅供参考）
  "summary": {
    "totalSent": 1000,
    "totalResponses": 850
  },

  "collectedAt": "2025-01-15T10:00:00Z"
}
```

**说明**：

- 必须包含 `projectId` 和 `schoolId`（从学校访问链接的token中获取）
- `responses` 数组包含该学校用户的所有问卷填报数据
- 可以是增量推送（仅新增的问卷）或全量推送（所有问卷）

#### 9.4.3 调用时机总结

| 场景                       | 调用时机                        | 是否包含projectId/schoolId       | responses内容      |
| -------------------------- | ------------------------------- | -------------------------------- | ------------------ |
| **场景一：问卷创建** | 管理员创建/发布问卷后立即回调   | ❌ 否（管理员创建时未关联项目）  | 空数组 `[]`      |
| **场景二：数据同步** | 学校用户填写问卷后定期/实时回调 | ✅ 是（从学校访问链接token获取） | 包含填报数据的数组 |

**数据同步回调的推荐频率**：

1. **实时推送**（推荐）：每当有新问卷提交时立即回调
2. **定时推送**：每小时或每天定时汇总推送
3. **最终推送**：问卷关闭时进行最终数据推送

#### 9.4.4 幂等性要求

- 支持重复调用，本系统会使用UPSERT更新数据
- 对于场景一（问卷创建）：相同的 `toolId` 多次回调会更新 `externalSurveyId` 和 `externalSurveyUrl`
- 对于场景二（数据同步）：相同的 `responseId` 多次回调会更新最新数据（基于 `external_response_id` 去重）

### 9.5 数据验证规则

第三方系统在回调前应验证数据合法性：

```javascript
// 响应数据验证
responses.forEach(response => {
  // 1. 上下文标识字段验证（必填）
  if (!response.projectId) {
    throw new Error('响应中缺少 projectId 字段');
  }
  if (!response.schoolId) {
    throw new Error('响应中缺少 schoolId 字段');
  }
  if (!response.externalSurveyId) {
    throw new Error('响应中缺少 externalSurveyId 字段');
  }

  // 2. responseId 必填
  if (!response.responseId) {
    throw new Error('响应ID缺失');
  }

  // 3. respondentType 必填且在允许范围内
  const validTypes = ['parent', 'teacher', 'student', 'principal', 'other'];
  if (!validTypes.includes(response.respondentType)) {
    throw new Error(`respondentType 必须是 ${validTypes.join('/')} 之一`);
  }

  // 4. totalScore 必填且为有效数值
  if (response.totalScore === null || response.totalScore === undefined) {
    throw new Error('总分数缺失');
  }
  if (typeof response.totalScore !== 'number' || response.totalScore < 0) {
    throw new Error('总分数必须是非负数');
  }

  // 5. isValid 必填
  if (typeof response.isValid !== 'boolean') {
    throw new Error('isValid 必须是布尔值');
  }

  // 6. submittedAt 推荐提供
  if (!response.submittedAt) {
    console.warn('建议提供 submittedAt 字段');
  }
});
```

### 9.6 错误处理

**回调接口可能返回的错误**：

- `401`: Token无效或已过期
- `400`: 数据验证失败（错误详情在response.errors中）
- `404`: 学校不存在
- `500`: 服务器错误

**建议的重试策略**：

- 4xx错误：记录日志，不重试
- 5xx错误：指数退避重试（最多3次）

## 十、技术实现要点

### 10.1 安全性

1. **回调接口验证**

   - 使用JWT token验证（包含在Authorization头）
   - Token有效期：90天（可配置）
   - 验证token payload与请求body的一致性
2. **数据校验**

   - 验证 toolId、projectId、schoolId 存在性
   - 验证统计数据字段的合法性（非负数、合理范围）
   - 验证学校所属区县与 districtId 匹配
3. **IP白名单（可选）**

   - 配置第三方系统的IP白名单
   - 限制只有白名单IP可以调用回调接口

### 10.2 错误处理

1. **回调失败处理**

   - 记录失败日志（包含完整请求和响应）
   - 提供手动同步功能
   - 在前端显示同步状态
2. **数据一致性**

   - 使用事务保证数据一致性
   - 处理并发更新冲突（UPSERT）
   - 提供数据修复工具

### 10.3 性能优化

1. **缓存策略**

   - 缓存工具信息（5分钟TTL）
   - 缓存学校信息（10分钟TTL）
2. **批量操作**

   - 支持批量查询统计数据
   - 支持批量生成问卷链接
3. **异步处理**

   - 回调接口快速返回（200 OK）
   - 指标同步异步处理（后台任务）

## 十一、环境配置

### 11.1 环境变量

```bash
# 第三方问卷系统基础URL
SURVEY_BASE_URL=https://survey-test.f123.pub

# 本系统基础URL（用于回调）
APP_BASE_URL=https://yourdomain.com

# JWT密钥（用于生成和验证token）
SURVEY_CALLBACK_SECRET=your-secret-key-min-32-chars

# 回调接口IP白名单（可选，逗号分隔）
SURVEY_CALLBACK_IP_WHITELIST=192.168.1.0/24,10.0.0.0/8

# JWT Token有效期（秒，默认90天）
SURVEY_TOKEN_EXPIRY=7776000
```

### 11.2 数据库迁移

执行迁移脚本：

```bash
# 连接数据库
psql -U your_user -d your_database

# 执行迁移脚本
\i backend/database/migrations/add_survey_integration.sql
```

## 十二、实施步骤

### 阶段一：数据库和核心接口（2-3天）

1. **数据库迁移**

   - 创建 `survey_statistics` 表
   - 创建 `survey_instances` 表
   - 扩展 `data_tools` 表
   - 创建索引和唯一约束
2. **后端核心接口**

   - 实现问卷工具标准schema自动生成逻辑
   - 实现 `POST /api/tools/:id/generate-survey-link` 接口
   - 实现 `POST /api/survey/callback` 回调接口
   - 实现问卷统计CRUD接口
   - 实现问卷指标同步逻辑 `syncSurveyIndicators()`
3. **单元测试**

   - 测试schema生成
   - 测试JWT token生成和验证
   - 测试回调接口数据验证
   - 测试指标同步逻辑

### 阶段二：前端功能开发（2-3天）

1. **工具库页面增强**

   - 问卷类型工具识别和样式
   - 生成问卷链接按钮（需要选择项目、学校、受众）
   - 批量生成链接功能
   - 统计数据快速预览
2. **问卷统计页面**

   - 统计概览卡片
   - 按身份类型细分表格
   - 手动录入表单
   - 同步状态显示
3. **字段映射配置**

   - 显示问卷标准schema字段
   - 映射到要素的配置界面
4. **集成测试**

   - 端到端测试（创建工具→生成链接→模拟回调→查看统计）

### 阶段三：第三方系统对接与优化（2-3天）

1. **第三方系统联调**

   - 提供对接文档给第三方
   - 测试URL跳转和参数传递
   - 测试回调接口
   - 测试数据同步
2. **性能优化**

   - 添加缓存层
   - 优化数据库查询
   - 异步处理指标同步
3. **安全性加固**

   - JWT token安全性测试
   - 数据验证完整性测试
   - IP白名单配置（可选）
4. **文档完善**

   - 更新API文档
   - 编写操作手册
   - 记录常见问题FAQ

## 十三、后续扩展

### 13.1 功能扩展

- 支持多个第三方问卷系统（配置化）
- 支持问卷数据实时同步（WebSocket）
- 支持问卷数据导出（Excel/PDF）
- 支持问卷数据可视化（图表展示、满意度分布等）
- 支持问卷提醒和进度跟踪

### 13.2 数据扩展

- 支持更细粒度的统计维度（年级、班级、性别等）
- 支持问卷详细数据导入（非仅统计数据，包含每份问卷的详细回答）
- 支持问卷结果分析（满意度分布、趋势分析、相关性分析等）
- 支持自定义统计指标

### 13.3 集成扩展

- 支持与短信/邮件系统集成（发送问卷链接）
- 支持二维码批量生成和打印
- 支持微信小程序/公众号集成

## 十四、注意事项与风险

### 14.1 第三方系统对接

1. **接口规范确认**

   - 与第三方系统确认回调接口格式和参数
   - 确认跳转URL的参数命名和编码方式
   - 确认数据统计字段的定义和计算规则
   - 确认满意度判定标准（如5分制≥4分为满意）
2. **协议和SLA**

   - 明确数据安全和隐私保护责任
   - 约定服务可用性和响应时间
   - 明确故障处理流程

### 14.2 数据同步

1. **延迟问题**

   - 回调可能有延迟（网络、第三方系统处理时间）
   - 考虑异步处理和重试机制
   - 提供手动同步功能作为补充
2. **数据一致性**

   - 使用事务保证关键操作的原子性
   - 处理并发更新冲突
   - 记录同步日志便于排查问题

### 14.3 兼容性

1. **向后兼容**

   - 保持对现有"表单"类型工具的完全兼容
   - 问卷类型工具可以不使用第三方系统（支持手动录入）
   - 不影响现有的指标计算和要素系统
2. **版本管理**

   - 接口版本化（v1/v2）
   - 数据库schema变更使用迁移脚本
   - 保留数据回滚能力

### 14.4 安全风险

1. **数据泄露风险**

   - JWT token泄露风险（设置合理有效期）
   - 问卷数据包含个人信息（遵守隐私保护法规）
   - 传输加密（HTTPS）
2. **攻击防范**

   - 防止重放攻击（token有效期、timestamp）
   - 防止DDoS攻击（限流、IP白名单）
   - SQL注入防护（参数化查询）

## 十五、总结

本方案通过以下关键设计实现了与第三方问卷系统的深度集成：

1. **标准虚拟Schema**：为问卷类型工具自动生成标准化的6个统计字段，解决了问卷内容在第三方系统而无法获取详细结构的问题，使问卷统计数据能够无缝对接要素系统。
2. **一份问卷 + 多校填报架构**：采用管理员创建全局问卷、为每个学校生成专属访问链接的方案，通过URL参数中的 `schoolId` 识别填报学校，通过JWT token保证安全性，实现了高效的问卷分发和精确的数据归属。
3. **混合身份识别**：结合URL标识和问卷内置身份题，既保证了数据的准确性又便于统计和审计。
4. **详细数据存储 + 本地计算**（核心优势）：

   - **数据完整性**：第三方系统返回每份问卷的详细数据（包括满意度分数），本系统存储到 `survey_responses` 表
   - **灵活性**：满意度判定标准（阈值）可在工具级配置（`satisfaction_config`），支持不同项目设置不同标准
   - **可追溯性**：保留每份问卷的原始数据和分数，满足教育督导评估的审计要求
   - **本地控制**：满意问卷数由本系统根据配置的阈值动态计算，核心业务逻辑由本系统掌控
   - **扩展性**：支持满意度分布分析、趋势分析、阈值调整等高级功能
5. **两层数据架构**：

   - **详细数据层**（`survey_responses`）：存储每份问卷的完整信息，用于审计和分析
   - **汇总缓存层**（`survey_statistics`）：基于详细数据计算的统计汇总，用于快速查询
6. **虚拟数据同步**：通过构建虚拟submission data并复用现有的要素提取和指标计算逻辑，实现了问卷统计数据与表单数据的统一处理，避免了重复开发。
7. **安全可靠对接**：使用JWT token认证、数据验证、事务处理等机制，确保了第三方对接的安全性和数据一致性。

---

## 十六、第三方问卷系统对接功能清单

本章节为第三方问卷系统开发者提供完整的对接功能清单，便于快速了解需要实现的功能和接口。

### 16.1 功能概述

第三方问卷系统需要实现以下核心能力：

1. **接收跳转请求**：接收本系统管理员跳转到第三方系统创建/编辑问卷的请求
2. **问卷管理**：支持问卷的创建、编辑、发布、关闭等操作
3. **问卷入口地址返回**：问卷创建/发布后通过回调返回问卷ID和入口地址
4. **URL参数处理**：解析和处理学校访问链接中的URL参数（projectId、schoolId等）
5. **问卷数据收集**：收集用户填写的问卷数据，并计算总分数
6. **数据回调推送**：将收集到的问卷详细数据推送到本系统的回调接口

### 16.2 必须实现的功能（核心功能）

#### 16.2.1 接收跳转请求

**功能描述**：接收本系统生成的跳转URL，并根据参数执行相应操作。

**入口URL格式**：

```
https://survey-test.f123.pub/
  ?action=create
  &toolId=survey-001
  &toolName=家长满意度调查
  &callback=https://yourdomain.com/api/survey/callback
  &token=JWT_TOKEN
```

**必须处理的参数**：

| 参数         | 说明                       | 必填 | 示例                                       |
| ------------ | -------------------------- | ---- | ------------------------------------------ |
| `action`   | 操作类型：create/edit/view | ✅   | create                                     |
| `toolId`   | 本系统的工具ID             | ✅   | survey-001                                 |
| `toolName` | 问卷名称                   | 推荐 | 家长满意度调查                             |
| `callback` | 回调URL                    | ✅   | https://yourdomain.com/api/survey/callback |
| `token`    | JWT认证token               | ✅   | eyJhbGciOiJIUzI1NiIsInR5cCI6...            |

**行为要求**：

- `action=create`：打开问卷创建页面
- `action=edit`：打开问卷编辑页面（需要已有externalSurveyId）
- `action=view`：打开问卷查看页面（只读）

#### 16.2.2 问卷创建/发布后返回问卷信息

**功能描述**：当管理员完成问卷创建/发布后，立即通过回调接口返回问卷ID和入口地址。

**回调时机**：

- ✅ 问卷创建完成时（推荐）
- ✅ 问卷发布时
- ✅ 窗口关闭前

**回调接口**：

```http
POST {callback}
Content-Type: application/json
Authorization: Bearer {token}

{
  "toolId": "survey-001",
  "externalSurveyId": "survey-global-001",  // 必填：第三方问卷ID
  "externalSurveyUrl": "https://survey-test.f123.pub/survey/survey-global-001",  // 必填：问卷入口地址
  "action": "created",
  "responses": []
}
```

**关键字段**：

- `externalSurveyId`：第三方系统生成的唯一问卷ID
- `externalSurveyUrl`：问卷访问入口地址（完整URL），**必须支持URL参数追加**

#### 16.2.3 处理学校访问链接

**功能描述**：当学校用户通过专属链接访问问卷时，解析URL参数并在问卷中预填充相关信息。

**学校访问URL格式**：

```
https://survey-test.f123.pub/survey/survey-global-001
  ?projectId=proj-001
  &schoolId=school-001
  &schoolName=XX小学
  &districtId=district-001
  &districtName=XX区
  &targetAudience=parent
  &token=JWT_TOKEN
```

**必须处理的参数**：

| 参数               | 说明      | 用途       | 必填 |
| ------------------ | --------- | ---------- | ---- |
| `projectId`      | 项目ID    | 数据归属   | ✅   |
| `schoolId`       | 学校ID    | 数据归属   | ✅   |
| `schoolName`     | 学校名称  | 问卷中显示 | 推荐 |
| `districtId`     | 区县ID    | 数据归属   | 推荐 |
| `districtName`   | 区县名称  | 问卷中显示 | 推荐 |
| `targetAudience` | 目标受众  | 预填充身份 | ✅   |
| `token`          | JWT token | 回调认证   | ✅   |

**行为要求**：

1. 在问卷中显示学校名称（只读）
2. 预填充填报人身份（基于targetAudience，但允许用户修改）
3. 保存这些参数用于回调时传回

#### 16.2.4 问卷数据收集与计算

**功能描述**：收集用户填写的问卷数据，并为每份问卷计算总分数和判定有效性。

**必须实现**：

1. **总分数计算**（`totalScore`）

   - 根据问卷回答计算总分（如5分制的平均分）
   - 支持的计算方法：单题平均分、加权平均、综合评分等
   - 返回浮点数（如4.5、3.8）
2. **有效性判定**（`isValid`）

   - 判定问卷是否有效（答题完整性、逻辑一致性、答题时长等）
   - 返回布尔值（true/false）
3. **身份识别**（`respondentType`）

   - 记录填报人身份：parent/teacher/student/principal/other
   - 可以从targetAudience预填充，但允许用户在问卷中修改
4. **响应ID生成**（`responseId`）

   - 为每份问卷生成唯一ID
   - 建议格式：`{externalSurveyId}-{序号}` 或 UUID

#### 16.2.5 问卷数据回调推送

**功能描述**：将收集到的问卷详细数据推送到本系统的回调接口。

**回调接口**：

```http
POST {callback}
Content-Type: application/json
Authorization: Bearer {token}

{
  "toolId": "survey-001",
  "projectId": "proj-001",
  "schoolId": "school-001",
  "districtId": "district-001",
  "externalSurveyId": "survey-global-001",
  "externalSurveyUrl": "https://survey-test.f123.pub/survey/survey-global-001",
  "targetAudience": "parent",

  "responses": [
    {
      // 上下文标识（必填）
      "projectId": "proj-001",
      "schoolId": "school-001",
      "externalSurveyId": "survey-global-001",

      // 响应标识（必填）
      "responseId": "resp-001",

      // 问卷内容（必填）
      "respondentType": "parent",
      "totalScore": 4.5,
      "isValid": true,
      "submittedAt": "2025-01-15T10:00:00Z",

      // 原始数据（可选）
      "rawData": {
        "q1": 5,
        "q2": 4
      }
    }
  ],

  "summary": {
    "totalSent": 1000,
    "totalResponses": 850
  },

  "collectedAt": "2025-01-15T10:00:00Z"
}
```

**关键要求**：

1. **每个response对象必须包含**：

   - 上下文标识：`projectId`、`schoolId`、`externalSurveyId`
   - 响应标识：`responseId`
   - 问卷内容：`respondentType`、`totalScore`、`isValid`、`submittedAt`
2. **推送时机**：

   - 实时推送（推荐）：每当有新问卷提交时立即回调
   - 定时推送：每小时或每天汇总推送
   - 最终推送：问卷关闭时推送所有数据
3. **推送策略**：

   - 支持增量推送（仅推送新增/更新的问卷）
   - 支持全量推送（推送所有问卷数据）
   - 支持重复调用（本系统会基于responseId去重）

### 16.3 推荐实现的功能（增强功能）

#### 16.3.1 原始数据保存

在response对象中包含 `rawData` 字段，保存完整的问卷回答：

```json
"rawData": {
  "q1_school_satisfaction": 5,
  "q2_teacher_quality": 4,
  "q3_facilities": 4,
  "q4_comment": "整体满意"
}
```

**用途**：用于审计、复核、问题排查

#### 16.3.2 统计汇总

在回调数据中包含 `summary` 字段，提供基础统计汇总：

```json
"summary": {
  "totalSent": 1000,        // 问卷发放总数
  "totalResponses": 850      // 已回收问卷数
}
```

**说明**：仅供参考，本系统会基于responses数组重新计算

#### 16.3.3 错误重试机制

当回调失败时，实现重试机制：

- 4xx错误：记录日志，不重试
- 5xx错误：指数退避重试（最多3次）
- 超时：重试最多3次

### 16.4 数据格式要求

#### 16.4.1 Response对象完整结构

```typescript
interface SurveyResponse {
  // 上下文标识（必填）
  projectId: string;           // 项目ID
  schoolId: string;            // 学校ID
  externalSurveyId: string;    // 问卷ID

  // 响应标识（必填）
  responseId: string;          // 响应ID（全局唯一）

  // 问卷内容（必填）
  respondentType: 'parent' | 'teacher' | 'student' | 'principal' | 'other';
  totalScore: number;          // 总分数（≥0的浮点数）
  isValid: boolean;            // 是否有效问卷
  submittedAt: string;         // 提交时间（ISO 8601格式）

  // 原始数据（可选）
  rawData?: Record<string, any>;
}
```

#### 16.4.2 数据验证规则

```javascript
function validateResponse(response) {
  // 1. 上下文标识验证
  if (!response.projectId || !response.schoolId || !response.externalSurveyId) {
    throw new Error('缺少必填的上下文标识字段');
  }

  // 2. 响应ID验证
  if (!response.responseId) {
    throw new Error('缺少responseId');
  }

  // 3. 填报人身份验证
  const validTypes = ['parent', 'teacher', 'student', 'principal', 'other'];
  if (!validTypes.includes(response.respondentType)) {
    throw new Error('respondentType必须是parent/teacher/student/principal/other之一');
  }

  // 4. 总分数验证
  if (typeof response.totalScore !== 'number' || response.totalScore < 0) {
    throw new Error('totalScore必须是非负数');
  }

  // 5. 有效性验证
  if (typeof response.isValid !== 'boolean') {
    throw new Error('isValid必须是布尔值');
  }

  // 6. 提交时间验证（推荐）
  if (response.submittedAt && !isValidISO8601(response.submittedAt)) {
    throw new Error('submittedAt必须是ISO 8601格式');
  }

  return true;
}
```

### 16.5 时序说明

#### 16.5.1 管理员创建问卷流程

```
┌─────────────┐                    ┌──────────────┐                    ┌──────────────┐
│ 本系统      │                    │ 第三方系统   │                    │ 回调接口     │
└──────┬──────┘                    └──────┬───────┘                    └──────┬───────┘
       │                                   │                                   │
       │ 1. 生成跳转URL（带token）         │                                   │
       ├──────────────────────────────────>│                                   │
       │                                   │                                   │
       │                                   │ 2. 管理员创建/发布问卷            │
       │                                   │                                   │
       │                                   │ 3. 回调返回问卷ID和入口地址       │
       │                                   ├──────────────────────────────────>│
       │                                   │                                   │
       │ 4. 保存问卷ID和入口地址到工具     │<──────────────────────────────────┤
       │<──────────────────────────────────┤                                   │
       │                                   │                                   │
```

#### 16.5.2 学校用户填写问卷流程

```
┌─────────────┐                    ┌──────────────┐                    ┌──────────────┐
│ 本系统      │                    │ 第三方系统   │                    │ 回调接口     │
└──────┬──────┘                    └──────┬───────┘                    └──────┬───────┘
       │                                   │                                   │
       │ 1. 生成学校访问链接               │                                   │
       │   (带projectId/schoolId/token)    │                                   │
       │                                   │                                   │
       │                                   │ 2. 学校用户通过链接访问问卷       │
       │                                   │                                   │
       │                                   │ 3. 解析URL参数，预填充学校信息    │
       │                                   │                                   │
       │                                   │ 4. 用户填写并提交问卷             │
       │                                   │                                   │
       │                                   │ 5. 计算totalScore和isValid        │
       │                                   │                                   │
       │                                   │ 6. 回调推送问卷数据               │
       │                                   ├──────────────────────────────────>│
       │                                   │                                   │
       │ 7. 保存问卷数据并计算指标         │<──────────────────────────────────┤
       │<──────────────────────────────────┤                                   │
       │                                   │                                   │
```

### 16.6 快速对接检查清单

使用此清单确保所有功能都已实现：

#### ✅ 基础功能

- [ ] 能够接收并解析本系统的跳转URL参数
- [ ] 支持create/edit/view三种操作模式
- [ ] 问卷创建/发布后能够自动回调返回externalSurveyId和externalSurveyUrl
- [ ] 生成的问卷入口地址支持URL参数追加（?key=value&...）

#### ✅ 学校访问功能

- [ ] 能够解析学校访问链接中的URL参数（projectId、schoolId、targetAudience等）
- [ ] 在问卷中显示学校名称（只读）
- [ ] 根据targetAudience预填充填报人身份（允许用户修改）
- [ ] 保存URL参数用于回调时传回

#### ✅ 数据收集功能

- [ ] 为每份问卷生成唯一的responseId
- [ ] 计算每份问卷的totalScore（浮点数）
- [ ] 判定每份问卷的isValid（布尔值）
- [ ] 记录填报人身份respondentType
- [ ] 记录提交时间submittedAt（ISO 8601格式）

#### ✅ 数据推送功能

- [ ] 能够调用本系统的回调接口推送问卷数据
- [ ] 每个response对象包含projectId、schoolId、externalSurveyId
- [ ] 每个response对象包含responseId、respondentType、totalScore、isValid、submittedAt
- [ ] 回调时携带Authorization头（Bearer token）
- [ ] 支持重复推送（幂等性）

#### ✅ 安全功能

- [ ] 验证JWT token的有效性
- [ ] 使用HTTPS传输数据
- [ ] 保护用户隐私数据

#### ✅ 可靠性功能

- [ ] 回调失败时有重试机制
- [ ] 记录详细的日志（请求、响应、错误）
- [ ] 处理网络超时和异常情况

### 16.7 测试建议

#### 16.7.1 功能测试

1. **跳转测试**

   - 测试action=create/edit/view三种模式
   - 验证参数解析正确性
   - 验证JWT token验证
2. **问卷创建测试**

   - 创建问卷并验证是否触发回调
   - 验证返回的externalSurveyId和externalSurveyUrl
   - 验证入口地址可以追加URL参数
3. **学校访问测试**

   - 使用带参数的URL访问问卷
   - 验证学校信息预填充
   - 验证身份预填充和修改
4. **数据收集测试**

   - 提交多份问卷
   - 验证responseId唯一性
   - 验证totalScore计算正确性
   - 验证isValid判定逻辑
5. **数据推送测试**

   - 验证回调触发时机
   - 验证数据格式完整性
   - 验证重复推送的幂等性
   - 验证回调失败重试机制

#### 16.7.2 集成测试

搭建完整的测试环境：

1. **本系统模拟器**

   - 模拟生成跳转URL
   - 提供回调接口接收数据
   - 验证数据格式和完整性
2. **第三方系统**

   - 实现所有对接功能
   - 记录详细日志
3. **测试场景**

   - 完整走通管理员创建问卷流程
   - 完整走通学校用户填写问卷流程
   - 测试边界情况和异常情况

### 16.8 常见问题（FAQ）

#### Q1: externalSurveyUrl必须是什么格式？

**A**: 必须是完整的URL（含协议和域名），例如：

```
✅ https://survey-test.f123.pub/survey/survey-global-001
❌ /survey/survey-global-001
❌ survey-global-001
```

#### Q2: response对象中的projectId/schoolId/externalSurveyId为什么要冗余？

**A**: 外层也有这些字段，但每个response对象内部也必须包含，原因：

- 数据完整性：每个response对象都是自包含的
- 灵活性：支持批量推送多个学校/项目的数据
- 容错性：即使外层信息丢失，response仍能正确归属

#### Q3: totalScore的计算方法是什么？

**A**: 由第三方系统自行定义，常见方法：

- 单题平均分：所有满意度题目的平均分
- 加权平均：根据题目权重计算
- 综合评分：基于多个维度的算法

本系统不关心具体算法，只需要返回最终分数即可。

#### Q4: 回调推送的频率如何控制？

**A**: 推荐策略：

- 实时推送（推荐）：每有新问卷提交立即回调
- 定时推送：每小时或每天汇总推送
- 最终推送：问卷关闭时推送所有数据

支持重复推送，本系统会基于responseId去重。

#### Q5: 如果回调失败怎么办？

**A**: 实现重试机制：

- 4xx错误：记录日志，不重试
- 5xx错误：指数退避重试（最多3次）
- 超时：重试最多3次

同时提供管理后台供管理员手动重新推送数据。

#### Q6: 是否需要按身份分类统计数据？

**A**: 不需要。第三方系统只需返回每份问卷的详细数据（包含respondentType字段），本系统会自动按身份分类统计。

#### Q7: 是否需要计算满意问卷数？

**A**: 不需要。第三方系统只需返回每份问卷的totalScore，本系统会根据配置的阈值（如≥4.0）判定是否满意。

---
