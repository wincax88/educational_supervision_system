# 填报任务分配与审核配置实现方案

## 一、需求分析

### 1.1 核心需求

在优质均衡评估项目配置中，目前已实现：
- ✅ 指标体系配置
- ✅ 采集工具配置
- ✅ 填报学校配置
- ✅ 填报账号配置

**待实现功能**：

1. **填报任务分配**：将填报任务分配给填报账号
2. **审核配置**：可以设置填报是否需要审核
3. **区县管理员权限**：区县管理账号可以填报辖区内的全部学校

### 1.2 功能目标

1. **任务分配机制**
   - 支持将采集工具分配给填报账号
   - 支持批量分配任务
   - 支持按学校/区县分配任务
   - 支持区县管理员填报辖区内所有学校

2. **审核配置**
   - 项目级别：设置项目是否需要审核
   - 工具级别：设置特定工具是否需要审核
   - 审核流程：草稿 → 提交 → 审核（可选）→ 通过/驳回

3. **区县管理员权限**
   - 区县管理员可以看到辖区内所有学校的任务
   - 区县管理员可以为辖区内所有学校填报数据
   - 支持批量填报功能

---

## 二、数据模型设计

### 2.1 数据库表扩展

#### 2.1.1 项目审核配置表（新增）

```sql
CREATE TABLE IF NOT EXISTS project_review_config (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,              -- 关联 projects.id
  tool_id TEXT,                          -- 可选：NULL表示项目级别配置，否则为工具级别配置
  requires_review INTEGER DEFAULT 1,      -- 是否需要审核：1=需要，0=不需要
  auto_approve INTEGER DEFAULT 0,        -- 是否自动通过：1=自动通过，0=需要人工审核
  created_at TEXT,
  updated_at TEXT,
  UNIQUE(project_id, tool_id)            -- 同一项目下，每个工具只能有一条配置
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_project_review_config_project 
  ON project_review_config(project_id);
CREATE INDEX IF NOT EXISTS idx_project_review_config_tool 
  ON project_review_config(tool_id);
```

**配置优先级**：
- 工具级别配置 > 项目级别配置
- 如果工具没有配置，则使用项目级别配置

#### 2.1.2 任务表扩展（修改现有表）

在现有 `tasks` 表基础上，需要确保以下字段支持：

```sql
-- tasks 表已存在，需要确保以下字段：
-- target_type: 'district' | 'school' | 'all'
-- target_id: 区县ID或学校ID
-- assignee_id: 填报账号ID（关联 project_personnel.id）

-- 新增字段（可选，用于支持区县管理员填报多个学校）：
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS district_id TEXT;  -- 区县ID（用于区县管理员）
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS school_ids TEXT;   -- 学校ID列表（JSON格式，用于区县管理员）

-- 索引
CREATE INDEX IF NOT EXISTS idx_tasks_district ON tasks(district_id);
```

#### 2.1.3 填报记录表扩展（修改现有表）

在现有 `submissions` 表基础上，需要确保以下字段：

```sql
-- submissions 表已存在，需要确保以下字段：
-- status: 'draft' | 'submitted' | 'approved' | 'rejected'
-- reviewed_at: 审核时间
-- reviewed_by: 审核人ID

-- 如果不存在，需要添加：
ALTER TABLE submissions ADD COLUMN IF NOT EXISTS reviewed_by TEXT;
ALTER TABLE submissions ADD COLUMN IF NOT EXISTS review_comment TEXT;
```

### 2.2 数据关系图

```
项目 (projects)
  ├── 项目审核配置 (project_review_config)  ← 新增
  │     ├── 项目级别配置（tool_id = NULL）
  │     └── 工具级别配置（tool_id = 工具ID）
  │
  ├── 项目人员 (project_personnel)
  │     ├── 区县管理员 (district_admin)
  │     ├── 区县填报员 (district_reporter)
  │     └── 学校填报员 (school_reporter)
  │
  ├── 项目工具 (project_tools)
  │     └── 采集工具 (data_tools)
  │
  ├── 任务 (tasks)
  │     ├── assignee_id: 填报账号ID
  │     ├── target_type: 'district' | 'school' | 'all'
  │     ├── target_id: 学校ID或区县ID
  │     └── district_id: 区县ID（区县管理员专用）
  │
  └── 填报记录 (submissions)
        ├── status: 状态（受审核配置影响）
        └── reviewed_by: 审核人
```

---

## 三、后端API设计

### 3.1 任务分配API（扩展现有API）

#### 3.1.1 批量分配任务（支持区县管理员）

```javascript
POST /api/projects/:projectId/tasks/batch
```

**请求体扩展**：
```json
{
  "toolId": "tool-001",
  "assigneeIds": ["person-001", "person-002"],
  "targetType": "school",           // 'district' | 'school' | 'all'
  "targetIds": ["school-001"],       // 学校ID列表（可选）
  "districtId": "district-001",      // 区县ID（区县管理员专用，可选）
  "dueDate": "2024-12-31"
}
```

**分配逻辑**：
- 如果 `targetType = 'school'` 且指定了 `targetIds`，则为每个学校创建任务
- 如果 `targetType = 'district'` 且指定了 `districtId`，则为区县管理员创建可填报辖区内所有学校的任务
- 如果 `assigneeId` 对应的角色是 `district_admin`，自动设置 `district_id`

#### 3.1.2 为区县管理员分配任务（新增）

```javascript
POST /api/projects/:projectId/tasks/district-admin
```

**功能**：为区县管理员分配可以填报辖区内所有学校的任务

**请求体**：
```json
{
  "toolId": "tool-001",
  "districtAdminId": "person-001",   // 区县管理员ID
  "districtId": "district-001",      // 区县ID
  "dueDate": "2024-12-31"
}
```

**响应**：
```json
{
  "code": 200,
  "data": {
    "taskId": "task-001",
    "schoolCount": 15,                // 辖区内学校数量
    "message": "已为区县管理员分配任务，可填报15所学校"
  }
}
```

### 3.2 审核配置API（新增）

#### 3.2.1 获取项目审核配置

```javascript
GET /api/projects/:projectId/review-config
```

**查询参数**：
- `toolId` (可选)：获取特定工具的配置

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "projectId": "proj-001",
    "projectLevel": {
      "requiresReview": true,
      "autoApprove": false
    },
    "toolLevel": [
      {
        "toolId": "tool-001",
        "toolName": "学校基础数据采集表",
        "requiresReview": false,
        "autoApprove": true
      }
    ]
  }
}
```

#### 3.2.2 设置项目审核配置

```javascript
POST /api/projects/:projectId/review-config
```

**请求体**：
```json
{
  "toolId": null,                    // null表示项目级别配置
  "requiresReview": true,            // 是否需要审核
  "autoApprove": false               // 是否自动通过
}
```

#### 3.2.3 设置工具审核配置

```javascript
POST /api/projects/:projectId/review-config
```

**请求体**：
```json
{
  "toolId": "tool-001",              // 工具ID
  "requiresReview": false,            // 不需要审核
  "autoApprove": true                 // 自动通过
}
```

#### 3.2.4 删除审核配置

```javascript
DELETE /api/projects/:projectId/review-config/:id
```

### 3.3 填报提交API（修改现有API）

#### 3.3.1 提交填报（扩展）

```javascript
POST /api/submissions
```

**提交逻辑修改**：
1. 检查项目的审核配置（工具级别 > 项目级别）
2. 如果 `requiresReview = false` 或 `autoApprove = true`：
   - 直接设置为 `approved` 状态
   - 自动同步指标数据
3. 如果 `requiresReview = true` 且 `autoApprove = false`：
   - 设置为 `submitted` 状态
   - 等待审核

**请求体**：
```json
{
  "projectId": "proj-001",
  "toolId": "tool-001",
  "schoolId": "school-001",          // 学校ID（区县管理员填报时指定）
  "data": { /* 表单数据 */ }
}
```

### 3.4 区县管理员相关API（新增）

#### 3.4.1 获取区县管理员可填报的学校列表

```javascript
GET /api/projects/:projectId/district-admin/schools
```

**查询参数**：
- `districtId`: 区县ID
- `toolId`: 工具ID（可选）

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "districtId": "district-001",
    "districtName": "铁西区",
    "schools": [
      {
        "id": "school-001",
        "name": "XX小学",
        "hasTask": true,             // 是否有任务
        "hasSubmission": false,        // 是否已填报
        "submissionStatus": null       // 填报状态
      }
    ]
  }
}
```

#### 3.4.2 区县管理员批量填报

```javascript
POST /api/submissions/batch
```

**请求体**：
```json
{
  "projectId": "proj-001",
  "toolId": "tool-001",
  "schoolIds": ["school-001", "school-002"],  // 学校ID列表
  "data": { /* 表单数据（所有学校共用） */ }
}
```

---

## 四、前端界面设计

### 4.1 任务分配界面（扩展现有界面）

在 `TaskAssignmentTab.tsx` 中扩展功能：

#### 4.1.1 分配任务弹窗扩展

```
┌─────────────────────────────────────────┐
│  分配采集任务                            │
├─────────────────────────────────────────┤
│  采集工具: [下拉选择]                    │
│                                         │
│  分配方式: ○ 按人员分配                  │
│           ○ 按学校分配                   │
│           ○ 按区县分配（区县管理员）     │
│                                         │
│  [根据选择显示不同的表单]                │
│                                         │
│  按人员分配:                            │
│    数据采集员: [多选下拉]                │
│    目标学校: [多选下拉，可选]            │
│                                         │
│  按学校分配:                            │
│    目标学校: [多选下拉]                  │
│    数据采集员: [多选下拉]                │
│                                         │
│  按区县分配:                            │
│    区县: [下拉选择]                      │
│    区县管理员: [下拉选择]                │
│    [提示：将为该区县管理员分配辖区内     │
│     所有学校的填报任务]                  │
│                                         │
│  截止日期: [日期选择器]                  │
│                                         │
│  [取消]  [确认分配]                     │
└─────────────────────────────────────────┘
```

#### 4.1.2 任务列表扩展

在任务列表中增加列：
- **目标范围**：显示任务的目标（学校名称/区县名称/全部）
- **任务类型**：显示是普通任务还是区县管理员任务

### 4.2 审核配置界面（新增）

在项目配置页面新增"审核配置"Tab：

```
┌─────────────────────────────────────────┐
│  审核配置                                │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │ 项目级别配置                        │ │
│  │                                     │ │
│  │  ☑ 需要审核                        │ │
│  │  ☐ 自动通过（提交后自动审核通过）   │ │
│  │                                     │ │
│  │  [保存配置]                         │ │
│  └───────────────────────────────────┘ │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │ 工具级别配置                        │ │
│  │                                     │ │
│  │  [工具列表]                         │ │
│  │  ┌─────────────────────────────┐   │ │
│  │  │ 学校基础数据采集表           │   │ │
│  │  │ ☑ 需要审核                   │   │ │
│  │  │ ☐ 自动通过                   │   │ │
│  │  │ [编辑]                       │   │ │
│  │  └─────────────────────────────┘   │ │
│  │  ┌─────────────────────────────┐   │ │
│  │  │ 教师专业发展数据表           │   │ │
│  │  │ ☐ 需要审核（使用项目配置）   │   │ │
│  │  │ ☐ 自动通过                   │   │ │
│  │  │ [编辑]                       │   │ │
│  │  └─────────────────────────────┘   │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 4.3 区县管理员填报界面（新增）

在区县管理员工作台中，新增"批量填报"功能：

```
┌─────────────────────────────────────────┐
│  区县数据填报                            │
├─────────────────────────────────────────┤
│  项目: [下拉选择]                        │
│  采集工具: [下拉选择]                    │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │ 学校列表（辖区内）                  │ │
│  │                                     │ │
│  │  ☑ 全选                            │ │
│  │  ┌─────────────────────────────┐   │ │
│  │  │ ☑ XX小学      [已填报]        │   │ │
│  │  │ ☑ YY小学      [未填报]        │   │ │
│  │  │ ☐ ZZ小学      [未填报]        │   │ │
│  │  └─────────────────────────────┘   │ │
│  │                                     │ │
│  │  已选择: 2 所学校                   │ │
│  └───────────────────────────────────┘ │
│                                         │
│  [表单区域]                              │
│  （所有选中的学校共用同一份表单数据）    │
│                                         │
│  [保存草稿]  [提交填报]                 │
└─────────────────────────────────────────┘
```

---

## 五、业务逻辑设计

### 5.1 任务分配逻辑

#### 5.1.1 普通任务分配

```
1. 选择采集工具
2. 选择填报账号（学校填报员）
3. 选择目标学校（可选，不选则分配给该账号关联的所有学校）
4. 设置截止日期
5. 创建任务记录
```

#### 5.1.2 区县管理员任务分配

```
1. 选择采集工具
2. 选择区县管理员账号
3. 系统自动查询该区县管理员关联的区县
4. 查询该区县下所有学校
5. 为每个学校创建任务（或创建一个"全部学校"的任务）
6. 设置 district_id 字段，标记为区县管理员任务
```

### 5.2 审核流程逻辑

#### 5.2.1 审核配置检查

```
提交填报时：
1. 查询工具级别的审核配置
   - 如果存在，使用工具级别配置
   - 如果不存在，查询项目级别配置
2. 根据配置决定后续流程：
   - requiresReview = false → 直接设置为 approved
   - requiresReview = true && autoApprove = true → 设置为 approved
   - requiresReview = true && autoApprove = false → 设置为 submitted（等待审核）
```

#### 5.2.2 自动审核逻辑

```
如果 autoApprove = true：
1. 提交时自动设置为 approved 状态
2. 自动同步指标数据到 school_indicator_data
3. 更新关联任务状态为 completed
4. 记录审核信息（reviewed_by = 'system', reviewed_at = 当前时间）
```

### 5.3 区县管理员填报逻辑

#### 5.3.1 权限验证

```
区县管理员登录后：
1. 获取用户关联的区县ID（从 user.scopes 或 project_personnel.organization）
2. 查询该区县下所有学校
3. 只显示该区县范围内的任务和学校
```

#### 5.3.2 批量填报流程

```
1. 区县管理员选择项目、工具
2. 系统显示辖区内所有学校列表
3. 管理员选择要填报的学校（可多选）
4. 填写表单数据（所有选中学校共用）
5. 提交时：
   - 为每个选中的学校创建一条 submission 记录
   - 如果配置了自动审核，自动审核通过
   - 更新对应任务状态
```

---

## 六、实现步骤

### 6.1 数据库层

1. **创建审核配置表**
   - 创建 `project_review_config` 表
   - 创建必要的索引

2. **扩展任务表**
   - 添加 `district_id` 字段（如果不存在）
   - 添加 `school_ids` 字段（可选，用于存储多个学校ID）

3. **扩展填报记录表**
   - 确保 `reviewed_by` 字段存在
   - 确保 `review_comment` 字段存在

### 6.2 后端层

1. **扩展任务分配API**
   - 修改 `POST /api/projects/:projectId/tasks/batch`
   - 新增 `POST /api/projects/:projectId/tasks/district-admin`
   - 支持区县管理员任务分配逻辑

2. **新增审核配置API**
   - `GET /api/projects/:projectId/review-config`
   - `POST /api/projects/:projectId/review-config`
   - `DELETE /api/projects/:projectId/review-config/:id`

3. **修改填报提交API**
   - 修改 `POST /api/submissions`
   - 添加审核配置检查逻辑
   - 实现自动审核功能

4. **新增区县管理员API**
   - `GET /api/projects/:projectId/district-admin/schools`
   - `POST /api/submissions/batch`

### 6.3 前端层

1. **扩展任务分配界面**
   - 修改 `TaskAssignmentTab.tsx`
   - 添加分配方式选择（按人员/按学校/按区县）
   - 添加区县管理员任务分配功能

2. **新增审核配置界面**
   - 创建 `ReviewConfigTab.tsx` 组件
   - 实现项目级别和工具级别配置
   - 集成到项目配置页面

3. **新增区县管理员填报界面**
   - 创建 `DistrictAdminEntry.tsx` 组件
   - 实现批量学校选择和填报功能
   - 集成到区县管理员工作台

### 6.4 测试与优化

1. **功能测试**
   - 测试任务分配功能（普通/区县管理员）
   - 测试审核配置功能
   - 测试自动审核流程
   - 测试区县管理员批量填报

2. **权限测试**
   - 验证区县管理员只能看到辖区内学校
   - 验证任务分配权限控制

3. **性能优化**
   - 批量操作的事务处理
   - 大数据量下的查询优化

---

## 七、注意事项

### 7.1 数据一致性

- **删除任务时**：需要检查是否有关联的填报记录
- **删除审核配置时**：需要考虑是否影响已提交的填报记录
- **区县管理员任务**：需要确保 district_id 和 target_id 的一致性

### 7.2 权限控制

- **任务分配权限**：只有项目管理员可以分配任务
- **审核权限**：只有专家或管理员可以审核
- **区县管理员权限**：只能看到和操作辖区内学校

### 7.3 审核流程

- **自动审核**：需要记录审核人为 'system'
- **审核配置变更**：只影响新提交的填报，不影响已提交的
- **审核历史**：需要保留审核记录和审核意见

### 7.4 区县管理员特殊处理

- **任务显示**：区县管理员看到的是"可填报辖区内所有学校"的任务
- **填报方式**：支持单个学校填报，也支持批量填报
- **数据隔离**：确保区县管理员只能看到自己区县的数据

---

## 八、扩展功能（可选）

### 8.1 审核工作流

支持多级审核（初审、复审、终审）。

### 8.2 审核提醒

提交后自动通知审核人员。

### 8.3 审核统计

统计审核通过率、平均审核时间等指标。

### 8.4 批量审核

支持批量通过/驳回功能。

---

## 九、总结

本方案提供了完整的"填报任务分配与审核配置"功能实现路径，包括：

1. ✅ **任务分配机制**：支持普通分配和区县管理员分配
2. ✅ **审核配置**：项目级别和工具级别的灵活配置
3. ✅ **自动审核**：支持不需要审核或自动通过的场景
4. ✅ **区县管理员权限**：支持区县管理员填报辖区内所有学校
5. ✅ **批量填报**：支持区县管理员批量填报功能

该方案与现有系统架构保持一致，可以无缝集成到项目中，为项目配置和填报流程提供更灵活的控制能力。

