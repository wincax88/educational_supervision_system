# 第三方问卷系统集成实现说明

## 一、已完成功能概览

### 1.1 数据库设计 ✅

已创建数据库迁移文件：[backend/database/add-survey-integration.sql](../../backend/database/add-survey-integration.sql)

包含以下表结构：

1. **扩展 data_tools 表**
   - `external_survey_id`: 第三方问卷系统的问卷ID
   - `external_survey_url`: 第三方问卷系统的问卷链接
   - `satisfaction_config`: 满意度判定配置（JSONB）

2. **survey_responses 表** - 问卷响应详细记录表
   - 存储每份问卷的详细数据
   - 包括填报人身份、总分数、有效性等
   - 支持原始数据存储（raw_data）

3. **survey_statistics 表** - 问卷统计汇总表
   - 基于 survey_responses 计算的统计数据
   - 包括发放数、回收数、满意度等统计字段
   - 支持手动录入和第三方系统推送

4. **survey_access_links 表** - 问卷访问链接记录表
   - 记录为每个学校生成的问卷访问链接
   - 支持不同目标受众（家长/教师/学生/校长）
   - 支持链接过期管理和访问统计

### 1.2 后端API实现 ✅

已创建路由文件：[backend/routes/survey.js](../../backend/routes/survey.js)

实现的API接口：

#### 1. 管理员创建问卷跳转链接
```http
POST /api/tools/:id/create-survey
Content-Type: application/json

{
  "action": "create" | "edit" | "view"
}
```

**功能**：生成跳转到第三方问卷系统的URL，用于创建、编辑或查看问卷。

#### 2. 批量生成学校访问链接
```http
POST /api/tools/:id/generate-access-links
Content-Type: application/json

{
  "projectId": "proj-001",
  "schoolIds": ["school-001", "school-002"],
  "targetAudience": "parent",
  "linkType": "url",
  "expiresIn": 7776000
}
```

**功能**：为项目中的所有学校或指定学校批量生成访问链接。

#### 3. 接收第三方回调数据
```http
POST /api/survey/callback
Content-Type: application/json
Authorization: Bearer JWT_TOKEN

{
  "toolId": "survey-001",
  "projectId": "proj-001",
  "schoolId": "school-001",
  "responses": [...],
  "action": "created" | "published"
}
```

**功能**：接收第三方系统的问卷数据回调，包括问卷创建通知和数据同步。

#### 4. 更新工具的第三方问卷信息
```http
PUT /api/tools/:id/survey-info
Content-Type: application/json

{
  "externalSurveyId": "xxx",
  "externalSurveyUrl": "https://..."
}
```

#### 5. 查询问卷统计数据
```http
GET /api/survey/statistics
Query Parameters:
  - toolId: 工具ID（必填）
  - projectId: 项目ID（可选）
  - schoolId: 学校ID（可选）
  - districtId: 区县ID（可选）
```

### 1.3 问卷指标同步服务 ✅

已创建服务文件：[backend/services/surveySync.js](../../backend/services/surveySync.js)

**核心功能**：
- 从 survey_statistics 表读取统计数据
- 构建虚拟的 submission data
- 读取字段映射（field_mappings）
- 提取基础要素值
- 计算派生要素
- 查找关联的数据指标
- 写入/更新 school_indicator_data 表

### 1.4 工具函数 ✅

已创建工具函数文件：[backend/utils/helpers.js](../../backend/utils/helpers.js)

提供的函数：
- `generateId()`: 生成唯一ID
- `now()`: 获取当前日期（YYYY-MM-DD）
- `nowISO()`: 获取当前时间戳（ISO格式）

## 二、使用说明

### 2.1 数据库迁移

执行以下SQL脚本以创建必要的表结构：

```bash
psql -U postgres -d your_database -f backend/database/add-survey-integration.sql
```

或在PostgreSQL客户端中直接执行该文件。

### 2.2 环境变量配置

在 `.env` 文件中添加以下配置：

```bash
# 第三方问卷系统基础URL
SURVEY_BASE_URL=https://survey-test.f123.pub

# 本系统基础URL（用于回调）
APP_BASE_URL=https://yourdomain.com

# JWT密钥（用于签名访问令牌）
JWT_SECRET=your-secret-key-change-in-production
```

### 2.3 创建问卷类型工具

1. 在工具库中创建"问卷"类型的采集工具
2. 系统会自动为其生成标准Schema（包含6个统计字段）
3. 点击"跳转到问卷系统"按钮，在新窗口打开第三方问卷系统
4. 在第三方系统中完成问卷的创建、编辑、发布
5. 第三方系统通过回调接口返回问卷ID和问卷入口地址
6. 本系统保存问卷ID和入口地址到工具信息

### 2.4 在项目中使用问卷工具

1. 在项目中选择使用该问卷工具
2. 调用"批量生成学校访问链接"接口，为每个学校生成专属链接
3. 将链接分发给各学校（支持直接URL、二维码等方式）
4. 学校用户通过专属链接访问问卷并填写
5. 第三方系统通过回调接口将问卷数据推送到本系统
6. 本系统自动计算统计数据并同步到指标系统

### 2.5 问卷工具的标准Schema

当创建类型为"问卷"的工具时，系统自动为其生成包含以下6个标准统计字段的schema：

1. `respondent_type` - 填报人身份（parent/teacher/student/principal/other）
2. `school_id` - 学校ID（隐藏字段，从URL参数获取）
3. `school_name` - 所属学校（只读显示）
4. `total_sent` - 问卷总数/发放总数
5. `total_sent_to_parents` - 发给家长的数量
6. `total_valid` - 回收有效问卷数
7. `total_valid_from_parents` - 家长有效问卷数
8. `total_satisfied` - 满意问卷数
9. `total_satisfied_from_parents` - 家长满意问卷数

这些字段可以通过 `field_mappings` 表映射到要素系统，从而实现问卷数据与指标系统的集成。

### 2.6 满意度配置

在 data_tools 表的 `satisfaction_config` 字段中配置满意度判定规则：

```json
{
  "scale": 5,
  "minScore": 4.0,
  "calculationMethod": "threshold"
}
```

**字段说明**：
- `scale`: 评分量表（5分制/10分制）
- `minScore`: 满意的最低分数
- `calculationMethod`: 计算方法（threshold=阈值判定 / average=平均分）

**默认配置**：如果未配置，默认使用 `{"scale": 5, "minScore": 4.0, "calculationMethod": "threshold"}`

## 三、数据流程

### 3.1 问卷创建流程

```
1. 管理员在工具库创建"问卷"类型工具
   ↓
2. 调用 POST /api/tools/:id/create-survey 生成跳转URL
   ↓
3. 在新窗口打开第三方问卷系统
   ↓
4. 管理员在第三方系统中完成问卷创建/发布
   ↓
5. 第三方系统回调 POST /api/survey/callback（首次回调）
   - action: "created" 或 "published"
   - 返回 externalSurveyId 和 externalSurveyUrl
   ↓
6. 本系统保存问卷ID和入口地址到 data_tools 表
```

### 3.2 问卷分发流程

```
1. 管理员在项目中选择使用该问卷工具
   ↓
2. 调用 POST /api/tools/:id/generate-access-links
   - 指定 projectId 和 targetAudience
   - 可选择特定学校或全部学校
   ↓
3. 系统为每个学校生成带JWT Token的访问链接
   - URL包含：projectId, schoolId, targetAudience, token
   ↓
4. 管理员将链接分发给各学校
```

### 3.3 数据同步流程

```
1. 学校用户通过专属链接访问并填写问卷
   ↓
2. 第三方系统定期或实时回调 POST /api/survey/callback
   - 推送 responses 数组（每份问卷的详细数据）
   ↓
3. 本系统处理回调数据：
   a. 验证JWT Token
   b. 存储到 survey_responses 表
   c. 计算统计汇总
   d. 更新 survey_statistics 表
   e. 调用 syncSurveyIndicators() 同步到指标系统
   ↓
4. 同步到指标系统：
   a. 构建虚拟 submission data
   b. 读取字段映射
   c. 提取基础要素值
   d. 计算派生要素
   e. 写入 school_indicator_data 表
```

## 四、第三方系统对接要求

### 4.1 接收跳转请求

第三方系统需要能够接收并解析本系统生成的URL参数：

**URL格式**：
```
https://survey-test.f123.pub/
  ?action=create
  &toolId=survey-001
  &toolName=家长满意度调查
  &callback=https://yourdomain.com/api/survey/callback
  &token=JWT_TOKEN
```

**必须处理的参数**：
- `action`: 操作类型（create/edit/view）
- `toolId`: 本系统的工具ID
- `toolName`: 问卷名称
- `callback`: 回调URL
- `token`: JWT认证token

### 4.2 问卷创建后回调

当管理员完成问卷创建/发布后，第三方系统**必须**回调本系统：

```http
POST https://yourdomain.com/api/survey/callback
Content-Type: application/json
Authorization: Bearer {token}

{
  "toolId": "{从URL获取的toolId}",
  "externalSurveyId": "survey-global-001",
  "externalSurveyUrl": "https://survey-test.f123.pub/survey/survey-global-001",
  "action": "created",
  "responses": []
}
```

**关键字段**：
- `externalSurveyId`: 第三方系统生成的问卷ID（必填）
- `externalSurveyUrl`: 问卷入口地址（必填）

### 4.3 问卷数据同步回调

当学校用户填写问卷后，第三方系统定期或实时推送数据：

```http
POST https://yourdomain.com/api/survey/callback
Content-Type: application/json
Authorization: Bearer {token}

{
  "toolId": "survey-001",
  "projectId": "proj-001",
  "schoolId": "school-001",
  "districtId": "district-001",
  "externalSurveyId": "survey-global-001",
  "responses": [
    {
      "projectId": "proj-001",
      "schoolId": "school-001",
      "externalSurveyId": "survey-global-001",
      "responseId": "resp-001",
      "respondentType": "parent",
      "totalScore": 4.5,
      "isValid": true,
      "submittedAt": "2025-01-15T10:00:00Z",
      "rawData": {...}
    }
  ],
  "summary": {
    "totalSent": 1000
  },
  "collectedAt": "2025-01-15T10:00:00Z"
}
```

**第三方系统职责**：
- ✅ 收集问卷响应数据
- ✅ 为每份问卷计算总分数（`totalScore`）
- ✅ 判定问卷有效性（`isValid`）
- ✅ 记录填报人身份（`respondentType`）
- ✅ 通过回调接口返回详细的问卷数据数组

**本系统职责**：
- ✅ 根据配置的阈值判定满意度（`total_satisfied`）
- ✅ 按身份分类统计
- ✅ 同步到指标系统

## 五、安全性说明

### 5.1 JWT Token验证

所有回调请求必须在 `Authorization` 头中携带有效的JWT Token：

```
Authorization: Bearer {JWT_TOKEN}
```

Token包含以下信息：
- `toolId`: 工具ID
- `projectId`: 项目ID（学校访问时）
- `schoolId`: 学校ID（学校访问时）
- `targetAudience`: 目标受众
- `exp`: 过期时间

### 5.2 数据验证

回调接口会验证：
1. JWT Token的有效性和签名
2. Token与请求body的一致性
3. 学校存在性及区县匹配
4. 问卷响应数据的合法性

### 5.3 事务处理

所有数据操作都在数据库事务中进行，确保数据一致性：
- 存储问卷响应 → 计算统计 → 更新汇总表 → 同步指标
- 任何步骤失败都会回滚整个事务

## 六、待实现功能

### 6.1 前端功能
- [ ] 工具库页面增强（显示问卷操作按钮）
- [ ] 批量生成问卷链接界面
- [ ] 问卷统计展示页面
- [ ] 二维码生成功能
- [ ] 短链接生成功能

### 6.2 后端功能增强
- [ ] 手动录入问卷统计数据接口
- [ ] 问卷统计数据更新接口
- [ ] 批量查询接口
- [ ] 手动触发同步功能
- [ ] 同步状态查询
- [ ] 错误日志记录

### 6.3 扩展功能
- [ ] IP白名单验证
- [ ] 回调请求重试机制
- [ ] WebSocket实时同步状态推送
- [ ] 数据修复工具

## 七、测试建议

### 7.1 数据库测试
```sql
-- 测试数据插入
INSERT INTO data_tools (id, name, type, external_survey_id, external_survey_url, satisfaction_config)
VALUES ('test-tool-001', '测试问卷', '问卷', 'survey-test-001', 'https://survey-test.f123.pub/survey/survey-test-001',
        '{"scale": 5, "minScore": 4.0, "calculationMethod": "threshold"}');

-- 查询问卷统计数据
SELECT * FROM survey_statistics WHERE tool_id = 'test-tool-001';
```

### 7.2 API测试
使用Postman或curl测试各个API接口：

```bash
# 创建问卷跳转链接
curl -X POST http://localhost:3000/api/tools/test-tool-001/create-survey \
  -H "Content-Type: application/json" \
  -d '{"action": "create"}'

# 生成学校访问链接
curl -X POST http://localhost:3000/api/tools/test-tool-001/generate-access-links \
  -H "Content-Type: application/json" \
  -d '{
    "projectId": "proj-001",
    "targetAudience": "parent"
  }'
```

## 八、故障排查

### 8.1 常见问题

**问题1**：回调接口返回401错误
- **原因**：JWT Token无效或已过期
- **解决**：检查Token是否正确传递，是否在有效期内

**问题2**：数据同步后指标未更新
- **原因**：未配置字段映射
- **解决**：在 field_mappings 表中配置问卷字段到要素的映射

**问题3**：满意度统计不正确
- **原因**：满意度配置错误
- **解决**：检查 data_tools.satisfaction_config 字段的配置

### 8.2 日志查看

后端日志位置：
```bash
# 查看API日志
tail -f logs/api.log

# 查看回调处理日志
grep "问卷回调" logs/api.log
```

## 九、参考文档

- [第三方问卷系统集成方案](./方案/第三方问卷系统集成方案.md)
- [数据库迁移脚本](../../backend/database/add-survey-integration.sql)
- [API路由实现](../../backend/routes/survey.js)
- [同步服务实现](../../backend/services/surveySync.js)
