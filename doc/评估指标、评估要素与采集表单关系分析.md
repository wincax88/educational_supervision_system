# 评估指标、评估要素与采集表单关系分析（以本项目实现为准）

本文档以当前仓库的**实际实现**为准（主要参考 `backend/routes/*.js`、`backend/src/types/index.ts`、`backend/database/schema.sql`、`frontend/src/services/*.ts`、`frontend/src/pages/*`），用于说明以下核心概念之间的关系与数据如何流动：

- **评估指标体系**（Indicator System / Indicator / Data Indicator）
- **评估要素库**（Element Library / Element，支持基础要素与派生要素）
- **采集表单/问卷**（Data Tool + schema 字段定义）
- **字段映射**（Field Mapping：表单字段 → 数据指标/要素）
- **指标采集值落库**（School Indicator Data：项目×学校×数据指标的采集值与达标结果）
- **资源配置 7 项指标与综合达标**（内置统计模型，独立于指标体系）

---

## 一、概念定义与边界（哪些走指标体系，哪些是内置统计）

| 概念 | 在系统中的含义 | 主要存储/来源 | 关键说明 |
|---|---|---|---|
| **评估项目 (Project)** | 一次评估活动的"容器"，组织指标体系与采集工具，驱动填报/评审/统计 | `projects` | 项目状态：`配置中 → 填报中 → 评审中 → 已完成/已中止` |
| **指标体系 (Indicator System)** | 评估标准集合（树结构） | `indicator_systems` + `indicators` | 三级结构通过 `indicators.parent_id` 维护 |
| **指标节点 (Indicator)** | 指标体系树上的节点（1/2/3级） | `indicators` | 末级节点 `is_leaf=1` 才能配置数据指标与佐证资料 |
| **数据指标 (Data Indicator)** | 末级指标下的"可采集/可判定"量化项，带阈值字符串 | `data_indicators` | 核心字段：`threshold`（字符串，如 `≥4.2` / `≤17:1` / `>=95%`） |
| **佐证资料 (Supporting Material)** | 对末级指标的附件要求配置 | `supporting_materials` | 提交时可产生上传记录（见 submissions 相关路由） |
| **要素库/要素 (Element)** | 可复用的数据定义：基础要素（直接采集）/派生要素（公式） | `element_libraries` + `elements` | 派生要素的 `formula` 会在指标同步时被解析计算 |
| **采集工具 (Data Tool)** | 表单或问卷（schema 定义字段结构） | `data_tools.schema` | schema 为 JSON 字符串，字段 id 用作映射主键 |
| **字段映射 (Field Mapping)** | 表单字段与"数据指标/要素"的绑定关系 | `field_mappings` | `mapping_type = 'data_indicator' | 'element'`，同一 `(tool_id, field_id)` 唯一 |
| **数据指标-要素关联** | 数据指标与要素之间的多对多关系，用于说明"指标依赖哪些要素"及公式计算入口 | `data_indicator_elements` | `mapping_type = 'primary' | 'reference'`；公式计算时只用 `primary` 的派生要素 |
| **指标采集值（落库）** | 某项目某学校某数据指标的采集值、达标结果 | `school_indicator_data` | 由 `submissions` 解析/计算后写入（见 `syncSubmissionIndicators`） |
| **资源配置 7 项指标** | 区县工作台用的固定 7 项资源指标（L1-L7） | `backend/routes/statistics.js` | **内置模型**：直接读取 submission 的约定字段计算，不依赖指标体系/字段映射 |

---

## 二、总体关系图（实现视角）

```
┌───────────────────────────────┐
│           项目 Project         │
│ projects.indicator_system_id   │
│ projects.status (配置中/...)   │
└───────────────┬───────────────┘
                │ 1:1
                ▼
┌───────────────────────────────┐
│       指标体系 IndicatorSystem │
│ indicator_systems             │
└───────────────┬───────────────┘
                │ 1:N
                ▼
┌───────────────────────────────┐
│   指标节点 Indicator(树)        │
│ indicators (parent_id 自引用)   │
└───────────────┬───────────────┘
                │ (末级 is_leaf=1)
         ┌──────┴────────┐
         ▼               ▼
┌────────────────┐  ┌─────────────────────┐
│ 数据指标        │  │ 佐证资料配置         │
│ data_indicators │  │ supporting_materials│
└───────┬────────┘  └─────────────────────┘
        │  N:M (说明/计算依赖)
        ▼
┌───────────────────────────────┐
│  数据指标-要素关联             │
│ data_indicator_elements        │
│ mapping_type: primary/reference│
└───────────────┬───────────────┘
                │ N:1
                ▼
┌───────────────────────────────┐
│     要素 Element（基础/派生）   │
│ elements (formula/aggregation) │
└───────────────────────────────┘

┌───────────────────────────────┐
│     采集工具 DataTool(表单/问卷)│
│ data_tools.schema (JSON)       │
└───────────────┬───────────────┘
                │ schema 字段(field_id)
                ▼
┌───────────────────────────────┐
│     字段映射 field_mappings     │
│ mapping_type: data_indicator    │
│              | element          │
└───────┬─────────────┬─────────┘
        │             │
        ▼             ▼
  data_indicators   elements

┌───────────────────────────────┐
│   填报记录 Submission           │
│ submissions(project_id,school_id,...)│
│ data(JSON) + status(draft/...)  │
└───────────────┬───────────────┘
                │ 同步/计算（后端）
                ▼
┌───────────────────────────────┐
│ 指标采集值 school_indicator_data│
│ value/text_value + is_compliant │
└───────────────────────────────┘
```

---

## 三、关键数据结构（数据库表定义）

### 3.1 指标体系与指标树

#### indicator_systems 表

```sql
CREATE TABLE indicator_systems (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,           -- 指标体系名称
  type TEXT NOT NULL,           -- 达标类 | 评分类
  target TEXT NOT NULL,         -- 评估对象
  tags TEXT,                    -- JSON数组：标签列表
  description TEXT,             -- 描述
  indicator_count INTEGER,      -- 指标总数
  attachments TEXT,             -- JSON数组：附件列表
  status TEXT DEFAULT 'draft',  -- draft | editing | published | archived
  created_by TEXT,
  created_at TEXT,
  updated_by TEXT,
  updated_at TEXT
);
```

#### indicators 表（树形结构）

```sql
CREATE TABLE indicators (
  id TEXT PRIMARY KEY,
  system_id TEXT NOT NULL,      -- 指标体系外键
  parent_id TEXT,               -- 自引用，实现树结构（最多3层）
  code TEXT NOT NULL,           -- 自动生成：1, 1.1, 1.1.1
  name TEXT NOT NULL,
  description TEXT,
  level INTEGER NOT NULL,       -- 1 | 2 | 3
  is_leaf INTEGER DEFAULT 0,    -- 是否为末级
  weight REAL,                  -- 权重百分比
  sort_order INTEGER DEFAULT 0, -- 排序
  created_at TEXT,
  updated_at TEXT
);
```

#### data_indicators 表

```sql
CREATE TABLE data_indicators (
  id TEXT PRIMARY KEY,
  indicator_id TEXT NOT NULL,   -- 关联末级指标
  code TEXT NOT NULL,           -- 自动生成：1-D1, 1.1-D1
  name TEXT NOT NULL,
  data_type TEXT,               -- 文本|数字|日期|时间|逻辑|数组|文件
  unit TEXT,                    -- 单位
  threshold TEXT,               -- 阈值标准（如 "≥95%"）
  description TEXT,
  calculation_method TEXT,      -- 计算方法说明
  data_source TEXT,
  collection_frequency TEXT,    -- 采集频率
  sort_order INTEGER DEFAULT 0,
  created_at TEXT,
  updated_at TEXT
);
```

#### supporting_materials 表

```sql
CREATE TABLE supporting_materials (
  id TEXT PRIMARY KEY,
  indicator_id TEXT NOT NULL,   -- 关联末级指标
  code TEXT NOT NULL,           -- 自动生成：1-M1, 1.1-M1
  name TEXT NOT NULL,
  file_types TEXT,              -- 允许的文件类型
  max_size TEXT,                -- 最大大小限制
  description TEXT,
  required INTEGER DEFAULT 0,
  sort_order INTEGER DEFAULT 0,
  created_at TEXT,
  updated_at TEXT
);
```

### 3.2 要素库与要素（基础/派生）

#### element_libraries 表

```sql
CREATE TABLE element_libraries (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  element_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'draft',  -- draft | published
  created_by TEXT,
  created_at TEXT,
  updated_by TEXT,
  updated_at TEXT
);
```

#### elements 表

```sql
CREATE TABLE elements (
  id TEXT PRIMARY KEY,
  library_id TEXT NOT NULL,
  code TEXT NOT NULL,           -- 如 E001, E002
  name TEXT NOT NULL,
  element_type TEXT NOT NULL,   -- 基础要素 | 派生要素
  data_type TEXT NOT NULL,      -- 文本|数字|日期|时间|逻辑|数组|文件
  tool_id TEXT,                 -- 基础要素可选关联采集工具
  field_id TEXT,                -- 基础要素可选关联表单字段
  field_label TEXT,             -- 字段展示路径
  formula TEXT,                 -- 派生要素的计算公式
  collection_level TEXT,        -- school | district | auto
  calculation_level TEXT,       -- school | district（派生要素）
  data_source TEXT,             -- 数据来源说明
  aggregation JSONB,            -- 多填报汇总配置
  sort_order INTEGER DEFAULT 0,
  created_at TEXT,
  updated_at TEXT
);
```

### 3.3 关联表

#### data_indicator_elements 表（数据指标-要素关联）

```sql
CREATE TABLE data_indicator_elements (
  id TEXT PRIMARY KEY,
  data_indicator_id TEXT NOT NULL,
  element_id TEXT NOT NULL,
  mapping_type TEXT DEFAULT 'primary',  -- primary | reference
  description TEXT,
  created_by TEXT,
  created_at TEXT,
  updated_at TEXT,
  UNIQUE (data_indicator_id, element_id)
);
```

#### supporting_material_elements 表（佐证资料-要素关联）

```sql
CREATE TABLE supporting_material_elements (
  id TEXT PRIMARY KEY,
  supporting_material_id TEXT NOT NULL,
  element_id TEXT NOT NULL,
  mapping_type TEXT DEFAULT 'primary',
  description TEXT,
  created_by TEXT,
  created_at TEXT,
  updated_at TEXT,
  UNIQUE (supporting_material_id, element_id)
);
```

### 3.4 采集工具与字段映射

#### data_tools 表

```sql
CREATE TABLE data_tools (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL,           -- 表单 | 问卷
  target TEXT,                  -- 评估对象（如"学校"、"区县"）
  description TEXT,
  schema TEXT,                  -- JSON：表单字段配置
  status TEXT DEFAULT 'draft',  -- draft | editing | published
  created_by TEXT,
  created_at TEXT,
  updated_by TEXT,
  updated_at TEXT
);
```

#### field_mappings 表

```sql
CREATE TABLE field_mappings (
  id TEXT PRIMARY KEY,
  tool_id TEXT NOT NULL,        -- 采集工具
  field_id TEXT NOT NULL,       -- 表单字段ID
  field_label TEXT,             -- 字段展示路径
  mapping_type TEXT NOT NULL,   -- data_indicator | element
  target_id TEXT NOT NULL,      -- 指标ID或要素ID
  created_at TEXT,
  updated_at TEXT,
  UNIQUE(tool_id, field_id)
);
```

### 3.5 指标采集值落库

#### school_indicator_data 表

```sql
CREATE TABLE school_indicator_data (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  school_id TEXT NOT NULL,
  data_indicator_id TEXT NOT NULL,
  value REAL,                   -- 数值
  text_value TEXT,              -- 文本值
  is_compliant INTEGER,         -- 1=达标，0=未达标，NULL=无法判断
  submission_id TEXT,           -- 溯源
  collected_at TEXT,
  created_at TEXT,
  updated_at TEXT,
  UNIQUE(project_id, school_id, data_indicator_id)
);
```

---

## 四、TypeScript 类型定义

### 4.1 后端类型定义 (`backend/src/types/index.ts`)

```typescript
// 指标体系
export interface IndicatorSystem extends BaseEntity {
  name: string;
  type: '达标类' | '评分类';
  target: string;
  tags?: string[];
  description?: string;
  indicator_count?: number;
  attachments?: Attachment[];
  status: 'draft' | 'editing' | 'published' | 'archived';
}

// 指标节点
export interface Indicator extends BaseEntity {
  system_id: string;
  parent_id?: string | null;
  code: string;
  name: string;
  description?: string;
  level: number;              // 1-3
  is_leaf: boolean;
  weight?: number;
  sort_order: number;
}

// 树节点类型（支持嵌套children）
export interface IndicatorTreeNode extends Indicator {
  children?: IndicatorTreeNode[];
  dataIndicators?: DataIndicator[];
  supportingMaterials?: SupportingMaterial[];
}

// 数据指标
export interface DataIndicator extends BaseEntity {
  indicator_id: string;
  code: string;
  name: string;
  data_type: '文本' | '数字' | '日期' | '时间' | '逻辑' | '数组' | '文件';
  unit?: string;
  threshold?: string;
  description?: string;
  calculation_method?: string;
  data_source?: string;
  collection_frequency?: string;
  sort_order: number;
}

// 佐证资料
export interface SupportingMaterial extends BaseEntity {
  indicator_id: string;
  code: string;
  name: string;
  file_types?: string;
  max_size?: string;
  description?: string;
  required: boolean;
  sort_order: number;
}
```

### 4.2 前端类型定义

#### 要素相关 (`frontend/src/services/toolService.ts`)

```typescript
export interface ElementLibrary {
  id: string;
  name: string;
  description: string;
  elementCount: number;
  status: 'published' | 'draft';
  createdBy: string;
  createdAt: string;
  updatedBy: string;
  updatedAt: string;
  elements?: Element[];
}

export interface Element {
  id: string;
  code: string;
  name: string;
  elementType: '基础要素' | '派生要素';
  dataType: '文本' | '数字' | '日期' | '时间' | '逻辑' | '数组' | '文件';
  formula?: string;
  toolId?: string;
  fieldId?: string;
  fieldLabel?: string;
  collectionLevel?: 'school' | 'district' | 'auto';
  calculationLevel?: 'school' | 'district';
  dataSource?: string;
  aggregation?: AggregationConfig;
}

// 聚合配置
export interface AggregationConfig {
  enabled: boolean;
  method: AggregationMethod;
  scope?: AggregationScope;
}

export type AggregationMethod =
  | 'sum' | 'avg' | 'count' | 'max' | 'min'
  | 'median' | 'stddev' | 'range' | 'cv';

export interface AggregationScope {
  level: 'all' | 'district' | 'school_type' | 'custom';
  filter?: {
    field: string;
    operator: 'eq' | 'ne' | 'gt' | 'lt' | 'gte' | 'lte' | 'in';
    value: any;
  };
}
```

#### 表单字段相关 (`frontend/src/pages/FormToolEdit/index.tsx`)

```typescript
type ControlType =
  | 'text' | 'textarea' | 'number' | 'select' | 'checkbox'
  | 'radio' | 'date' | 'time' | 'file' | 'upload' | 'switch'
  | 'divider' | 'group' | 'dynamicList';

interface FormField {
  id: string;
  type: ControlType;
  label: string;
  placeholder?: string;
  helpText?: string;
  width: '25%' | '33%' | '50%' | '75%' | '100%';
  required: boolean;
  options?: { label: string; value: string }[];
  children?: FormField[];              // 分组内子字段
  dynamicListFields?: DynamicListChildField[];  // 动态列表子字段
  mapping?: FieldMappingInfo | null;   // 字段映射
  showWhen?: ShowWhenCondition;        // 条件显示
  labelWhen?: LabelWhenRule[];         // 动态标题
}

interface FieldMappingInfo {
  mappingType: 'data_indicator' | 'element';
  targetId: string;
  targetInfo?: {
    code: string;
    name: string;
    threshold?: string;
    indicatorName?: string;
    elementType?: string;
    dataType?: string;
    formula?: string;
  };
}
```

#### 数据指标-要素关联 (`frontend/src/services/indicatorService.ts`)

```typescript
export interface ElementAssociation {
  id: string;
  dataIndicatorId: string;
  elementId: string;
  mappingType: 'primary' | 'reference';
  description: string;
  createdBy?: string;
  createdAt?: string;
  elementCode: string;
  elementName: string;
  elementType: '基础要素' | '派生要素';
  dataType: string;
  formula?: string;
  libraryId: string;
  libraryName: string;
}
```

---

## 五、API 接口列表

### 5.1 指标体系 API (`backend/routes/indicators.js`)

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/indicator-systems` | 获取指标体系列表 |
| GET | `/indicator-systems/:id` | 获取指标体系详情 |
| POST | `/indicator-systems` | 创建指标体系 |
| PUT | `/indicator-systems/:id` | 更新指标体系 |
| DELETE | `/indicator-systems/:id` | 删除指标体系（级联删除） |

### 5.2 指标树操作 API

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/indicator-systems/:id/tree` | 获取指标树结构（含数据指标和佐证资料） |
| PUT | `/indicator-systems/:id/tree` | 保存整个指标树（全量覆盖） |
| POST | `/indicator-systems/:systemId/indicators` | 添加指标节点 |
| PUT | `/indicator-systems/:systemId/indicators/:indicatorId` | 更新指标节点 |
| DELETE | `/indicator-systems/:systemId/indicators/:indicatorId` | 删除指标节点（级联删除子树） |

### 5.3 数据指标-要素关联 API

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/data-indicators/:dataIndicatorId/elements` | 获取数据指标的要素关联 |
| POST | `/data-indicators/:dataIndicatorId/elements` | 添加数据指标-要素关联 |
| PUT | `/data-indicator-elements/:id` | 更新关联 |
| DELETE | `/data-indicator-elements/:id` | 删除关联 |

### 5.4 采集工具 API (`backend/routes/tools.js`)

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/tools` | 获取工具列表 |
| GET | `/tools/:id` | 获取工具详情 |
| POST | `/tools` | 创建工具 |
| PUT | `/tools/:id` | 更新工具 |
| PUT | `/tools/:id/schema` | 保存表单 schema |
| GET | `/tools/:id/schema` | 获取表单 schema |
| GET | `/tools/:id/full-schema` | 获取完整 schema（含字段映射） |
| POST | `/tools/:id/publish` | 发布工具 |
| POST | `/tools/:id/unpublish` | 取消发布 |
| DELETE | `/tools/:id` | 删除工具（级联删除映射） |

### 5.5 要素库 API

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/element-libraries` | 获取要素库列表 |
| GET | `/element-libraries/:id` | 获取要素库详情（含要素） |
| POST | `/element-libraries` | 创建要素库 |
| PUT | `/element-libraries/:id` | 更新要素库（支持全量覆盖要素） |
| DELETE | `/element-libraries/:id` | 删除要素库（级联检查引用） |
| POST | `/element-libraries/:id/elements` | 添加要素 |
| POST | `/element-libraries/:id/elements/import` | 批量导入要素 |
| PUT | `/elements/:id` | 更新要素 |
| DELETE | `/elements/:id` | 删除要素 |

### 5.6 字段映射 API

| 方法 | 端点 | 功能 |
|------|------|------|
| GET | `/tools/:id/field-mappings` | 获取字段映射 |
| PUT | `/tools/:id/field-mappings` | 更新字段映射 |
| POST | `/tools/:id/field-mappings` | 添加字段映射 |
| DELETE | `/tools/:toolId/field-mappings/:fieldId` | 删除字段映射 |

---

## 六、从表单到"数据指标值"的两条实现路径（核心）

后端在同步指标时（`syncSubmissionIndicators`）支持两条路径：

### 6.1 直接映射：字段 → 数据指标

1. `field_mappings` 中配置：`mapping_type='data_indicator'`
2. 从 submission 的 `data(JSON)` 中按 `field_id` 取值
   - 支持 **扁平 key**（例如 key 本身包含点号）以及 **a.b.c 路径**读取
   - 若路径中遇到数组，会对数组中对应字段的数值**求和**
3. 写入 `school_indicator_data` 并根据 `data_indicators.threshold` 进行达标判定

### 6.2 要素映射 + 派生公式：字段 → 要素 → 公式 → 数据指标

1. `field_mappings` 中配置：`mapping_type='element'`（字段采集到基础要素）
2. 提取 element 值时仅保留**可解析为数值**的字段（文本/布尔等会被忽略为不可计算）
3. 查找当前项目指标体系下，存在 `data_indicator_elements(mapping_type='primary')` 且关联要素 `elements.formula` 非空的数据指标
4. 公式计算：
   - 公式变量形如 `E001` / `D001`（正则：`[ED]\\d{3}`），会被替换为对应 elementCode 的数值
   - 仅允许数字、四则运算与括号，安全校验后执行
5. 若某数据指标已有"直接映射"的值，则**公式结果不会覆盖**
6. 写入 `school_indicator_data` 并做阈值达标判定

---

## 七、前端页面实现

### 7.1 指标库管理页面

**文件**：`frontend/src/pages/IndicatorLibrary/index.tsx`

**功能**：
- 显示指标体系列表（统计：总数、已发布、编辑中、达标类、评分类）
- 支持搜索和状态筛选
- 创建/编辑/删除指标体系
- 导入指标树结构（JSON格式）

### 7.2 指标树编辑器

**文件**：`frontend/src/pages/IndicatorTreeEdit/index.tsx`

**功能**：
- 可视化编辑指标树（支持最多3级）
- 自动编码生成和重新计算
- 为末级指标添加数据指标和佐证资料
- 支持导入JSON标准化处理

**编码规则**：
```
一级指标：1, 2, 3
二级指标：1.1, 1.2, 2.1
三级指标：1.1.1, 1.1.2, 2.1.1
数据指标：1.1-D1, 1.1-D2
佐证资料：1.1-M1, 1.1-M2
```

### 7.3 采集工具编辑器

**文件**：`frontend/src/pages/FormToolEdit/index.tsx`

**支持的控件类型**：

| 类型 | 说明 |
|------|------|
| `text` | 文本输入 |
| `textarea` | 长文本 |
| `number` | 数字输入 |
| `select` | 下拉选择 |
| `checkbox` | 复选框 |
| `radio` | 单选框 |
| `date` | 日期选择 |
| `time` | 时间选择 |
| `file`/`upload` | 文件上传 |
| `switch` | 开关 |
| `divider` | 分割线 |
| `group` | 分组容器（支持嵌套） |
| `dynamicList` | 动态列表 |

### 7.4 要素库管理页面

**文件**：`frontend/src/pages/ElementLibrary/index.tsx`

**功能**：
- 管理要素库列表
- 查看库内要素详情
- 创建/编辑/删除要素库和要素

### 7.5 指标树查看器组件

**文件**：`frontend/src/components/IndicatorTreeViewer/index.tsx`

**功能**：
- 只读树形展示指标体系
- 展示数据指标和佐证资料的分组
- 颜色标签区分等级（蓝色1级、绿色2级、橙色3级）

---

## 八、高级特性

### 8.1 条件显示与动态标题

```typescript
// 表单字段支持条件显示
interface ShowWhenCondition {
  field: string;
  value?: string | string[];
  condition?: 'filled' | 'empty' | 'equals';
}

// 动态标题根据表单值改变
interface LabelWhenRule {
  field: string;
  value?: string | string[];
  condition?: 'filled' | 'empty' | 'equals';
  label: string;  // 条件满足时显示的标题
}
```

### 8.2 动态列表与聚合

动态列表支持多行数据录入，子字段支持的类型：`text`, `number`, `select`, `date`, `time`

多填报汇总支持的聚合方式：

| 方法 | 说明 |
|------|------|
| `sum` | 求和 |
| `avg` | 平均值 |
| `count` | 计数 |
| `max` | 最大值 |
| `min` | 最小值 |
| `median` | 中位数 |
| `stddev` | 标准差 |
| `range` | 极差 (max - min) |
| `cv` | 差异系数 (标准差 / 平均值) |

### 8.3 采集级别与计算级别

- **collection_level**：采集来源级别（`school` | `district` | `auto`）
- **calculation_level**：计算级别，用于派生要素（`school` | `district`）
- **data_source**：数据来源说明（如"区县汇总"、"学校填报"）

---

## 九、数据完整性保证

### 9.1 引用完整性验证（程序层实现）

所有外键通过程序验证，主要检查点：

```javascript
// 示例：添加数据指标-要素关联时
router.post('/data-indicators/:dataIndicatorId/elements', async (req, res) => {
  // 1) 验证数据指标存在
  // 2) 验证要素存在
  // 3) 检查唯一性约束（防重复）
  // 4) 插入关联
});
```

### 9.2 删除前引用检查

- 删除要素前检查是否被数据指标引用
- 删除指标体系时级联删除所有子数据
- 删除采集工具时级联删除字段映射

### 9.3 级联删除策略

**删除指标体系**：
```
指标体系 → 删除所有指标
            ├→ 删除数据指标关联（data_indicator_elements）
            ├→ 删除阈值标准（threshold_standards）
            ├→ 删除数据指标本身
            └→ 删除佐证资料
```

**删除采集工具**：
```
采集工具 → 删除字段映射（field_mappings）
            ├→ 删除项目-工具关联（project_tools）
            └→ 删除工具本身
```

**删除要素库**：
```
要素库 → 检查要素是否被数据指标引用
          ├→ 如果被引用则拒绝删除
          ├→ 删除字段映射
          ├→ 删除合规规则引用
          └→ 删除要素和库本身
```

---

## 十、资源配置 7 项指标与综合达标（区县工作台，内置模型）

### 10.1 重要说明：这是"内置统计"，不走指标体系/字段映射

资源配置 7 项指标（L1-L7）与综合达标规则由 `backend/routes/statistics.js` **硬编码配置与计算**，其数据来源是：

- `schools`（用于兜底展示的 student_count 等）
- `submissions`（按区县、项目、学校取一条"有效 submission"解析 `data` 后计算）

因此它与"指标体系/数据指标/要素/映射"是**并行的两条线**：
指标体系线用于通用评估与 `school_indicator_data`；资源指标线用于区县工作台的特定模型。

### 10.2 submission 选取与缺失值策略

对每所学校：

- **只选 `approved/submitted/rejected`**，不纳入 `draft`
- **优先 `approved`**，若无则回退到**最新**的 `submitted/rejected`
- 若完全没有有效 submission：L1-L7 的 `value/isCompliant` 返回 **null**

### 10.3 指标计算要点（实现口径）

- 学生数：
  - 小学：`primary_student_count` 优先，否则 `student_count`
  - 初中：`junior_student_count` 优先，否则 `student_count`
- L1（高学历教师）：
  - 小学：专科及以上学历教师数 / 学生数 × 100
  - 初中：本科及以上学历教师数 / 学生数 × 100
- L2（骨干教师）：县级骨干教师数 / 学生数 × 100
- L3（体艺教师）：体育+音乐+美术教师数 / 学生数 × 100
- L4（教学及辅助用房）：教学及辅助用房面积 / 学生数
- L5（体育运动场馆）：体育运动场馆面积 / 学生数
- L6（仪器设备值）：设备值（万元）× 10000 / 学生数
- L7（多媒体教室）：多媒体教室数 / 学生数 × 100

### 10.4 综合达标规则

- **至少 6 项达标**
- 其余未达标项必须 **不低于标准的 85%**

返回字段：
- `overallComplianceMessage`：如 `综合达标：6/7项达标`
- `overallComplianceDetails`：逐条解释未达标项是否低于 85% 下限

### 10.5 接口

```
GET /api/districts/:districtId/resource-indicators-summary?projectId=...&schoolType=小学|初中
```

---

## 十一、差异系数（CV）相关实现口径

系统中存在两类 CV 计算输出：

1. **项目 CV 分析接口**（面向项目维度）
   - `GET /api/projects/:projectId/cv-analysis?districtId=...&schoolType=小学|初中`
   - 返回：以生师比为主（并可能扩展到 `school_indicator_data` 中的更多指标）
2. **资源配置 7 项指标汇总中的 CV**（面向区县工作台）
   - 与 L1-L7 数值序列相关；当样本数 < 2 时 `cv=null`

---

## 十二、关键代码位置汇总

| 主题 | 后端文件 | 前端文件 |
|---|---|---|
| 数据库表结构 | `backend/database/schema.sql` | - |
| 类型定义 | `backend/src/types/index.ts` | `frontend/src/services/indicatorService.ts`<br>`frontend/src/services/toolService.ts` |
| 指标体系/指标树/数据指标 | `backend/routes/indicators.js` | `frontend/src/pages/IndicatorLibrary/index.tsx`<br>`frontend/src/pages/IndicatorTreeEdit/index.tsx` |
| 要素库/要素/字段映射 | `backend/routes/tools.js` | `frontend/src/pages/ElementLibrary/index.tsx`<br>`frontend/src/pages/FormToolEdit/index.tsx` |
| 指标树组件 | - | `frontend/src/components/IndicatorTreeViewer/index.tsx` |
| 提交解析与指标同步落库 | `backend/routes/submissions.js` | - |
| 资源配置 7 项与综合达标 | `backend/routes/statistics.js` | `frontend/src/services/statisticsService.ts` |
| API 服务封装 | - | `frontend/src/services/indicatorService.ts`<br>`frontend/src/services/toolService.ts` |

---

## 十三、数据流转示例

### 案例：学生-师资比达标评估

```
1. 定义指标体系
   └─ 均衡发展
      └─ 师资队伍（二级）
         └─ 生师比 (三级，末级)
            ├─ 数据指标
            │  ├─ 小学生师比 (阈值: ≤19:1)
            │  └─ 初中生师比 (阈值: ≤13:1)
            └─ 佐证资料
               └─ 教师花名册

2. 设计采集工具（表单）
   └─ 学校基础信息采集表
      ├─ 学生总数 [number] → 映射：要素-学生人数
      ├─ 教师总数 [number] → 映射：要素-教师人数
      └─ 教师花名册 [file] → 映射：佐证资料

3. 创建要素库
   └─ 教育资源基础要素库
      ├─ E001 学生人数 (基础要素)
      ├─ E002 教师人数 (基础要素)
      └─ E003 生师比 (派生要素, 公式: E001 / E002)

4. 建立关联关系
   └─ 生师比 (数据指标)
      └─ 关联要素
         ├─ E001 学生人数 (primary)
         ├─ E002 教师人数 (primary)
         └─ E003 生师比 (reference)

5. 数据流转
   学校填报 → 学生总数、教师总数
      ↓
   触发采集 → 采集 E001、E002
      ↓
   自动计算 → 派生要素 E003 = E001 / E002
      ↓
   达标判定 → 生师比是否达标
      ↓
   汇总统计 → 区县内学校达标率、差异系数
```
