# 项目-指标-要素-工具关系与数据流

本文档描述教育督导评估系统中「项目」「指标」「要素」「工具」四个核心概念之间的关系和数据流动。

---

## 一、核心概念

| 概念 | 说明 | 数据库表 |
|------|------|----------|
| **项目 (Project)** | 评估项目，整合指标体系和采集工具，驱动整个评估流程 | `projects` |
| **指标体系 (Indicator System)** | 评估标准的集合，采用三级树形结构 | `indicator_systems` + `indicators` |
| **数据指标 (Data Indicator)** | 末级指标下的具体量化数据项，含阈值 | `data_indicators` |
| **要素 (Element)** | 可复用的数据定义（基础要素/派生要素） | `element_libraries` + `elements` |
| **工具 (Data Tool)** | 数据采集表单或问卷 | `data_tools` |
| **字段映射 (Field Mapping)** | 工具字段与数据指标/要素的关联 | `field_mappings` |

---

## 二、实体关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              评估项目 (Project)                              │
│                                                                             │
│  id, name, status, indicator_system_id, start_date, end_date               │
│  状态: 配置中 → 填报中 → 评审中 → 已完成 (或 已中止)                          │
└─────────────────────────────────────────────────────────────────────────────┘
         │                                    │
         │ 1:1 关联                           │ 1:N 关联 (project_tools)
         ▼                                    ▼
┌─────────────────────────┐         ┌─────────────────────────┐
│   指标体系               │         │   采集工具 (DataTool)   │
│   (IndicatorSystem)     │         │                         │
│                         │         │  id, name, type, schema │
│  三级树形结构:           │         │  type: 表单 | 问卷       │
│  ├─ 一级指标            │         └─────────────────────────┘
│  │  └─ 二级指标         │                    │
│  │     └─ 三级指标      │                    │ schema 定义
│  │        ├─ 数据指标   │◄─────────────────┐ │ 表单字段
│  │        └─ 佐证资料   │  field_mappings  │ ▼
│  └──────────────────────┘                  ┌─────────────────────────┐
                                             │   表单字段 (FormField)  │
                                             │                         │
                                             │  存储在 schema JSON 中   │
                                             │  每个字段可配置映射关系   │
                                             └─────────────────────────┘
                                                        │
                                                        │ field_mappings
                                                        │ mapping_type
                                                        ▼
                                             ┌─────────────────────────┐
                                             │   要素库 (ElementLib)   │
                                             │                         │
                                             │  ├─ 基础要素 (直接采集)  │
                                             │  └─ 派生要素 (公式计算)  │
                                             └─────────────────────────┘
```

---

## 三、详细关系说明

### 3.1 项目 ↔ 指标体系 (1:1)

```sql
-- projects.indicator_system_id → indicator_systems.id
projects (
  indicator_system_id TEXT  -- 关联的指标体系
)
```

- 每个项目必须关联一个指标体系
- 指标体系定义"评什么"及"达标标准"
- 项目配置阶段可更换指标体系

### 3.2 项目 ↔ 工具 (N:M)

```sql
-- 通过 project_tools 中间表关联
project_tools (
  project_id TEXT NOT NULL,    -- 项目ID
  tool_id TEXT NOT NULL,       -- 工具ID
  sort_order INTEGER,          -- 显示顺序
  is_required INTEGER          -- 是否必填
)
```

- 一个项目可关联多个采集工具
- 一个工具可被多个项目复用
- 通过 `is_required` 控制工具是否必填

### 3.3 指标体系 → 数据指标 (1:N)

```
指标体系
└── 一级指标 (indicators, level=1)
    └── 二级指标 (indicators, level=2)
        └── 三级指标 (indicators, level=3, is_leaf=1)
            ├── 数据指标 (data_indicators)  ← 量化数据项
            └── 佐证资料 (supporting_materials) ← 文件上传配置
```

- 只有末级指标（`is_leaf=1`）才能配置数据指标
- 数据指标定义具体采集项及阈值（如"生师比 ≤ 17:1"）

### 3.4 工具字段 ↔ 数据指标/要素 (字段映射)

```sql
field_mappings (
  tool_id TEXT NOT NULL,           -- 工具ID
  field_id TEXT NOT NULL,          -- 表单字段ID (schema中的fieldId)
  mapping_type TEXT NOT NULL,      -- 映射类型: data_indicator | element
  target_id TEXT NOT NULL          -- 目标ID (数据指标ID 或 要素ID)
)
```

**映射类型说明:**

| mapping_type | 含义 | 用途 |
|-------------|------|------|
| `data_indicator` | 映射到数据指标 | 采集数据直接支撑指标评估 |
| `element` | 映射到要素 | 复用要素定义，支持派生计算 |

### 3.5 要素库

```sql
elements (
  element_type TEXT,   -- 基础要素 | 派生要素
  data_type TEXT,      -- 文本 | 数字 | 日期 | 时间 | 逻辑 | 数组 | 文件
  formula TEXT         -- 派生要素的计算公式
)
```

- **基础要素**: 直接采集的原始数据（如"学生数"）
- **派生要素**: 通过公式计算（如"生师比 = 学生数 / 教师数"）

---

## 四、数据流

### 4.1 配置阶段数据流

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  创建指标体系 │ →  │ 构建指标树   │ →  │ 配置数据指标 │
│             │    │ (三级结构)  │    │ 及佐证资料   │
└─────────────┘    └─────────────┘    └─────────────┘
                                            │
        ┌───────────────────────────────────┘
        ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  创建要素库  │ →  │  定义要素    │ →  │  表单设计    │
│             │    │ (基础/派生) │    │  引用要素    │
└─────────────┘    └─────────────┘    └─────────────┘
                                            │
                                            ▼
                   ┌─────────────────────────────────┐
                   │           创建项目               │
                   │  1. 关联指标体系                 │
                   │  2. 添加采集工具                 │
                   │  3. 配置字段映射 (在工具编辑中)   │
                   └─────────────────────────────────┘
```

### 4.2 填报阶段数据流

```
┌──────────────────────────────────────────────────────────────┐
│                      项目启动填报                             │
│                    status: 填报中                            │
└──────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   │  工具A填报   │     │  工具B填报   │     │  工具C填报   │
   │  (学校表单)  │     │  (教师表单)  │     │  (满意度问卷)│
   └─────────────┘     └─────────────┘     └─────────────┘
          │                   │                   │
          ▼                   ▼                   ▼
   ┌─────────────────────────────────────────────────────────┐
   │                    submissions 表                        │
   │   id, project_id, form_id, data(JSON), status           │
   │   附件 → submission_materials                           │
   └─────────────────────────────────────────────────────────┘
          │
          │ 通过 field_mappings 关联
          ▼
   ┌─────────────────────────────────────────────────────────┐
   │                    数据指标匹配                          │
   │   字段值 → 数据指标 → 阈值比对 → 指标评估结果             │
   └─────────────────────────────────────────────────────────┘
```

### 4.3 评估阶段数据流

```
填报数据 (submissions)
        │
        │ 关联映射
        ▼
┌─────────────────────────────────────────────────────────────┐
│   数据指标映射汇总 (通过 API 计算)                            │
│                                                             │
│   - 已映射: 有表单字段关联的数据指标                          │
│   - 未映射: 无表单字段关联的数据指标 (需补充)                  │
│                                                             │
│   映射完成度 = 已映射数 / 总数据指标数                        │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│   指标达标判定                                               │
│                                                             │
│   采集值 vs 阈值 → 达标/未达标                               │
│   如: 生师比 15.2 vs 阈值 ≤17:1 → 达标                       │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│   评估报告生成                                               │
│                                                             │
│   各级指标达标率 → 综合评分 → 评估结论                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、关键数据库关系汇总

```
indicator_systems (1) ──┬──< indicators (N)
                       │      └──< data_indicators (N)
                       │      └──< supporting_materials (N)
                       │
projects (1) ──────────┴── indicator_system_id
     │
     └──< project_tools >──< data_tools (N)
                                  │
                                  └──< field_mappings (N)
                                           │
                                           ├── data_indicators (via target_id)
                                           └── elements (via target_id)

submissions (N) ──┬── project_id → projects
                 ├── form_id → data_tools
                 └──< submission_materials (N)

element_libraries (1) ──< elements (N)
```

---

## 六、项目状态流转

```
                 ┌────────────┐
                 │   配置中    │  ← 初始状态
                 └─────┬──────┘
                       │ 启动填报
                       ▼
                 ┌────────────┐
           ┌────►│   填报中    │
           │     └─────┬──────┘
           │           │ 结束填报
           │           ▼
           │     ┌────────────┐
           │     │   评审中    │
           │     └─────┬──────┘
           │           │ 完成项目
           │           ▼
           │     ┌────────────┐
           │     │   已完成    │  ← 终态
           │     └────────────┘
           │
           │     ┌────────────┐
           └─────┤   已中止    │  ← 可从任意状态中止
   重新启动      └────────────┘    可重新启动回到配置中
```

---

## 七、典型操作场景

### 场景1: 创建评估项目

1. 管理员在「指标库」创建指标体系，构建三级指标树
2. 为末级指标配置数据指标（含阈值）和佐证资料要求
3. 在「工具库」创建采集表单，设计表单字段
4. 为表单字段配置「评价依据」（映射到数据指标）
5. 创建项目，关联指标体系
6. 添加采集工具到项目
7. 检查指标映射完成度
8. 启动填报

### 场景2: 数据填报

1. 填报人进入项目填报页面
2. 选择一个采集工具（表单）
3. 填写表单数据，上传佐证资料
4. 提交填报记录
5. 系统自动将数据与数据指标关联

### 场景3: 评估分析

1. 管理员结束填报，进入评审阶段
2. 系统汇总各数据指标的采集值
3. 与阈值比对，计算达标情况
4. 生成各级指标的达标率
5. 输出评估报告

---

## 八、前端页面与数据关系

| 页面 | 主要数据 | 操作 |
|------|---------|------|
| 指标库 (IndicatorLibrary) | indicator_systems, indicators | 创建/编辑指标体系和指标树 |
| 指标编辑 (IndicatorTreeEdit) | indicators, data_indicators, supporting_materials | 配置末级指标的数据指标和佐证资料 |
| 要素库 (ElementLibrary) | element_libraries, elements | 管理可复用的数据要素 |
| 工具库 (ToolLibrary) | data_tools | 管理采集表单/问卷 |
| 工具编辑 (FormToolEdit) | data_tools.schema, field_mappings | 设计表单字段，配置字段映射 |
| 项目列表 (ProjectList) | projects | 项目CRUD |
| 项目配置 (ProjectConfig) | projects, project_tools, field_mappings | 关联工具，查看映射状态 |
| 数据填报 (DataEntry) | submissions, submission_materials | 填写表单，上传资料 |

---

## 九、API 数据流示例

### 获取项目指标映射汇总

```
GET /api/projects/:projectId/indicator-mapping-summary

响应:
{
  "stats": {
    "total": 31,       // 总数据指标数
    "mapped": 25,      // 已映射数
    "unmapped": 6      // 未映射数
  },
  "dataIndicators": [
    {
      "id": "di-001",
      "code": "1.1.1",
      "name": "每百名学生拥有高于规定学历教师数",
      "threshold": "≥4.2人",
      "isMapped": true,
      "mapping": {
        "toolId": "tool-001",
        "toolName": "学校基本信息采集表",
        "fieldId": "field-teacher-ratio",
        "fieldLabel": "高学历教师比例"
      }
    }
  ]
}
```

这个汇总帮助管理员了解：
- 哪些数据指标已有采集工具覆盖
- 哪些数据指标还需要补充采集方式
- 整体数据采集的完整性

---

## 十、总结

四者的核心职责：

| 概念 | 回答的问题 |
|------|-----------|
| **指标体系** | 评什么？标准是什么？ |
| **要素库** | 有哪些可复用的数据定义？ |
| **采集工具** | 怎么采集数据？ |
| **项目** | 谁来组织？什么时候做？ |

它们通过「项目」整合在一起，形成完整的评估闭环：

```
指标定义(what) → 工具设计(how) → 数据采集(do) → 评估分析(check)
```
