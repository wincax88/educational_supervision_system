# 增强方案：支持义务教育优质均衡督导评估

本文档设计系统增强方案，以完全支持《沈阳市义务教育优质均衡督导评估指标体系》的创建、填报和统计分析。

---

## 一、现状分析

### 1.1 已具备的能力

| 功能 | 支持情况 | 说明 |
|------|---------|------|
| 多级指标体系 | ✅ 完全支持 | 1-3级树形结构 |
| 指标权重配置 | ✅ 完全支持 | weight 字段 |
| 阈值标准 | ✅ 完全支持 | data_indicators.threshold |
| 采集工具设计 | ✅ 完全支持 | 动态表单 schema |
| 字段映射 | ✅ 完全支持 | field_mappings 表 |
| 数据填报 | ✅ 完全支持 | submissions 表 |
| 审核流程 | ✅ 完全支持 | 状态流转 |

### 1.2 缺失的能力

| 功能 | 缺失原因 | 影响 |
|------|---------|------|
| 学校数据维度 | 无 schools 表 | 无法按校统计 |
| 区县数据维度 | 无 districts 表 | 无法按区县汇总 |
| 综合差异系数 | 无计算逻辑 | 无法衡量校际均衡 |
| 达标率统计 | 无汇总模块 | 无法生成评估报告 |
| 历史对比 | 无年度维度 | 无法监测趋势 |

---

## 二、数据模型增强

### 2.1 新增数据库表

#### 2.1.1 区县表 (districts)

```sql
CREATE TABLE districts (
  id TEXT PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,        -- 区县代码 (如 210106)
  name TEXT NOT NULL,               -- 区县名称 (如 铁西区)
  type TEXT DEFAULT '市辖区',        -- 类型: 市辖区 | 县 | 县级市
  parent_code TEXT,                 -- 上级代码 (市级)
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 初始数据示例
INSERT INTO districts (id, code, name, type) VALUES
  ('d-001', '210102', '和平区', '市辖区'),
  ('d-002', '210103', '沈河区', '市辖区'),
  ('d-003', '210104', '大东区', '市辖区'),
  ('d-004', '210105', '皇姑区', '市辖区'),
  ('d-005', '210106', '铁西区', '市辖区'),
  ('d-006', '210111', '苏家屯区', '市辖区'),
  ('d-007', '210112', '浑南区', '市辖区'),
  ('d-008', '210113', '沈北新区', '市辖区'),
  ('d-009', '210114', '于洪区', '市辖区'),
  ('d-010', '210115', '辽中区', '市辖区'),
  ('d-011', '210123', '康平县', '县'),
  ('d-012', '210124', '法库县', '县'),
  ('d-013', '210181', '新民市', '县级市');
```

#### 2.1.2 学校表 (schools)

```sql
CREATE TABLE schools (
  id TEXT PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,         -- 学校代码
  name TEXT NOT NULL,                -- 学校名称
  district_id TEXT NOT NULL,         -- 所属区县
  school_type TEXT NOT NULL,         -- 类型: 小学 | 初中 | 九年一贯制 | 完全中学
  school_category TEXT DEFAULT '公办', -- 办学性质: 公办 | 民办
  urban_rural TEXT DEFAULT '城区',    -- 城乡类型: 城区 | 镇区 | 乡村
  address TEXT,                       -- 地址
  principal TEXT,                     -- 校长姓名
  contact_phone TEXT,                 -- 联系电话
  student_count INTEGER DEFAULT 0,    -- 学生数 (最新)
  teacher_count INTEGER DEFAULT 0,    -- 教师数 (最新)
  status TEXT DEFAULT 'active',       -- 状态: active | inactive
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (district_id) REFERENCES districts(id)
);

-- 索引
CREATE INDEX idx_schools_district ON schools(district_id);
CREATE INDEX idx_schools_type ON schools(school_type);
CREATE INDEX idx_schools_urban_rural ON schools(urban_rural);
```

#### 2.1.3 评估年度表 (evaluation_years)

```sql
CREATE TABLE evaluation_years (
  id TEXT PRIMARY KEY,
  year INTEGER NOT NULL UNIQUE,       -- 年度 (如 2024, 2025)
  name TEXT NOT NULL,                 -- 名称 (如 "2024-2025学年")
  start_date DATE,                    -- 开始日期
  end_date DATE,                      -- 结束日期
  status TEXT DEFAULT 'active',       -- 状态: active | archived
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.1.4 学校指标数据表 (school_indicator_data)

```sql
-- 存储每所学校在每个评估项目中的指标数据
CREATE TABLE school_indicator_data (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,           -- 评估项目ID
  school_id TEXT NOT NULL,            -- 学校ID
  data_indicator_id TEXT NOT NULL,    -- 数据指标ID
  value REAL,                         -- 采集值 (数值型)
  text_value TEXT,                    -- 采集值 (文本型)
  is_compliant INTEGER,               -- 是否达标: 1=达标, 0=未达标, NULL=未评估
  submission_id TEXT,                 -- 来源填报记录ID
  collected_at DATETIME,              -- 采集时间
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id),
  FOREIGN KEY (school_id) REFERENCES schools(id),
  FOREIGN KEY (data_indicator_id) REFERENCES data_indicators(id),
  UNIQUE (project_id, school_id, data_indicator_id)
);

-- 索引
CREATE INDEX idx_school_indicator_project ON school_indicator_data(project_id);
CREATE INDEX idx_school_indicator_school ON school_indicator_data(school_id);
CREATE INDEX idx_school_indicator_indicator ON school_indicator_data(data_indicator_id);
```

#### 2.1.5 区县统计快照表 (district_statistics)

```sql
-- 存储区县级别的统计快照（定期计算后存储）
CREATE TABLE district_statistics (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,           -- 评估项目ID
  district_id TEXT NOT NULL,          -- 区县ID
  school_type TEXT NOT NULL,          -- 学校类型: 小学 | 初中

  -- 学校统计
  school_count INTEGER DEFAULT 0,     -- 学校数量
  compliant_school_count INTEGER DEFAULT 0, -- 达标学校数

  -- 差异系数 (8项核心指标)
  cv_teacher_ratio REAL,              -- 生师比差异系数
  cv_teacher_qualification REAL,      -- 高学历教师差异系数
  cv_building_area REAL,              -- 生均校舍面积差异系数
  cv_sports_area REAL,                -- 生均体育场地差异系数
  cv_equipment_value REAL,            -- 生均教学设备值差异系数
  cv_computer_count REAL,             -- 百名学生计算机数差异系数
  cv_book_count REAL,                 -- 生均图书册数差异系数
  cv_class_size REAL,                 -- 平均班额差异系数

  cv_composite REAL,                  -- 综合差异系数
  is_cv_compliant INTEGER,            -- 差异系数是否达标

  -- 各维度达标率
  resource_compliance_rate REAL,      -- 资源配置达标率
  government_compliance_rate REAL,    -- 政府保障达标率
  quality_compliance_rate REAL,       -- 教育质量达标率
  satisfaction_rate REAL,             -- 社会满意度

  overall_score REAL,                 -- 综合得分
  calculated_at DATETIME,             -- 计算时间
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (project_id) REFERENCES projects(id),
  FOREIGN KEY (district_id) REFERENCES districts(id),
  UNIQUE (project_id, district_id, school_type)
);
```

### 2.2 修改现有表

#### 2.2.1 projects 表增加字段

```sql
ALTER TABLE projects ADD COLUMN evaluation_year_id TEXT REFERENCES evaluation_years(id);
ALTER TABLE projects ADD COLUMN evaluation_scope TEXT DEFAULT 'district'; -- district | city
```

#### 2.2.2 submissions 表增加字段

```sql
-- 填报记录关联到具体学校
ALTER TABLE submissions ADD COLUMN school_id TEXT REFERENCES schools(id);
```

---

## 三、核心计算逻辑

### 3.1 综合差异系数计算

差异系数 (CV) 计算公式：

```
CV = 标准差 / 平均值

其中：
- 标准差 = sqrt(Σ(xi - μ)² / n)
- 平均值 μ = Σxi / n
```

#### 3.1.1 后端实现 (Node.js)

```javascript
// backend/services/statisticsService.js

/**
 * 计算差异系数 (Coefficient of Variation)
 * @param {number[]} values - 数值数组
 * @returns {number} 差异系数
 */
function calculateCV(values) {
  if (!values || values.length === 0) return null;

  const n = values.length;
  const mean = values.reduce((sum, v) => sum + v, 0) / n;

  if (mean === 0) return null;

  const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / n;
  const stdDev = Math.sqrt(variance);

  return stdDev / mean;
}

/**
 * 计算区县的综合差异系数
 * @param {string} projectId - 项目ID
 * @param {string} districtId - 区县ID
 * @param {string} schoolType - 学校类型 (小学/初中)
 * @returns {Object} 各项差异系数
 */
async function calculateDistrictCV(projectId, districtId, schoolType) {
  // 8项核心指标的数据指标code映射
  const cvIndicatorCodes = {
    teacher_ratio: 'R001',           // 生师比
    teacher_qualification: 'R002',   // 高学历教师比例
    building_area: 'R003',           // 生均校舍面积
    sports_area: 'R004',             // 生均体育场地
    equipment_value: 'R005',         // 生均教学设备值
    computer_count: 'R006',          // 百名学生计算机数
    book_count: 'R007',              // 生均图书册数
    class_size: 'R008'               // 平均班额
  };

  const result = {};

  for (const [key, code] of Object.entries(cvIndicatorCodes)) {
    // 获取该区县所有学校的该指标值
    const values = await getSchoolIndicatorValues(
      projectId, districtId, schoolType, code
    );
    result[`cv_${key}`] = calculateCV(values);
  }

  // 计算综合差异系数 (8项的加权平均或简单平均)
  const cvValues = Object.values(result).filter(v => v !== null);
  result.cv_composite = cvValues.length > 0
    ? cvValues.reduce((sum, v) => sum + v, 0) / cvValues.length
    : null;

  // 判断是否达标
  const threshold = schoolType === '小学' ? 0.50 : 0.45;
  result.is_cv_compliant = result.cv_composite !== null && result.cv_composite <= threshold;

  return result;
}
```

### 3.2 达标率计算

```javascript
/**
 * 计算指标达标率
 * @param {string} projectId - 项目ID
 * @param {string} schoolId - 学校ID (可选，不传则计算区县)
 * @param {string} districtId - 区县ID (可选)
 * @param {string} category - 指标类别 (资源配置/政府保障/教育质量/社会认可度)
 */
async function calculateComplianceRate(projectId, { schoolId, districtId, category }) {
  let query = `
    SELECT
      COUNT(*) as total,
      SUM(CASE WHEN is_compliant = 1 THEN 1 ELSE 0 END) as compliant
    FROM school_indicator_data sid
    JOIN data_indicators di ON sid.data_indicator_id = di.id
    JOIN indicators ind ON di.indicator_id = ind.id
    WHERE sid.project_id = ?
  `;

  const params = [projectId];

  if (schoolId) {
    query += ' AND sid.school_id = ?';
    params.push(schoolId);
  }

  if (districtId) {
    query += ` AND sid.school_id IN (
      SELECT id FROM schools WHERE district_id = ?
    )`;
    params.push(districtId);
  }

  if (category) {
    // 根据一级指标名称筛选
    query += ` AND ind.id IN (
      SELECT id FROM indicators
      WHERE system_id = (SELECT indicator_system_id FROM projects WHERE id = ?)
      AND level = 1 AND name LIKE ?
    )`;
    params.push(projectId, `%${category}%`);
  }

  const result = db.prepare(query).get(...params);

  return {
    total: result.total,
    compliant: result.compliant,
    rate: result.total > 0 ? (result.compliant / result.total * 100).toFixed(2) : 0
  };
}
```

---

## 四、API 设计

### 4.1 区县管理 API

```
GET    /api/districts                    # 获取区县列表
GET    /api/districts/:id                # 获取区县详情
POST   /api/districts                    # 创建区县
PUT    /api/districts/:id                # 更新区县
DELETE /api/districts/:id                # 删除区县
GET    /api/districts/:id/schools        # 获取区县下的学校列表
GET    /api/districts/:id/statistics     # 获取区县统计数据
```

### 4.2 学校管理 API

```
GET    /api/schools                      # 获取学校列表 (支持筛选)
GET    /api/schools/:id                  # 获取学校详情
POST   /api/schools                      # 创建学校
PUT    /api/schools/:id                  # 更新学校信息
DELETE /api/schools/:id                  # 删除学校
POST   /api/schools/import               # 批量导入学校

GET    /api/schools/:id/indicator-data   # 获取学校的指标数据
GET    /api/schools/:id/compliance       # 获取学校达标情况
```

### 4.3 统计分析 API

```
# 差异系数计算
GET /api/projects/:projectId/cv-analysis
    ?district_id=xxx                     # 可选，指定区县
    &school_type=小学|初中               # 可选，指定学校类型

# 响应示例
{
  "districtId": "d-010",
  "districtName": "辽中区",
  "schoolType": "小学",
  "schoolCount": 45,
  "cvIndicators": {
    "teacher_ratio": { "cv": 0.32, "mean": 15.2, "stdDev": 4.86 },
    "teacher_qualification": { "cv": 0.28, "mean": 4.8, "stdDev": 1.34 },
    ...
  },
  "cvComposite": 0.38,
  "threshold": 0.50,
  "isCompliant": true
}

# 达标率统计
GET /api/projects/:projectId/compliance-summary
    ?district_id=xxx
    &school_type=小学|初中
    &group_by=district|school|indicator

# 区县对比分析
GET /api/projects/:projectId/district-comparison
    ?school_type=小学|初中

# 城乡对比分析
GET /api/projects/:projectId/urban-rural-comparison
    ?district_id=xxx

# 趋势分析 (跨年度)
GET /api/statistics/trend
    ?district_id=xxx
    &indicator_code=R001
    &years=2023,2024,2025
```

### 4.4 报告生成 API

```
# 生成区县评估报告
POST /api/projects/:projectId/reports/district
{
  "districtId": "d-010",
  "schoolType": "小学",
  "format": "pdf|excel|html"
}

# 生成学校评估报告
POST /api/projects/:projectId/reports/school
{
  "schoolId": "s-001",
  "format": "pdf|excel|html"
}

# 生成汇总报告
POST /api/projects/:projectId/reports/summary
{
  "scope": "city|district",
  "format": "pdf|excel|html"
}
```

---

## 五、前端增强

### 5.1 新增页面

| 页面 | 路由 | 功能 |
|------|------|------|
| 区县管理 | `/home/system/districts` | 区县CRUD |
| 学校管理 | `/home/system/schools` | 学校CRUD、批量导入 |
| 学校填报 | `/home/balanced/entry/:projectId/school/:schoolId` | 按学校填报 |
| 差异系数分析 | `/home/balanced/project/:projectId/cv-analysis` | 校际均衡分析 |
| 达标率统计 | `/home/balanced/project/:projectId/compliance` | 达标情况汇总 |
| 区县对比 | `/home/balanced/project/:projectId/district-comparison` | 区县横向对比 |
| 评估报告 | `/home/balanced/project/:projectId/report` | 报告生成与导出 |

### 5.2 页面设计

#### 5.2.1 差异系数分析页面

```
┌─────────────────────────────────────────────────────────────────┐
│  差异系数分析 - 辽中区 小学                                       │
├─────────────────────────────────────────────────────────────────┤
│  筛选: [区县选择 ▼] [学校类型 ▼]  [计算]                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  综合差异系数                               │
│  │                 │  ┌──────────────────────────────┐          │
│  │   🎯 0.38       │  │ ████████░░░░░░░░░░░░░░░░░░░░│ 0.38     │
│  │   达标 ✓        │  │                    阈值: 0.50│          │
│  │                 │  └──────────────────────────────┘          │
│  └─────────────────┘                                            │
│                                                                 │
│  8项核心指标差异系数:                                             │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 指标                 │ 差异系数 │ 均值   │ 标准差 │ 状态    ││
│  ├─────────────────────────────────────────────────────────────┤│
│  │ 生师比               │  0.32   │ 15.2  │  4.86  │ ✓ 达标  ││
│  │ 高学历教师比例        │  0.28   │  4.8  │  1.34  │ ✓ 达标  ││
│  │ 生均校舍面积          │  0.45   │  8.5  │  3.83  │ ✓ 达标  ││
│  │ 生均体育场地          │  0.52   │  1.8  │  0.94  │ ✗ 未达标││
│  │ ...                                                        ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  学校数据分布 (生师比):                                           │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │          *                                                  ││
│  │        * * *     均值线                                      ││
│  │      *  *  *  *   ───                                       ││
│  │    *   *   *   *                                            ││
│  │  ──────────────────────────────────────────                 ││
│  │  学校1 学校2 学校3 学校4 ...                                  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

#### 5.2.2 达标率统计页面

```
┌─────────────────────────────────────────────────────────────────┐
│  达标率统计 - 2025年义务教育优质均衡评估                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │ 资源配置  │ │ 政府保障  │ │ 教育质量  │ │ 社会认可  │           │
│  │   92%    │ │   88%    │ │   95%    │ │   97%    │           │
│  │  23/25   │ │  7/8     │ │  19/20   │ │  3/3     │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│                                                                 │
│  区县达标情况:                                                    │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 区县     │ 小学达标率 │ 初中达标率 │ 综合差异系数 │ 状态     ││
│  ├─────────────────────────────────────────────────────────────┤│
│  │ 和平区   │   96%     │   94%     │    0.35     │ ✓ 达标   ││
│  │ 沈河区   │   94%     │   92%     │    0.38     │ ✓ 达标   ││
│  │ 辽中区   │   88%     │   85%     │    0.48     │ ✓ 达标   ││
│  │ 法库县   │   82%     │   78%     │    0.52     │ ⚠ 待改进 ││
│  │ ...                                                        ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  [导出报告]  [查看详情]                                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、数据流增强

### 6.1 完整数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              配置阶段                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │ 区县数据导入 │ →  │ 学校数据导入 │ →  │ 指标体系创建 │ →  │ 采集工具设计 │  │
│  │ (districts) │    │ (schools)   │    │ (31项指标)  │    │ (表单映射)   │  │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
│                                                                             │
│  创建项目 → 关联指标体系 → 关联采集工具 → 分配填报学校                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              填报阶段                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│       学校A                学校B                学校C                        │
│         │                   │                   │                          │
│         ▼                   ▼                   ▼                          │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│  │ 学校信息表   │     │ 学校信息表   │     │ 学校信息表   │                   │
│  │ 教师信息表   │     │ 教师信息表   │     │ 教师信息表   │                   │
│  │ 满意度问卷   │     │ 满意度问卷   │     │ 满意度问卷   │                   │
│  └─────────────┘     └─────────────┘     └─────────────┘                   │
│         │                   │                   │                          │
│         └───────────────────┼───────────────────┘                          │
│                             ▼                                               │
│                    ┌─────────────────┐                                      │
│                    │   submissions   │                                      │
│                    │   (带school_id) │                                      │
│                    └─────────────────┘                                      │
│                             │                                               │
│                             ▼ 数据提取                                       │
│                    ┌───────────────────────┐                                │
│                    │ school_indicator_data │                                │
│                    │ (学校-指标-值)         │                                │
│                    └───────────────────────┘                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              统计分析阶段                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      差异系数计算                                    │   │
│  │                                                                     │   │
│  │   按区县+学校类型分组                                                │   │
│  │       │                                                             │   │
│  │       ▼                                                             │   │
│  │   ┌────────────────────────────────────────────────────────┐       │   │
│  │   │ 辽中区-小学: 45所学校                                   │       │   │
│  │   │                                                        │       │   │
│  │   │ 指标: 生师比                                            │       │   │
│  │   │ 数据: [15.2, 16.1, 14.8, 17.0, 15.5, ...]             │       │   │
│  │   │                                                        │       │   │
│  │   │ CV = 标准差/均值 = 1.2/15.5 = 0.077                    │       │   │
│  │   └────────────────────────────────────────────────────────┘       │   │
│  │                                                                     │   │
│  │   8项指标 → 综合差异系数 → 对比阈值(0.50/0.45) → 达标判定           │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      达标率计算                                      │   │
│  │                                                                     │   │
│  │   各校指标值 vs 阈值 → 达标/未达标                                   │   │
│  │       │                                                             │   │
│  │       ▼                                                             │   │
│  │   汇总: 资源配置达标率、政府保障达标率、教育质量达标率、满意度        │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      统计快照存储                                    │   │
│  │                                                                     │   │
│  │   计算结果 → district_statistics 表                                 │   │
│  │   支持历史查询和趋势分析                                             │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              报告输出                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                   │
│  │  学校评估报告  │  │  区县评估报告  │  │  市级汇总报告  │                   │
│  │               │  │               │  │               │                   │
│  │ • 各项指标值   │  │ • 差异系数    │  │ • 达标区县数   │                   │
│  │ • 达标情况    │  │ • 达标率      │  │ • 整体达标率   │                   │
│  │ • 改进建议    │  │ • 学校排名    │  │ • 区县对比    │                   │
│  └───────────────┘  └───────────────┘  └───────────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、实施计划

### 7.1 开发任务分解

#### 第一阶段：基础数据层 (优先级: 高)

| 任务 | 描述 | 预估工作量 |
|------|------|-----------|
| T1.1 | 创建 districts, schools 表及 API | 中 |
| T1.2 | 创建区县/学校管理前端页面 | 中 |
| T1.3 | 实现学校批量导入功能 (Excel) | 中 |
| T1.4 | 修改 submissions 表，增加 school_id | 小 |
| T1.5 | 修改填报流程，支持按学校填报 | 中 |

#### 第二阶段：数据采集增强 (优先级: 高)

| 任务 | 描述 | 预估工作量 |
|------|------|-----------|
| T2.1 | 创建 school_indicator_data 表 | 小 |
| T2.2 | 实现填报数据到指标数据的自动提取 | 大 |
| T2.3 | 实现阈值达标自动判定 | 中 |
| T2.4 | 完善字段映射，支持指标关联 | 中 |

#### 第三阶段：统计分析 (优先级: 中)

| 任务 | 描述 | 预估工作量 |
|------|------|-----------|
| T3.1 | 实现差异系数计算服务 | 中 |
| T3.2 | 实现达标率统计服务 | 中 |
| T3.3 | 创建 district_statistics 表及定时计算 | 中 |
| T3.4 | 开发差异系数分析页面 | 大 |
| T3.5 | 开发达标率统计页面 | 大 |
| T3.6 | 开发区县对比页面 | 中 |

#### 第四阶段：报告生成 (优先级: 低)

| 任务 | 描述 | 预估工作量 |
|------|------|-----------|
| T4.1 | 设计报告模板 | 中 |
| T4.2 | 实现 PDF/Excel 报告生成 | 大 |
| T4.3 | 开发报告预览和下载页面 | 中 |

### 7.2 数据库迁移脚本

```sql
-- migration_001_add_districts_schools.sql

-- 1. 创建区县表
CREATE TABLE IF NOT EXISTS districts (
  id TEXT PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  type TEXT DEFAULT '市辖区',
  parent_code TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2. 创建学校表
CREATE TABLE IF NOT EXISTS schools (
  id TEXT PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,
  name TEXT NOT NULL,
  district_id TEXT NOT NULL,
  school_type TEXT NOT NULL,
  school_category TEXT DEFAULT '公办',
  urban_rural TEXT DEFAULT '城区',
  address TEXT,
  principal TEXT,
  contact_phone TEXT,
  student_count INTEGER DEFAULT 0,
  teacher_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'active',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (district_id) REFERENCES districts(id)
);

-- 3. 创建学校指标数据表
CREATE TABLE IF NOT EXISTS school_indicator_data (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  school_id TEXT NOT NULL,
  data_indicator_id TEXT NOT NULL,
  value REAL,
  text_value TEXT,
  is_compliant INTEGER,
  submission_id TEXT,
  collected_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id),
  FOREIGN KEY (school_id) REFERENCES schools(id),
  FOREIGN KEY (data_indicator_id) REFERENCES data_indicators(id),
  UNIQUE (project_id, school_id, data_indicator_id)
);

-- 4. 创建区县统计表
CREATE TABLE IF NOT EXISTS district_statistics (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  district_id TEXT NOT NULL,
  school_type TEXT NOT NULL,
  school_count INTEGER DEFAULT 0,
  compliant_school_count INTEGER DEFAULT 0,
  cv_teacher_ratio REAL,
  cv_teacher_qualification REAL,
  cv_building_area REAL,
  cv_sports_area REAL,
  cv_equipment_value REAL,
  cv_computer_count REAL,
  cv_book_count REAL,
  cv_class_size REAL,
  cv_composite REAL,
  is_cv_compliant INTEGER,
  resource_compliance_rate REAL,
  government_compliance_rate REAL,
  quality_compliance_rate REAL,
  satisfaction_rate REAL,
  overall_score REAL,
  calculated_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES projects(id),
  FOREIGN KEY (district_id) REFERENCES districts(id),
  UNIQUE (project_id, district_id, school_type)
);

-- 5. 修改 submissions 表
ALTER TABLE submissions ADD COLUMN school_id TEXT REFERENCES schools(id);

-- 6. 创建索引
CREATE INDEX IF NOT EXISTS idx_schools_district ON schools(district_id);
CREATE INDEX IF NOT EXISTS idx_schools_type ON schools(school_type);
CREATE INDEX IF NOT EXISTS idx_school_indicator_project ON school_indicator_data(project_id);
CREATE INDEX IF NOT EXISTS idx_school_indicator_school ON school_indicator_data(school_id);
CREATE INDEX IF NOT EXISTS idx_submissions_school ON submissions(school_id);
```

---

## 八、总结

### 8.1 增强后的系统能力

| 能力 | 增强前 | 增强后 |
|------|--------|--------|
| 数据维度 | 项目级 | 学校→区县→市级 |
| 差异系数 | 不支持 | 自动计算8项+综合 |
| 达标判定 | 手动 | 自动对比阈值 |
| 统计汇总 | 基础 | 多维度、多层级 |
| 趋势分析 | 不支持 | 跨年度对比 |
| 报告生成 | 不支持 | PDF/Excel导出 |

### 8.2 完全支持的指标体系功能

增强后，系统将完全支持：

1. **资源配置 (40分)** - 7项指标的采集、阈值判定、差异系数计算
2. **政府保障 (20分)** - 6项指标的采集和达标率统计
3. **教育质量 (30分)** - 9项指标的采集和综合评估
4. **社会认可度 (10分)** - 3项指标的问卷采集和满意度统计
5. **综合差异系数** - 小学≤0.50、初中≤0.45 的自动计算和判定
6. **区县达标率** - 80%区县达国家标准的监测

---

## 附录：沈阳市13个区县代码

| 代码 | 名称 | 类型 |
|------|------|------|
| 210102 | 和平区 | 市辖区 |
| 210103 | 沈河区 | 市辖区 |
| 210104 | 大东区 | 市辖区 |
| 210105 | 皇姑区 | 市辖区 |
| 210106 | 铁西区 | 市辖区 |
| 210111 | 苏家屯区 | 市辖区 |
| 210112 | 浑南区 | 市辖区 |
| 210113 | 沈北新区 | 市辖区 |
| 210114 | 于洪区 | 市辖区 |
| 210115 | 辽中区 | 市辖区 |
| 210123 | 康平县 | 县 |
| 210124 | 法库县 | 县 |
| 210181 | 新民市 | 县级市 |
